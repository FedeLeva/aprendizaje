<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>API REST 2022 | Guias</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Descripcion">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/aprendizaje/assets/css/0.styles.5e6ce45c.css" as="style"><link rel="preload" href="/aprendizaje/assets/js/app.9a194da8.js" as="script"><link rel="preload" href="/aprendizaje/assets/js/2.c431ec36.js" as="script"><link rel="preload" href="/aprendizaje/assets/js/45.3ad9c563.js" as="script"><link rel="prefetch" href="/aprendizaje/assets/js/10.e744f38e.js"><link rel="prefetch" href="/aprendizaje/assets/js/11.1da570f8.js"><link rel="prefetch" href="/aprendizaje/assets/js/12.94178c81.js"><link rel="prefetch" href="/aprendizaje/assets/js/13.6cc948da.js"><link rel="prefetch" href="/aprendizaje/assets/js/14.ac7318bb.js"><link rel="prefetch" href="/aprendizaje/assets/js/15.65795f28.js"><link rel="prefetch" href="/aprendizaje/assets/js/16.e127c599.js"><link rel="prefetch" href="/aprendizaje/assets/js/17.38e9d24d.js"><link rel="prefetch" href="/aprendizaje/assets/js/18.917bc518.js"><link rel="prefetch" href="/aprendizaje/assets/js/19.ed890b31.js"><link rel="prefetch" href="/aprendizaje/assets/js/20.a278704f.js"><link rel="prefetch" href="/aprendizaje/assets/js/21.3dee1d1e.js"><link rel="prefetch" href="/aprendizaje/assets/js/22.5e4685fa.js"><link rel="prefetch" href="/aprendizaje/assets/js/23.36d87931.js"><link rel="prefetch" href="/aprendizaje/assets/js/24.e1eea224.js"><link rel="prefetch" href="/aprendizaje/assets/js/25.26964830.js"><link rel="prefetch" href="/aprendizaje/assets/js/26.6511ac3a.js"><link rel="prefetch" href="/aprendizaje/assets/js/27.5bf3d181.js"><link rel="prefetch" href="/aprendizaje/assets/js/28.0b9347e3.js"><link rel="prefetch" href="/aprendizaje/assets/js/29.e30379aa.js"><link rel="prefetch" href="/aprendizaje/assets/js/3.4615dbf3.js"><link rel="prefetch" href="/aprendizaje/assets/js/30.162ed83d.js"><link rel="prefetch" href="/aprendizaje/assets/js/31.9552498d.js"><link rel="prefetch" href="/aprendizaje/assets/js/32.c17fa5da.js"><link rel="prefetch" href="/aprendizaje/assets/js/33.9add958a.js"><link rel="prefetch" href="/aprendizaje/assets/js/34.961d4adc.js"><link rel="prefetch" href="/aprendizaje/assets/js/35.183d4b13.js"><link rel="prefetch" href="/aprendizaje/assets/js/36.b2c46711.js"><link rel="prefetch" href="/aprendizaje/assets/js/37.4486e40c.js"><link rel="prefetch" href="/aprendizaje/assets/js/38.d5c9d1ca.js"><link rel="prefetch" href="/aprendizaje/assets/js/39.2b76f93e.js"><link rel="prefetch" href="/aprendizaje/assets/js/4.7b66cd35.js"><link rel="prefetch" href="/aprendizaje/assets/js/40.13e06b26.js"><link rel="prefetch" href="/aprendizaje/assets/js/41.d1f1644f.js"><link rel="prefetch" href="/aprendizaje/assets/js/42.c441fa36.js"><link rel="prefetch" href="/aprendizaje/assets/js/43.9cdf13c3.js"><link rel="prefetch" href="/aprendizaje/assets/js/44.995cf01e.js"><link rel="prefetch" href="/aprendizaje/assets/js/46.95ca3d6b.js"><link rel="prefetch" href="/aprendizaje/assets/js/47.801d7715.js"><link rel="prefetch" href="/aprendizaje/assets/js/48.fb9df337.js"><link rel="prefetch" href="/aprendizaje/assets/js/49.2ddaedfa.js"><link rel="prefetch" href="/aprendizaje/assets/js/5.a396fb32.js"><link rel="prefetch" href="/aprendizaje/assets/js/50.425afa5e.js"><link rel="prefetch" href="/aprendizaje/assets/js/51.cb98c0b0.js"><link rel="prefetch" href="/aprendizaje/assets/js/52.6031d4b6.js"><link rel="prefetch" href="/aprendizaje/assets/js/53.20ccf08a.js"><link rel="prefetch" href="/aprendizaje/assets/js/54.5863fe63.js"><link rel="prefetch" href="/aprendizaje/assets/js/55.1d68b619.js"><link rel="prefetch" href="/aprendizaje/assets/js/56.a04ef3a6.js"><link rel="prefetch" href="/aprendizaje/assets/js/57.1355675d.js"><link rel="prefetch" href="/aprendizaje/assets/js/58.38ed085f.js"><link rel="prefetch" href="/aprendizaje/assets/js/59.8a8a2036.js"><link rel="prefetch" href="/aprendizaje/assets/js/6.27888615.js"><link rel="prefetch" href="/aprendizaje/assets/js/60.8c9608ce.js"><link rel="prefetch" href="/aprendizaje/assets/js/61.1ab10c02.js"><link rel="prefetch" href="/aprendizaje/assets/js/62.6b368ae7.js"><link rel="prefetch" href="/aprendizaje/assets/js/7.06129e92.js"><link rel="prefetch" href="/aprendizaje/assets/js/8.9737c9fc.js"><link rel="prefetch" href="/aprendizaje/assets/js/9.7e901376.js">
    <link rel="stylesheet" href="/aprendizaje/assets/css/0.styles.5e6ce45c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/aprendizaje/" class="home-link router-link-active"><!----> <span class="site-name">Guias</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/aprendizaje/" class="nav-link">
  Inicio
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/aprendizaje/" class="nav-link">
  Inicio
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/aprendizaje/Node/" aria-current="page" class="sidebar-link">Lo Basico de Node</a></li><li><a href="/aprendizaje/Node/motor.html" class="sidebar-link">Motores de plantillas/vistas</a></li><li><a href="/aprendizaje/Node/router.html" class="sidebar-link">Router</a></li><li><a href="/aprendizaje/Node/mongo.html" class="sidebar-link">MongoDB</a></li><li><a href="/aprendizaje/Node/token.html" class="sidebar-link">Token y Practica API REST</a></li><li><a href="/aprendizaje/Node/Guia.html" class="sidebar-link">Guia practica - 2022</a></li><li><a href="/aprendizaje/Node/apiRest.html" aria-current="page" class="active sidebar-link">API REST 2022</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#primeros-pasos" class="sidebar-link">Primeros pasos</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#mongoose" class="sidebar-link">Mongoose</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#schema-models" class="sidebar-link">Schema &amp; Models</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#routes-controllers" class="sidebar-link">Routes/Controllers</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#formas-de-enviar-datos" class="sidebar-link">Formas de enviar datos</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#validaciones-express-validator" class="sidebar-link">Validaciones (Express-Validator)</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#middleware-personalizado-para-validar" class="sidebar-link">Middleware Personalizado para validar</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#cifrar-contrasena-schema-pre-save" class="sidebar-link">Cifrar contraseña / Schema.pre / Save</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#validaciones-findone" class="sidebar-link">Validaciones // findOne()</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#login-anadirle-metodos-al-esquema" class="sidebar-link">Login/Añadirle métodos al esquema</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#jwt" class="sidebar-link">JWT</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#generar-token-en-el-login-register" class="sidebar-link">Generar Token en el Login/Register</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#refresh-token" class="sidebar-link">Refresh Token</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#jwt-v2" class="sidebar-link">JWT V2</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#ruta-protegida" class="sidebar-link">Ruta protegida</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#ruta-protegida-2-anadir-una-propiedad-al-objeto-req-findbyid" class="sidebar-link">Ruta protegida  #2  / Añadir una propiedad al objeto req / findById()</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#findbyid" class="sidebar-link">findById()</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#validaciones-del-token" class="sidebar-link">Validaciones del token</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#modificamos-la-informacion-que-nos-devuelve-la-ruta-protegida-y-usamos-el-lean" class="sidebar-link">Modificamos la información que nos devuelve la ruta protegida y usamos el Lean</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#simple-html" class="sidebar-link">Simple HTML</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#solicitudes-con-fetch" class="sidebar-link">Solicitudes con fetch</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#formas-de-guardar-el-token" class="sidebar-link">Formas de guardar el token</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#refresh-token-3" class="sidebar-link">Refresh Token</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#logout" class="sidebar-link">Logout</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#refactorizacion" class="sidebar-link">Refactorizacion</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#links-url-referencia-al-usuario" class="sidebar-link">Links (URL)  / Referencia al usuario</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#leer-find" class="sidebar-link">Leer / Find()</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#crear" class="sidebar-link">Crear</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/apiRest.html#validar-url-longlink" class="sidebar-link">Validar URL (longLink)</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="api-rest-2022"><a href="#api-rest-2022" class="header-anchor">#</a> API REST 2022</h1> <ul><li>Separaremos lo que es backend del frontend, por ende este mismo proyecto de back nos servirá tanto para Vue o React.</li></ul> <h3 id="normas-a-seguir"><a href="#normas-a-seguir" class="header-anchor">#</a> Normas a seguir</h3> <ul><li>No se puede guardar la sesion del usuario en el servidor</li> <li>La respuesta debe ser en JSON</li></ul> <h2 id="primeros-pasos"><a href="#primeros-pasos" class="header-anchor">#</a> Primeros pasos</h2> <h3 id="_1-instalamos-los-modulos"><a href="#_1-instalamos-los-modulos" class="header-anchor">#</a> 1. Instalamos los modulos</h3> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm init <span class="token operator">-</span>y
npm i bcryptjs cookie<span class="token operator">-</span>parser cors dotenv express express<span class="token operator">-</span>validator jsonwebtoken mongoose
npm i <span class="token operator">-</span>D nodemon

</code></pre></div><h4 id="explicacion-de-los-modulos"><a href="#explicacion-de-los-modulos" class="header-anchor">#</a> Explicacion de los modulos:</h4> <ol><li>nodemon : Para crear un servidor de desarollo</li> <li>express: Para levantar un servidor</li> <li>express-validator : Para validar las solicitudes del cliente</li> <li>mongoose: Para hacer consultas a la BD</li> <li>jsonwebtoken: Para generar tokens de seguridad y gestionarlo.</li> <li>dontenv : Para trabajar con variables de entornos</li> <li>cors: Para configurar la comunicación del frontend y backend</li> <li>cookie-parser: Para gestionar las cookies.</li> <li>bycripts : Para cifrar la contraseña</li></ol> <h3 id="configuramos-el-package-json"><a href="#configuramos-el-package-json" class="header-anchor">#</a> Configuramos el package.json</h3> <ul><li>Configuramos el package.json para trabajar con los modulos (import y export)</li> <li>Tambien le añadimos los script dev y start</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;backend&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;module&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon index.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;start&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;node index.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

</code></pre></div><h3 id="archivo-gitignore"><a href="#archivo-gitignore" class="header-anchor">#</a> Archivo .gitignore</h3> <div class="language-js extra-class"><pre class="language-js"><code>node_modules
<span class="token punctuation">.</span>env

</code></pre></div><h3 id="carpetas-a-crear"><a href="#carpetas-a-crear" class="header-anchor">#</a> Carpetas a crear</h3> <ul><li>controllers : Contiene la logica de las rutas</li> <li>routes  : Contiene las rutas</li> <li>models : modelos/esquemas de la BD</li> <li>middlewares : Para interceptar rutas.</li> <li>helper/utils : Para reutilizar código</li> <li>database : Contiene la conexión a la BD</li></ul> <h3 id="probemos"><a href="#probemos" class="header-anchor">#</a> Probemos</h3> <p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Gestionamos una peticion get a la raiz</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req <span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ok <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">5000</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'http://localhost:5000'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>npm run dev
</code></pre></div><h2 id="mongoose"><a href="#mongoose" class="header-anchor">#</a> Mongoose</h2> <ul><li><a href="https://www.mongodb.com/" target="_blank" rel="noopener noreferrer">mongodb<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://mongoosejs.com/" target="_blank" rel="noopener noreferrer">mongoose<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="en-mongodb"><a href="#en-mongodb" class="header-anchor">#</a> En mongoDB</h3> <ol><li>Iniciamos sesion  (si sos  nuevo , tenes que crear un cluster)</li> <li>Creas un usuario</li></ol> <h3 id="en-el-proyecto"><a href="#en-el-proyecto" class="header-anchor">#</a> En el proyecto</h3> <ol><li>Pones la URI en una variable del .env</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">URI_MONGO</span><span class="token operator">=</span><span class="token constant">XXX</span>
</code></pre></div><ol start="2"><li>Establecemos la conexion
database/connectDB.js</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> mongoose <span class="token keyword">from</span> <span class="token string">&quot;mongoose&quot;</span><span class="token punctuation">;</span>

<span class="token comment">//connect(uri)</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">URI_MONGO</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Conexion a la BD completa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Error de conexion a mongoDB  '</span> <span class="token operator">+</span> error<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token comment">// Habilitamos las variables de entorno</span>
<span class="token keyword">import</span> <span class="token string">'dotenv/config'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'./database/connectDB.js'</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Gestionamos una peticion get a la raiz</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req <span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ok <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// Si no existe, asigna el puerto 500</span>
<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">5000</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'http://localhost:'</span><span class="token operator">+</span><span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Al importar un archivo , puede pasar que sin la extensión .js no lo lea.</p></div> <h2 id="schema-models"><a href="#schema-models" class="header-anchor">#</a> Schema &amp; Models</h2> <ul><li><a href="https://mongoosejs.com/docs/guide.html#definition" target="_blank" rel="noopener noreferrer">Esquema<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Con Mongoose, todo se deriva de un esquema.</li> <li>Cada esquema se asigna a una colección MongoDB y define la forma de los documentos dentro de esa colección.</li> <li>Para usar nuestra definición de esquema, necesitamos convertirla a un modelo con el que podamos trabajar.</li></ul> <div class="custom-block tip"><p class="custom-block-title">Modelo</p> <ul><li>Modelo: Contiene los métodos para leer, crear, modificar, eliminar datos de la colección.</li> <li><a href="https://mongoosejs.com/docs/queries.html" target="_blank" rel="noopener noreferrer">Ver metodos del modelo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <div class="custom-block tip"><p class="custom-block-title">Esquema</p> <ul><li>Esquema: Estructura de los documentos de la colección</li> <li>Si no se respeta la estructura(esquema) a la hora de crear un documento, se genera un error.</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">indice</p> <ul><li><a href="https://desarrolloweb.com/articulos/intro-indices-mysql.html#:~:text=Los%20%C3%ADndices%20en%20MySQL%20permiten,tabla%20en%20un%20momento%20dado" target="_blank" rel="noopener noreferrer">link<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.adictosaltrabajo.com/2015/09/11/introduccion-a-indices-en-mysql/" target="_blank" rel="noopener noreferrer">link2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <p>models/User.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> mongoose <span class="token keyword">from</span> <span class="token string">'mongoose'</span>

<span class="token comment">// Creamos el esquema (Lo instanciamos)</span>
<span class="token comment">// new Schema({los campos que va a tener el documento})</span>

<span class="token keyword">const</span> userSchema <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// Cada campo contiene un objeto especificando el tipo de dato(type) , si es obligatorio(required) , etc</span>
    email<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span>String <span class="token punctuation">,</span>
            required<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
            trim<span class="token operator">:</span><span class="token boolean">true</span> <span class="token comment">/* Limpia los caracteres en blanco */</span> <span class="token punctuation">,</span>
            unique<span class="token operator">:</span><span class="token boolean">true</span> <span class="token comment">/* Valor unico */</span> <span class="token punctuation">,</span>
            lowercase<span class="token operator">:</span><span class="token boolean">true</span> <span class="token comment">/* Los convierte en minuscula */</span><span class="token punctuation">,</span> 
            index<span class="token operator">:</span><span class="token punctuation">{</span>unique<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span> <span class="token comment">/* Indexar */</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token punctuation">,</span> 
    password <span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span>String <span class="token punctuation">,</span>
        required<span class="token operator">:</span><span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Creamos el modelo y lo exportamos</span>
 <span class="token comment">// model('nombreModelo' , esquema )</span>
 <span class="token comment">// el nombreModelo = nombre de la coleccion que va a contener esa estructura(esquema)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> User <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span> <span class="token punctuation">,</span> userSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="routes-controllers"><a href="#routes-controllers" class="header-anchor">#</a> Routes/Controllers</h2> <p>Routes/auth.route.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ok<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/register&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ok<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">;</span>

</code></pre></div><p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token comment">// Habilitamos las variables de entorno</span>
<span class="token keyword">import</span> <span class="token string">'dotenv/config'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'./database/connectDB.js'</span>

<span class="token keyword">import</span> authRouter <span class="token keyword">from</span> <span class="token string">'./routes/auth.route.js'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/'</span> <span class="token punctuation">,</span> authRouter<span class="token punctuation">)</span>

<span class="token comment">// Si no existe, asigna el puerto 500</span>
<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">5000</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'http://localhost:'</span><span class="token operator">+</span><span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">tipo de peticiones</p> <ul><li>El navegador solo trabaja con solicitudes GET.</li> <li>El formulario HTML a través del atributo method puede enviar solicitudes GET O POST</li> <li>Usamos postman para trabajar con un conjunto de solicitudes (GET , POST , PUT , DELETE , ETC)</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">Observacion</p> <p>Se hace peticiones get a :</p> <ul><li>http://localhost:5000/login</li> <li>http://localhost:5000/register</li></ul></div> <h3 id="actualizamos-el-index-js"><a href="#actualizamos-el-index-js" class="header-anchor">#</a> Actualizamos el index.js</h3> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api'</span> <span class="token punctuation">,</span> authRouter<span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <p>Se hace peticiones get a :</p> <ul><li>http://localhost:5000/api/register</li> <li>http://localhost:5000/api/login</li></ul></div> <h3 id="separamos-la-logica"><a href="#separamos-la-logica" class="header-anchor">#</a> Separamos la logica</h3> <p>Controllers/auth.controllers.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req <span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ok<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">register</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req <span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ok<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>Routes/auth.route.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> login<span class="token punctuation">,</span> register <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../Controllers/auth.controllers.js'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span> <span class="token punctuation">,</span> login<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/register&quot;</span> <span class="token punctuation">,</span> register<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">;</span>

</code></pre></div><h2 id="formas-de-enviar-datos"><a href="#formas-de-enviar-datos" class="header-anchor">#</a> Formas de enviar datos</h2> <ul><li>La información se envía por el body.</li></ul> <h3 id="postman"><a href="#postman" class="header-anchor">#</a> Postman</h3> <ul><li>Existen diferente manera de enviar la informacion:</li></ul> <ol><li>A traves de un query params (GET)</li> <li>A través de form-data</li> <li>A través de x-www-form-urlencoded (etiqueta form HTML)</li> <li>raw – Json   (Para Enviar por json)</li></ol> <h3 id="para-leer-la-informacion-que-nos-mandan-en-json-a-traves-del-body-configuramos-un-middleware"><a href="#para-leer-la-informacion-que-nos-mandan-en-json-a-traves-del-body-configuramos-un-middleware" class="header-anchor">#</a> Para leer la información que nos mandan en JSON a través del body configuramos un middleware.</h3> <p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><ul><li>Entonces podemos leer la información que recibimos en el requirimiento (body).</li></ul> <p>Ejemplo:</p> <p>auth.controller.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req <span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ok<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    
<span class="token punctuation">}</span>

</code></pre></div><h2 id="validaciones-express-validator"><a href="#validaciones-express-validator" class="header-anchor">#</a> Validaciones (Express-Validator)</h2> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <ul><li>LAS VALIDACIONES EN EL BACKEND SON OBLIGATORIAS YA QUE APORTA SEGURIDAD</li> <li>LAS VALIDACIONES EN EL FRONTEND AYUDAN AL USUARIO , NO APORTAN SEGURIDAD</li></ul></div> <p>auth.route.js</p> <ul><li>Especificamos las validaciones a realizar</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// importamos el body de express-validator que es un middleware</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>body<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express-validator'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//post(&quot;ruta&quot; , [middlewares] , funcion que gestiona la solicitud)</span>
<span class="token comment">// Los middleware analizan la solicitud y si esta todo correcto , ejecuta la funcion que gestiona la solicitud.</span>
<span class="token comment">//body('nombrepropiedad' , 'mensaje de error').validaciones.validaciones.validaciones</span>
<span class="token comment">// cuando se reciba en el body la propiedad 'nombrepropiedad' , lo validara.</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'email'</span> <span class="token punctuation">,</span> <span class="token string">'No es un email'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalizeEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">,</span> login<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/register&quot;</span> <span class="token punctuation">,</span> register<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">;</span>

</code></pre></div><p>auth.controller.js</p> <ul><li>Realizamos las validaciones que especificamos y obtenemos un resultado (si paso o no)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> validationResult <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;express-validator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Realizamos/Ejecutamos las validaciones de express-validator </span>
    <span class="token comment">//validationResult(req) -- en el req estan los datos que se van a validar</span>
    <span class="token comment">// Devuelve el error en caso que exista</span>
    <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Si existen errores</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> errors<span class="token operator">:</span> error<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ok<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>

</code></pre></div><h3 id="completamos-las-validaciones"><a href="#completamos-las-validaciones" class="header-anchor">#</a> Completamos las validaciones</h3> <div class="custom-block tip"><p class="custom-block-title">Validaciones</p> <ul><li>trim()  = Limpia los caracteres en blanco</li> <li>isEmail() y normalizeEmail() = Comprueba que sea un email valido</li> <li>isLenght({min:X}) = Comprueba que el valor tenga mínimo  X caracteres</li> <li>custom(funcion) = Validacion personalizada</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">validacion personalizada</p> <ul><li>custom(funcion) = Validacion personalizada</li> <li>La función de la validacion personalizada tiene dos parámetros, el valor y el requerimiento(req).</li> <li>En la función se realiza una validacion. En caso que no se cumpla se lanza un error, si se cumple se retorna el valor.</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">Observacion</p> <p>Por defecto la respuesta tiene el código de estado 200</p></div> <p>auth.route.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> login<span class="token punctuation">,</span> register <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../Controllers/auth.controllers.js'</span><span class="token punctuation">;</span>
<span class="token comment">// importamos el body de express-validator que es un middleware</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>body<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express-validator'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//post(&quot;ruta&quot; , [middlewares] , funcion que gestiona la solicitud)</span>
<span class="token comment">// Los middleware analizan la solicitud y si esta todo correcto , ejecuta la funcion que gestiona la solicitud.</span>
<span class="token comment">//body('nombrepropiedad' , 'mensaje de error').validaciones.validaciones.validaciones</span>
<span class="token comment">// cuando se reciba en el body la propiedad 'nombrepropiedad' , lo validara.</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'email'</span> <span class="token punctuation">,</span> <span class="token string">'No es un email'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalizeEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'password'</span> <span class="token punctuation">,</span> <span class="token string">'formato de password incorrecta'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span>min<span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token punctuation">,</span> login<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/register&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'email'</span> <span class="token punctuation">,</span> <span class="token string">'No es un email'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalizeEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'password'</span> <span class="token punctuation">,</span> <span class="token string">'formato de password incorrecta'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span>min<span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>  <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'password'</span> <span class="token punctuation">,</span> <span class="token string">'No coinciden las contraseñas'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value <span class="token punctuation">,</span> <span class="token punctuation">{</span>req<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!==</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>repassword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// No se cumple la validacion</span>
       <span class="token comment">// Se lanza un error</span>
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No coinciden las contraseñas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// Se cumple la validacion </span>
   <span class="token comment">// Se retorna el valor</span>
   <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token punctuation">,</span>  register<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">;</span>

</code></pre></div><p>auth.controller.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> validationResult <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;express-validator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Realizamos/Ejecutamos las validaciones de express-validator </span>
    <span class="token comment">//validationResult(req) -- en el req estan los datos que se van a validar</span>
    <span class="token comment">// Devuelve el error en caso que exista</span>
    <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Si existen errores</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> errors<span class="token operator">:</span> error<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ok<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">register</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token comment">// Realizamos/Ejecutamos las validaciones de express-validator </span>
    <span class="token comment">//validationResult(req) -- en el req estan los datos que se van a validar</span>
    <span class="token comment">// Devuelve el error en caso que exista</span>
    <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Si existen errores</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> errors<span class="token operator">:</span> error<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ok<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="middleware-personalizado-para-validar"><a href="#middleware-personalizado-para-validar" class="header-anchor">#</a> Middleware Personalizado para validar</h2> <div class="custom-block tip"><p class="custom-block-title">¿Que es un mi middleware?</p> <ul><li>Es una función que contiene tres parámetros : req (requirimiento) , res (respuesta) y next</li> <li>Un middleware intercepta la peticion antes que llegue al “servidor” ,  se ejecuta antes de la funcion que gestiona la petición (dicha función se encuentra en la carpeta controllers)</li> <li>Entonces el middleware analiza la peticion y si esta todo bien, ejecuta el next().</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">next()</p> <ul><li>next() = Ejecuta el siguiente middleware (Puede haber varios middleware en un array) o ejecuta la función que gestiona la petición (se encuentra en la carpeta controllers)</li> <li>El next ejecuta el siguiente middleware, si NO EXISTE, ejecuta la función que gestiona la petición.</li></ul></div> <p>middlewares/validationResultExpress.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> validationResult <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;express-validator&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">validationResult</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req <span class="token punctuation">,</span> res <span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Realizamos/Ejecutamos las validaciones de express-validator </span>
    <span class="token comment">//validationResult(req) -- en el req estan los datos que se van a validar</span>
    <span class="token comment">// Devuelve el error en caso que exista</span>
    <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Si existen errores</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> errors<span class="token operator">:</span> error<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>auth.controller.js</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ok<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">register</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ok<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>auth.route.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> login<span class="token punctuation">,</span> register <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../Controllers/auth.controllers.js'</span><span class="token punctuation">;</span>
<span class="token comment">// importamos el body de express-validator que es un middleware</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>body<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express-validator'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> validationResultExpress <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../middlewares/validationResultExpress.js'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//post(&quot;ruta&quot; , [middlewares] , funcion que gestiona la solicitud)</span>
<span class="token comment">// Los middleware analizan la solicitud y si esta todo correcto , ejecuta la funcion que gestiona la solicitud.</span>
<span class="token comment">//body('nombrepropiedad' , 'mensaje de error').validaciones.validaciones.validaciones</span>
<span class="token comment">// cuando se reciba en el body la propiedad 'nombrepropiedad' , lo validara.</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'email'</span> <span class="token punctuation">,</span> <span class="token string">'No es un email'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalizeEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'password'</span> <span class="token punctuation">,</span> <span class="token string">'formato de password incorrecta'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span>min<span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> validationResultExpress <span class="token punctuation">]</span> <span class="token punctuation">,</span> login<span class="token punctuation">)</span>


router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/register&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'email'</span> <span class="token punctuation">,</span> <span class="token string">'No es un email'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalizeEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'password'</span> <span class="token punctuation">,</span> <span class="token string">'formato de password incorrecta'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span>min<span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>  <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'password'</span> <span class="token punctuation">,</span> <span class="token string">'No coinciden las contraseñas'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value <span class="token punctuation">,</span> <span class="token punctuation">{</span>req<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!==</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>repassword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// No se cumple la validacion</span>
       <span class="token comment">// Se lanza un error</span>
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No coinciden las contraseñas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// Se cumple la validacion </span>
   <span class="token comment">// Se retorna el valor</span>
   <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> validationResultExpress <span class="token punctuation">]</span> <span class="token punctuation">,</span>  register<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">;</span>

</code></pre></div><h2 id="cifrar-contrasena-schema-pre-save"><a href="#cifrar-contrasena-schema-pre-save" class="header-anchor">#</a> Cifrar contraseña / Schema.pre / Save</h2> <h3 id="schema-pre"><a href="#schema-pre" class="header-anchor">#</a> Schema pre</h3> <ul><li>El pre sirve para ejecutar una función antes de una acción.</li> <li>Por ejemplo: Ciframos la contraseña antes de guardarla en la BD.</li> <li>Sintaxis: Esquema.pre(‘accion’ , function )</li> <li>La function se ejecutará antes de realizar la acción.</li> <li>La función no debe ser una función flecha ya que utiliza el this para acceder al esquema.</li> <li>La función tiene como parámetro el next que cumple la misma función que el del middleware. (en este caso que ejecute la ‘accion’)</li></ul> <h3 id="bycriptjs"><a href="#bycriptjs" class="header-anchor">#</a> bycriptjs</h3> <ul><li>Encriptamos la contraseña a través de saltos</li> <li>Primero se encripta la contraseña y luego se realiza saltos.</li> <li>saltos = palabras aleatorias que se van incorporando a la encriptación.</li> <li>Sirve para que dos contraseñas iguales no tengan el mismo hash (contraseña encriptada)</li></ul> <p>User.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> mongoose <span class="token keyword">from</span> <span class="token string">'mongoose'</span>
<span class="token keyword">import</span> bcryptjs <span class="token keyword">from</span> <span class="token string">'bcryptjs'</span><span class="token punctuation">;</span>
<span class="token comment">// Creamos el esquema (Lo instanciamos)</span>
<span class="token comment">// new Schema({los campos que va a tener el documento})</span>

<span class="token keyword">const</span> userSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// Cada campo contiene un objeto especificando el tipo de dato(type) , si es obligatorio(required) , etc</span>
    email<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> String<span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        trim<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">/* Limpia los caracteres en blanco */</span><span class="token punctuation">,</span>
        unique<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">/* Valor unico */</span><span class="token punctuation">,</span>
        lowercase<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">/* Los convierte en minuscula */</span><span class="token punctuation">,</span>
        index<span class="token operator">:</span> <span class="token punctuation">{</span> unique<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token comment">/* Indexar */</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    password<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> String<span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Antes de guardar en la bd , se ejecutara la function</span>
userSchema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">&quot;save&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// user = el esquema (en este caso es un objeto con dos propiedades (email,password))</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token comment">// Si la contraseña no es modificada</span>
  <span class="token comment">// isModified('nombrecampo') = Devuelve true si el nombrecampo es modificado</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">.</span><span class="token function">isModified</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Obtenemos los saltos</span>
        <span class="token comment">// genSalt(nro de salto)</span>
        <span class="token keyword">const</span> salt <span class="token operator">=</span> <span class="token keyword">await</span> bcryptjs<span class="token punctuation">.</span><span class="token function">genSalt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Encriptamos la contraseña</span>
        <span class="token comment">// hash(contraseña , numero de saltos)</span>
        <span class="token comment">// Devuelve el hash (contraseña encriptada)</span>
               <span class="token keyword">const</span> contraseñaEncriptada <span class="token operator">=</span> <span class="token keyword">await</span> bcryptjs<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>password<span class="token punctuation">,</span> salt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Le asignamos la contraseña encriptada al campo password</span>
        user<span class="token punctuation">.</span>password <span class="token operator">=</span> contraseñaEncriptada<span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Fallo el hash de contraseña'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Creamos el modelo y lo exportamos</span>
<span class="token comment">// model('nombreModelo' , esquema )</span>
<span class="token comment">// el nombreModelo = nombre de la coleccion que va a contener esa estructura(esquema)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> User <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> userSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="guardamos-los-usuarios-en-la-bd"><a href="#guardamos-los-usuarios-en-la-bd" class="header-anchor">#</a> Guardamos los usuarios en la BD.</h3> <ul><li>La instancia del modelo (el que exportamos del User.js) contiene el método para crear documentos en la colección.</li> <li><a href="https://mongoosejs.com/docs/queries.html" target="_blank" rel="noopener noreferrer">metodos del modelo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <ul><li>Algunos metodos (como el de crear/guardar)  lo contienen la instancia del modelo que creamos</li> <li>Para crear una instancia, se debe pasar un objeto con las mismas propiedades especificadas en el esquema que contiene el modelo.</li></ul></div> <p>auth.controller.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../models/User.js&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ok<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">register</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>email <span class="token punctuation">,</span> password<span class="token punctuation">}</span>  <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
     <span class="token comment">// Creamos una instancia del modelo</span>
     <span class="token comment">// new nombreModelo({propiedades del documento})</span>
     <span class="token comment">// Las propiedades del documento debe coincidir con las propiedades que se especifico en el esquema que contiene el modelo.</span>
      <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email <span class="token punctuation">,</span> password<span class="token punctuation">}</span><span class="token punctuation">)</span> 
      <span class="token comment">// Guardamos en la base de datos</span>
      <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ok <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    

 <span class="token punctuation">}</span>


    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ok<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <ul><li>El modelo representa una colección .</li> <li>Entonces el nombre del modelo === el nombre de la colección.</li> <li>Cuando usamos el metodo save , se crea la colección (en caso de no existir) y el documento.</li> <li>El documento que se guarda con el metodo save , contiene la información que se especifico al momento de instanciar el modelo.</li> <li>Entonces el objeto que se pasa al momento de instanciar el modelo es el documento a “crear”</li> <li>Por lo tanto, la instancia contiene las propiedades del esquema y los métodos para manipular la colección.</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">Explicacion somo si fuera SQL</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email <span class="token punctuation">,</span> password<span class="token punctuation">}</span><span class="token punctuation">)</span> 
 <span class="token comment">// Guardamos en la base de datos</span>
  <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><ul><li>User es el nombre del modelo.</li> <li>user.save() = INSERT INTO User (email, password) VALUES (email , password)</li> <li>VALUES(email , password )  = Los valores de email y password  corresponden a los valores de las propiedades email y password  del objeto que se pasa en la instancia de la primera línea (new User).</li></ul></div> <h2 id="validaciones-findone"><a href="#validaciones-findone" class="header-anchor">#</a> Validaciones // findOne()</h2> <h3 id="validaciones"><a href="#validaciones" class="header-anchor">#</a> Validaciones</h3> <ul><li>Usamos los códigos de errores de la BD para validar que el correo sea único.</li></ul> <h3 id="findone"><a href="#findone" class="header-anchor">#</a> findOne()</h3> <ul><li>Usamos el método findOne  para buscar un documento en la colección.</li> <li>Recibe un objeto con la propiedad y valor que están buscando:</li></ul> <div class="custom-block tip"><p class="custom-block-title">Ejemplo como si fuera relacional</p> <ul><li>modelo.findOne({apellido: “perez”);</li> <li>SQL : select * from modelo WHERE apellido = “perez”</li></ul></div> <ul><li>el metodo findOne lo contiene el modelo , NO LA INSTANCIA.</li> <li>Devuelve una instancia del modelo con el documento seleccionado.</li></ul> <p>auth.controller.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../models/User.js&quot;</span>

</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">register</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
        <span class="token comment">// lo buscamos en la BD</span>
        <span class="token comment">// WHERE email = valorPropiedadEmail</span>
        <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token operator">:</span> email<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Si existe el usuario</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Enviamos un objeto como error</span>
               <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>code <span class="token operator">:</span> <span class="token number">11000</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
         
        user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">// Guardamos en la base de datos</span>
        <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ok<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Codigo 11000 = Se duplica la key (el valor no es unico)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">11000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;Ya existe este usuario&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
       <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error <span class="token operator">:</span> <span class="token string">&quot;Error de servidor&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre></div><h2 id="login-anadirle-metodos-al-esquema"><a href="#login-anadirle-metodos-al-esquema" class="header-anchor">#</a> Login/Añadirle métodos al esquema</h2> <h3 id="anadirle-metodos-al-esquema"><a href="#anadirle-metodos-al-esquema" class="header-anchor">#</a> Añadirle metodos al esquema</h3> <ul><li>El metodo añadido lo va a contener las instancias del modelo</li> <li>Sintaxis: NombreEsquema.methods.nombreMetodo = función</li> <li>La función no debe ser de tipo flecha ya que necesitamos tener acceso al this para acceder a las propiedades del esquema.</li></ul> <p>User.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Esquema.methods.nombreMetodo = funcion</span>
userSchema<span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function-variable function">comparePassword</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">candidatePassword</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// this.password = Accedemos a la contraseña cifrada guardada en la BD</span>
    <span class="token comment">//compare(contraseña sin cifrar , contraseña cifrada)</span>
    <span class="token comment">// compare() compara dos contraseñas y devuelve true si coinciden</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> bcryptjs<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>candidatePassword <span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>password<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> User <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> userSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>auth.controller.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../models/User.js&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
        <span class="token comment">// lo buscamos en la BD</span>
        <span class="token comment">// WHERE email = valorPropiedadEmail</span>
        <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token operator">:</span> email <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Si NO existe el usuario</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;No existe el usuario&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> respuestaPassword <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">comparePassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Si no coinciden las contraseñas</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>respuestaPassword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;Contraseña incorrecta&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ok<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;Error de servidor&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <ul><li>Si el método findOne encuentra el documento , nos devuelve una instancia del Modelo que contiene el documento seleccionado.</li> <li>Entonces cuando invocamos el método que creamos anteriormente con la instancia, el this.password === la propiedad password del documento.</li></ul></div> <h2 id="jwt"><a href="#jwt" class="header-anchor">#</a> JWT</h2> <ul><li>EL Token es un “código” de acceso que le damos al Usuario.</li> <li>A través del token, verificamos que el usuario tenga acceso al recurso que solicito.</li> <li>Es el desarollador frontend el que se tiene que encargar de enviar el token al servidor(backend).</li> <li><a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">jwt<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <div class="custom-block tip"><p class="custom-block-title">Partes del token</p> <ul><li>Header : Contiene el algoritmo</li> <li>PayLoad: Contiene la data</li> <li>Verify Signature : Contiene el secreto  , se gestiona por el backend.</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">encoded</p> <ul><li>Contiene un ejemplo del token</li> <li>Contiene las tres partes(se distingue por los colores)</li></ul></div> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>En el Payload no debe haber información delicada. (contraseñas , etc)</p></div> <h2 id="generar-token-en-el-login-register"><a href="#generar-token-en-el-login-register" class="header-anchor">#</a> Generar Token en el Login/Register</h2> <h3 id="metodo-sign"><a href="#metodo-sign" class="header-anchor">#</a> Metodo sign()</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>payload<span class="token punctuation">}</span> <span class="token punctuation">,</span> ‘secreto’<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>El método sign como primer parámetro recibe el payload (es un objeto con informacion)</li> <li>El segundo parámetro  contiene el secreto (verify signature)</li></ul> <div class="custom-block tip"><p class="custom-block-title">Recordatorio</p> <ul><li>En el proyecto el JWT_SECRET esta en el .env (Es un String con palabras alazar)</li></ul></div> <p>auth.Controller.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../models/User.js&quot;</span>
<span class="token keyword">import</span> jwt <span class="token keyword">from</span> <span class="token string">'jsonwebtoken'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

        <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token operator">:</span> email <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;No existe el usuario&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> respuestaPassword <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">comparePassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>respuestaPassword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;Contraseña incorrecta&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Generamos el token JWT</span>
        <span class="token comment">// sign() crea el token </span>
        <span class="token comment">//sign({objeto con la informacion del payload} , 'String secreto')</span>

        <span class="token comment">// para mongosee _id === id</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> uid<span class="token operator">:</span> user<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_SECRET</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> token <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;Error de servidor&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Pasos a seguir</p> <ol><li>iniciamos sesion  Y obtenemos un token.</li> <li>Lo pegamos en la pagina de JWT (en donde esta el ejemplo)</li></ol> <ul><li>Ya podemos tenemos acceso al payload</li> <li>El payload es publico</li> <li>Mientras mas información tenga el payload , mas extenso es el token.</li></ul></div> <h2 id="refresh-token"><a href="#refresh-token" class="header-anchor">#</a> Refresh Token</h2> <div class="custom-block tip"><p class="custom-block-title">¿El navegador donde guarda el token?</p> <p>Como el token se pierde al refrescar la pagina se suele guardar en:</p> <ul><li>Cookies</li> <li>LocalStorage</li></ul></div> <h3 id="refresh-token-2"><a href="#refresh-token-2" class="header-anchor">#</a> Refresh Token</h3> <ul><li><p>En este proyecto no lo vamos a guardar en ninguna de las dos opciones</p></li> <li><p>Hay cookies especiales que solo son accedidas y insertadas desde el lado del servidor.</p></li> <li><p>En esas cookies especiales vamos a guardar un Refresh token.</p></li> <li><p>Cuando el usuario refresca el navegador, vamos a utilizar el refresh  token para recibir el token nuevamente.</p></li></ul> <h2 id="jwt-v2"><a href="#jwt-v2" class="header-anchor">#</a> JWT V2</h2> <p>en .env debe haber cuatros variables</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">JWT_SECRET</span>  <span class="token operator">=</span> el <span class="token function">secreto</span> <span class="token punctuation">(</span>Debe ser un String <span class="token punctuation">,</span> puede ser una palabra aleatoria<span class="token punctuation">)</span>
<span class="token constant">JWT_REFRESH</span> <span class="token operator">=</span> Debe ser un String <span class="token punctuation">,</span> puede ser una palabra aleatoria
<span class="token constant">MODO</span><span class="token operator">=</span>developer
<span class="token constant">URI_MONGO</span><span class="token operator">=</span><span class="token constant">XXX</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Token Expiration</p> <ul><li>Para que un token expire luego de un determinado tiempo usamos expiresIn</li> <li>expiresIn es una propiedad de un objeto cuyo valor es la cantidad de tiempo (en segundos) que va a estar activo el token.</li> <li>El objeto  se pasa como tercer parámetro al método sign</li></ul></div> <p>utils/tokenManager.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> jwt <span class="token keyword">from</span> <span class="token string">'jsonwebtoken'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">generateToken</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">uid</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
   <span class="token comment">// 15 Minutos en segundos</span>
    <span class="token keyword">const</span> expiresIn <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">15</span><span class="token punctuation">;</span>

        <span class="token comment">// Generamos el token JWT</span>
        <span class="token comment">// sign() crea el token </span>
        <span class="token comment">//sign({objeto con la informacion del payload} , 'String secreto' , {expiresIn: cantTiempo en segundos})</span>
        <span class="token comment">// expiresIn = Para especificar  cuando va a expirar el token</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> uid <span class="token punctuation">}</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_SECRET</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span>expiresIn<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>token <span class="token punctuation">,</span> expiresIn<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>auth.controller.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> generateToken <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../utils/tokenManager.js&quot;</span><span class="token punctuation">;</span> 
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

        <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token operator">:</span> email <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;No existe el usuario&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> respuestaPassword <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">comparePassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>respuestaPassword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;Contraseña incorrecta&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> <span class="token punctuation">{</span>token <span class="token punctuation">,</span> expiresIn<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generateToken</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> token <span class="token punctuation">,</span> expiresIn <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;Error de servidor&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h3 id="generamos-el-token-en-el-register"><a href="#generamos-el-token-en-el-register" class="header-anchor">#</a> Generamos el token en el register</h3> <p>auth.controllers.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">register</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
        <span class="token comment">// lo buscamos en la BD</span>
        <span class="token comment">// WHERE email = valorPropiedadEmail</span>
        <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token operator">:</span> email <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Si existe el usuario</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Enviamos un objeto como error</span>
            <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> code<span class="token operator">:</span> <span class="token number">11000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">// Guardamos en la base de datos</span>
        <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> token<span class="token punctuation">,</span> expiresIn <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generateToken</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> token <span class="token punctuation">,</span> expiresIn <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Codigo 11000 = Se duplica la key (el valor no es unico)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">11000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;Ya existe este usuario&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;Error de servidor&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre></div><h2 id="ruta-protegida"><a href="#ruta-protegida" class="header-anchor">#</a> Ruta protegida</h2> <ul><li>Creamos la “ruta protegida”</li></ul> <p>auth.route.js</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/protected&quot;</span> <span class="token punctuation">,</span> infoUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">;</span>

</code></pre></div><p>auth.controller.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">infoUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>user<span class="token operator">:</span> <span class="token string">&quot;correo@hotmail.com&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Ruta protegida</p> <p>http://localhost:5000/api/protected</p></div> <h3 id="postman-2"><a href="#postman-2" class="header-anchor">#</a> Postman</h3> <ul><li>La información puede viajar por el body y por el header</li> <li>En authorization hay muchos formatos(Type) Ej. API Key , Oauth 1.0 , etc</li> <li>El que mas se usa es el Bearer Token.</li> <li>Bearer Token: Envía información(token) a la cabecera(header)</li></ul> <h3 id="middleware"><a href="#middleware" class="header-anchor">#</a> Middleware</h3> <ul><li>Vamos a crear un middleware para preguntar sobre el token.</li> <li>Si el token es válido, le damos acceso a la información de la ruta protected.</li></ul> <p>auth.route.js</p> <ul><li>Implementamos el middleware</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/protected&quot;</span> <span class="token punctuation">,</span> requireToken <span class="token punctuation">,</span>  infoUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>middlewares/RequireToken.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> jwt <span class="token keyword">from</span> <span class="token string">'jsonwebtoken'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">requireToken</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req <span class="token punctuation">,</span> res <span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Accedemos al token que se envio a traves de header</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token operator">?.</span>authorization<span class="token punctuation">;</span>
        <span class="token comment">// Si no existe el token</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No existe el token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <ul><li>con req.headers  tenemos acceso a los headers</li></ul></div> <h3 id="verify"><a href="#verify" class="header-anchor">#</a> verify()</h3> <ul><li>Sirve para comprobar que el token sea valido.</li> <li>Tiene dos parámetros:</li></ul> <ol><li>El token</li> <li>La palabra secreta/secret</li></ol> <ul><li>Devuelve la información decodificada (el payload).</li> <li>Si el token no es válido, lanza un error y se va al catch.</li></ul> <p>RequireToken.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> jwt <span class="token keyword">from</span> <span class="token string">'jsonwebtoken'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">requireToken</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req <span class="token punctuation">,</span> res <span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Accedemos al token que se envio a traves de header</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token operator">?.</span>authorization<span class="token punctuation">;</span>
        <span class="token comment">// Si no existe el token</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No existe el token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> payload <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token <span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_SECRET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Prueba</p> <p>Prueben enviando en– authorization -- Bearer Token , el token.</p></div> <h3 id="quitarle-el-formato-bearer"><a href="#quitarle-el-formato-bearer" class="header-anchor">#</a> Quitarle el formato bearer</h3> <ul><li>En el ejemplo anterior, ningún token es válido.</li> <li>Esto pasa porque la const token contiene el formato bearer.</li> <li>Como la const token no tiene el formato de un token, no es válido.</li> <li>Para solucionar esto, hay que conseguir el valor del token específicamente.</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Accedemos al token que se envio a traves de header</span>
        <span class="token keyword">let</span> token <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token operator">?.</span>authorization<span class="token punctuation">;</span>
        <span class="token comment">// Si no existe el token</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No existe el token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Conseguimos el token</span>
        token <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> payload <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token <span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_SECRET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre></div><h2 id="ruta-protegida-2-anadir-una-propiedad-al-objeto-req-findbyid"><a href="#ruta-protegida-2-anadir-una-propiedad-al-objeto-req-findbyid" class="header-anchor">#</a> Ruta protegida  #2  / Añadir una propiedad al objeto req / findById()</h2> <ul><li>Sacamos información del payload para pasarla a la ruta protegida.</li></ul> <p>RequireToken.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> jwt <span class="token keyword">from</span> <span class="token string">'jsonwebtoken'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">requireToken</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Accedemos al token que se envio a traves de header</span>
        <span class="token keyword">let</span> token <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token operator">?.</span>authorization<span class="token punctuation">;</span>
        <span class="token comment">// Si no existe el token</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No existe el token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Conseguimos el token</span>
        token <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> uid <span class="token punctuation">}</span> <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_SECRET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Le añadimos una propiedad al req</span>
        req<span class="token punctuation">.</span>uid <span class="token operator">=</span> uid<span class="token punctuation">;</span>
        <span class="token comment">//El mismo objeto req se le pasa al siguiente middleware o funcion que gestione la solicitud</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> error<span class="token punctuation">.</span>message <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <p>Le añadimos la uid(id) del usuario al requerimiento(req) desde el middleware para que luego la función que gestione la solicitud HTTP tenga acceso a la id del usuario.</p></div> <h2 id="findbyid"><a href="#findbyid" class="header-anchor">#</a> findById()</h2> <ul><li>Lo contiene el modelo, no la instancia</li> <li>Utilizamos el método findById () para buscar un documento por la id. (Parecido a findOne)</li> <li>Recibe la id a buscar</li> <li>Nos devuelve una instancia del modelo que contiene el documento seleccionado.</li> <li>Ej. Ej. User.findById(123) = Select * from User WHERE id = 123;</li></ul> <p>auth.controller.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">infoUser</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Buscamos un documento por la id </span>
<span class="token comment">//findById(id);</span>

        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> <span class="token string">&quot;error de server&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <p>Accedemos al requirimiento uid que agrego el middleware.</p></div> <h2 id="validaciones-del-token"><a href="#validaciones-del-token" class="header-anchor">#</a> Validaciones del token</h2> <h3 id="_1-forma"><a href="#_1-forma" class="header-anchor">#</a> 1 Forma</h3> <p>tokenManager.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">errorsValidateToken</span> <span class="token operator">=</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">'invalid signature'</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">&quot;firma no válida&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'jwt expired'</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">&quot;token expirado&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'invalid token'</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">&quot;No invente token&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">&quot;Token no valido&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>RequireToken.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> errorsValidateToken <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../utils/tokenManager.js'</span><span class="token punctuation">;</span>



<span class="token function">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token function">errorsValidateToken</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre></div><h3 id="_2-forma"><a href="#_2-forma" class="header-anchor">#</a> 2 Forma</h3> <p>RequireToken.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">const</span> TokenVerificationError <span class="token operator">=</span> <span class="token punctuation">{</span>
           <span class="token punctuation">[</span><span class="token string">&quot;jwt expired&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;JWT expirado&quot;</span> <span class="token punctuation">,</span>
           <span class="token punctuation">[</span><span class="token string">&quot;invalid token&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;Token no valido&quot;</span><span class="token punctuation">,</span>
           <span class="token punctuation">[</span><span class="token string">&quot;jwt expired&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;Token expirado&quot;</span><span class="token punctuation">,</span>
           <span class="token punctuation">[</span><span class="token string">&quot;invalid signature&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;Firma no valida&quot;</span><span class="token punctuation">,</span>
           <span class="token punctuation">[</span><span class="token string">&quot;jwt malformed&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;Token no valido&quot;</span> <span class="token punctuation">,</span>
           <span class="token punctuation">[</span><span class="token string">&quot;No existe el token&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;No existe el token&quot;</span> <span class="token punctuation">,</span>
       <span class="token punctuation">}</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
            error<span class="token operator">:</span> TokenVerificationError<span class="token punctuation">[</span>error<span class="token punctuation">.</span>message<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <p>Le podes quitar los corchetes que funciona igual.</p></div> <h2 id="modificamos-la-informacion-que-nos-devuelve-la-ruta-protegida-y-usamos-el-lean"><a href="#modificamos-la-informacion-que-nos-devuelve-la-ruta-protegida-y-usamos-el-lean" class="header-anchor">#</a> Modificamos la información que nos devuelve la ruta protegida y usamos el Lean</h2> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>No mostrar la contraseña</p></div> <h3 id="lean"><a href="#lean" class="header-anchor">#</a> lean()</h3> <ul><li>Al realizar una búsqueda con findById (Lo mismo pasa con findOne) nos devuelve una instancia del modelo que contiene varios métodos para manipular el documento seleccionado.</li> <li>Con lean() le quitamos todos los  métodos que corresponden a la instancia del modelo , permitiendo que la consulta sea mas rápido.</li> <li>Ej. con lean() , no contiene el metodo save()</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">infoUser</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Buscamos un documento por la id </span>
        <span class="token comment">//findById(id);</span>
        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token operator">:</span> user<span class="token punctuation">.</span>email <span class="token punctuation">,</span> uid<span class="token operator">:</span>user<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> <span class="token string">&quot;error de server&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="simple-html"><a href="#simple-html" class="header-anchor">#</a> Simple HTML</h2> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <ul><li>Es un ejemplo , luego se elimina del proyecto ya que una API REST no trabaja con el frontend.</li></ul></div> <ul><li>En la carpeta public van los archivos estáticos (HTML , CSS , JS , imágenes , etc)</li> <li>Todo el contenido que puede ser accedido desde el navegador va en la carpeta public</li> <li>Trabajar en la carpeta public es trabajar en el frontend.</li> <li>Todo en esta carpeta lo interpreta y ejecuta el navegador.</li> <li>Todas las demás carpetas es el backend (se ejecuta en el servidor/maquina)</li></ul> <h4 id="habilitamos-la-carpeta-public-con-el-middleware"><a href="#habilitamos-la-carpeta-public-con-el-middleware" class="header-anchor">#</a> Habilitamos la carpeta public  con el middleware:</h4> <p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api'</span> <span class="token punctuation">,</span> authRouter<span class="token punctuation">)</span>
<span class="token comment">//Temporal</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">&quot;public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="solicitudes-con-fetch"><a href="#solicitudes-con-fetch" class="header-anchor">#</a> Solicitudes con fetch</h2> <h3 id="metodo-fetch"><a href="#metodo-fetch" class="header-anchor">#</a> Metodo fetch</h3> <ul><li>Utilizamos el fetch para realizar una solicitud HTTP.</li> <li>Por defecto hace una solicitud en GET</li></ul> <h3 id="fetch-url-configuraciones"><a href="#fetch-url-configuraciones" class="header-anchor">#</a> fetch(url , {configuraciones})</h3> <p>Parametros:</p> <ol><li>Una url, donde se va a hacer la solicitud</li> <li>un objeto con configuraciones</li></ol> <h3 id="configuraciones-del-fetch-propiedad-y-valor"><a href="#configuraciones-del-fetch-propiedad-y-valor" class="header-anchor">#</a> Configuraciones del fetch  (Propiedad y valor)</h3> <ul><li>method : POST/GET/DELETE/ETC</li> <li>headers: {         el tipo de información que acepta el servidor , datos que se envia por el header     }</li> <li>body: La informacion que se envia</li> <li>credentials : 'valor'   =  Depende del valor, incluye las cookies del navegador en la solicitud.</li></ul> <p>index.html</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>es<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Login<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>formLogin<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>email<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>correo5@hotmail.com<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>email<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>123456<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Acceder<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
            <span class="token keyword">const</span> formLogin <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#formLogin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> email <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#email&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> password <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            formLogin<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;submit&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;/api/login&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                        method<span class="token operator">:</span> <span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span>
                        headers<span class="token operator">:</span> <span class="token punctuation">{</span>
                            <span class="token string">&quot;Content-Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                            email<span class="token operator">:</span> email<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                            password<span class="token operator">:</span> password<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>ok<span class="token punctuation">,</span> res<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> <span class="token punctuation">{</span> token <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// Redirreciono a otro sitio</span>
                    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;/protected.html&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <ul><li>Si en el navegador, ingresamos a http://localhost:5000/ , se ejecutaría el index.html (lo ejecuta el navegador)</li></ul></div> <p>protected.html</p> <ul><li>Seria la &quot;ruta protegida&quot;</li></ul> <div class="custom-block tip"><p class="custom-block-title">Configuracion del Header -- Authorization</p> <div class="language-js extra-class"><pre class="language-js"><code> headers<span class="token operator">:</span> <span class="token punctuation">{</span>
                            Authorization<span class="token operator">:</span> <span class="token string">&quot;Bearer &quot;</span> <span class="token operator">+</span> token<span class="token punctuation">,</span>
                        <span class="token punctuation">}</span>

</code></pre></div><ul><li>Sirve para Para enviar el token por el header como estuvimos haciendo, respetando el formato Bearer.</li></ul></div> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Ruta protegida<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Ruta protegida<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>Email<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>UID<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>logout<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Logout<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
            <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiI2Mjg2M2NiYzU4ZjQ1MmRkZGIxYjI3M2UiLCJpYXQiOjE2NTM0MTcyNzcsImV4cCI6MTY1MzQxODE3N30.MkwHDyGsMzJ2NtIHTVBh9ibKQjGZLffxhtnsHp72jEI&quot;</span>
            <span class="token comment">// Cuando se cargue el DOM</span>
            document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> resToken <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;/api/protected&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                        headers<span class="token operator">:</span> <span class="token punctuation">{</span>
                            Authorization<span class="token operator">:</span> <span class="token string">&quot;Bearer &quot;</span> <span class="token operator">+</span> token<span class="token punctuation">,</span>
                            <span class="token string">&quot;Content-Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> resToken<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
                        &lt;h2&gt;Email: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/h2&gt;
                    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

           
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <ul><li>Si en el navegador, ingresamos a http://localhost:5000/protected.html , se ejecutaría el protected.html (lo ejecuta el navegador).</li></ul></div> <h2 id="formas-de-guardar-el-token"><a href="#formas-de-guardar-el-token" class="header-anchor">#</a> Formas de guardar el token</h2> <h3 id="localstorage"><a href="#localstorage" class="header-anchor">#</a> localStorage</h3> <p>index.html</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>ok<span class="token punctuation">,</span> res<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> <span class="token punctuation">{</span> token <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// Guardamos en el localStorage;</span>
                    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span> <span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// Redirreciono a otro sitio</span>
                     window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;/protected.html&quot;</span><span class="token punctuation">;</span>

</code></pre></div><p>protected.html</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
            <span class="token comment">// Obtenemos el valor del localStorage</span>
            <span class="token keyword">const</span> token <span class="token operator">=</span>  localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="custom-block warning"><p class="custom-block-title">Desventajas</p> <p>Menos seguridad: Se puede acceder desde el navegador.</p></div> <h3 id="cookies-sin-configuraciones"><a href="#cookies-sin-configuraciones" class="header-anchor">#</a> Cookies (Sin configuraciones)</h3> <ul><li>Las cookies es  como el localStorage , se guarda con nombre -&gt; valor</li></ul> <h3 id="metodo-cookie"><a href="#metodo-cookie" class="header-anchor">#</a> metodo cookie()</h3> <ul><li>Sirve para crear una cookie</li> <li>Tiene tres parametros</li></ul> <ol><li>nombre de la cookie</li> <li>valor de la cookie</li> <li>un objeto con las configuraciones (opcional)</li></ol> <p>index.js</p> <ul><li>Habilitamos el módulo de cookieParser para trabajar con cookies.</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token comment">// Habilitamos las variables de entorno</span>
<span class="token keyword">import</span> <span class="token string">'dotenv/config'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'./database/connectDB.js'</span>
<span class="token keyword">import</span> cookieParser <span class="token keyword">from</span> <span class="token string">'cookie-parser'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> authRouter <span class="token keyword">from</span> <span class="token string">'./routes/auth.route.js'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Habilitamos las cookies para poder usarlas</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api'</span> <span class="token punctuation">,</span> authRouter<span class="token punctuation">)</span>

</code></pre></div><p>auth.controller.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

        <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token operator">:</span> email <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;No existe el usuario&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> respuestaPassword <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">comparePassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>respuestaPassword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;Contraseña incorrecta&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> <span class="token punctuation">{</span>token <span class="token punctuation">,</span> expiresIn<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generateToken</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Guardamos una cookie  </span>
        <span class="token comment">//cookie(nombre , valor , {configuraciones})</span>
        res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span> <span class="token punctuation">,</span> token<span class="token punctuation">)</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> token <span class="token punctuation">,</span> expiresIn <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;Error de servidor&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><div class="custom-block warning"><p class="custom-block-title">Desventajas</p> <p>Menos seguridad: Se puede acceder desde el navegador.</p></div> <h3 id="cookies-con-configuraciones"><a href="#cookies-con-configuraciones" class="header-anchor">#</a> Cookies (Con configuraciones)</h3> <ul><li>Tiene mas seguridad que la anterior</li></ul> <h4 id="configuracion-3-parametro-del-metodo-cookie"><a href="#configuracion-3-parametro-del-metodo-cookie" class="header-anchor">#</a> Configuracion (3 parametro del metodo cookie)</h4> <h5 id="httponly-boolean"><a href="#httponly-boolean" class="header-anchor">#</a> httpOnly : boolean</h5> <ul><li>true = Solo va a vivir en el HTTP, no se puede acceder desde el frontend.</li></ul> <h5 id="secure-boolean"><a href="#secure-boolean" class="header-anchor">#</a> secure : boolean</h5> <p>true = Va a vivir en https   false = Va a vivir en http</p> <p>auth.controller.js</p> <div class="language-js extra-class"><pre class="language-js"><code>       res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span> <span class="token punctuation">,</span> token <span class="token punctuation">,</span> <span class="token punctuation">{</span>
            httpOnly<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
            
            secure<span class="token operator">:</span> <span class="token operator">!</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MODO</span> <span class="token operator">===</span> <span class="token string">&quot;developer&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><ul><li>Es mas seguro que localStorage y las cookies sin configuración.</li></ul> <h3 id="obtener-el-valor-de-la-cookie"><a href="#obtener-el-valor-de-la-cookie" class="header-anchor">#</a> Obtener el valor de la cookie</h3> <p>RequireToken.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">requireToken</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Accedemos al token que se envio a traves de las cookies</span>
<span class="token comment">// Obtenemos el valor de una cookie</span>
<span class="token comment">// req.cookies.nombrecookie    </span>
        <span class="token keyword">let</span> token <span class="token operator">=</span> req<span class="token punctuation">.</span>cookies<span class="token operator">?.</span>token<span class="token punctuation">;</span>
        <span class="token comment">// Si no existe el token</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No existe el token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> uid <span class="token punctuation">}</span> <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_SECRET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Le añadimos una propiedad al req</span>
        req<span class="token punctuation">.</span>uid <span class="token operator">=</span> uid<span class="token punctuation">;</span>
        <span class="token comment">//El mismo objeto req se le pasa al siguiente middleware o funcion que gestione la solicitud</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">const</span> TokenVerificationError <span class="token operator">=</span> <span class="token punctuation">{</span>
           <span class="token punctuation">[</span><span class="token string">&quot;jwt expired&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;JWT expirado&quot;</span> <span class="token punctuation">,</span>
           <span class="token punctuation">[</span><span class="token string">&quot;invalid token&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;Token no valido&quot;</span><span class="token punctuation">,</span>
           <span class="token punctuation">[</span><span class="token string">&quot;jwt expired&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;Token expirado&quot;</span><span class="token punctuation">,</span>
           <span class="token punctuation">[</span><span class="token string">&quot;invalid signature&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;Firma no valida&quot;</span><span class="token punctuation">,</span>
           <span class="token punctuation">[</span><span class="token string">&quot;jwt malformed&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;Token no valido&quot;</span> <span class="token punctuation">,</span>
           <span class="token punctuation">[</span><span class="token string">&quot;No existe el token&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;No existe el token&quot;</span> <span class="token punctuation">,</span>
       <span class="token punctuation">}</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
            error<span class="token operator">:</span> TokenVerificationError<span class="token punctuation">[</span>error<span class="token punctuation">.</span>message<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <p>Con req.cookies tenemos acceso a las cookies</p></div> <p>protected.html</p> <h3 id="credentials"><a href="#credentials" class="header-anchor">#</a> credentials</h3> <p>credentials :  ‘include’ =  cada solicitud debe tener una credencial (debe tener cookies) , sirve para enviar las cookies en la petición HTTP , estamos incluyendo las cookies que se encuentran en el navegador en la solicitud (petición HTTP).</p> <div class="language-js extra-class"><pre class="language-js"><code>     <span class="token keyword">const</span> resToken <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;/api/protected&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                        headers<span class="token operator">:</span> <span class="token punctuation">{</span>
                            <span class="token string">&quot;Content-Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        credentials<span class="token operator">:</span> <span class="token string">'include'</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="custom-block warning"><p class="custom-block-title">Desventajas</p> <p>Se puede acceder a la información  , si una pagina sospecha hace alguna solicitud que “incluya cookie”</p></div> <h2 id="refresh-token-3"><a href="#refresh-token-3" class="header-anchor">#</a> Refresh Token</h2> <ul><li>Es un token, que refrescara(actualizara) el “token verdadero”.</li> <li>el Refresh token se guarda en la cookie ya que da lo mismo si lo roban, total no es el “token verdadero”.</li></ul> <p>tokenManager.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">generateRefreshToken</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">uid <span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 30 dias  en segundos</span>
    <span class="token keyword">const</span> expiresIn <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> refreshToken <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> uid <span class="token punctuation">}</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_REFRESH</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>expiresIn<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">&quot;refreshToken&quot;</span><span class="token punctuation">,</span> refreshToken<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            httpOnly<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            secure<span class="token operator">:</span> <span class="token operator">!</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MODO</span> <span class="token operator">===</span> <span class="token string">&quot;developer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// La expiracion de la cookie : recibe el tiempo en milisegundos</span>
            expires<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expiresIn <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <ul><li>Usamos la variable de entorno JWT_REFRESH que es un String oculto (como el secreto)</li></ul></div> <p>auth.controller.js</p> <ul><li>En el login , al momento de crear el &quot;token verdadero&quot; , tambien creamos el refesh token</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> generateRefreshToken<span class="token punctuation">,</span> generateToken <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../utils/tokenManager.js&quot;</span><span class="token punctuation">;</span>

 <span class="token keyword">const</span> <span class="token punctuation">{</span> token<span class="token punctuation">,</span> expiresIn <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generateToken</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">generateRefreshToken</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id <span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="acceder-al-token-verdadero-a-traves-del-refresh-token"><a href="#acceder-al-token-verdadero-a-traves-del-refresh-token" class="header-anchor">#</a> Acceder al “token verdadero” a través del Refresh Token.</h3> <h4 id="explicacion"><a href="#explicacion" class="header-anchor">#</a> Explicacion</h4> <ul><li>Le enviamos una solicitud al servidor con el Refresh Token.</li> <li>El servidor validara el token y si es válido, devolverá el “token verdadero”.</li> <li>el “token verdadero” solo vivirá en la memoria RAM del pc del cliente (es una constante)</li></ul> <p>auth.route.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> infoUser<span class="token punctuation">,</span> login<span class="token punctuation">,</span> refreshToken<span class="token punctuation">,</span> register <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../Controllers/auth.controllers.js'</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/refresh&quot;</span> <span class="token punctuation">,</span> refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>auth.controller.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> jwt <span class="token keyword">from</span> <span class="token string">'jsonwebtoken'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">refreshToken</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> refreshTokenCookie <span class="token operator">=</span> req<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>refreshToken<span class="token punctuation">;</span>
        <span class="token comment">// Si no existe el token</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>refreshTokenCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;No existe el token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> uid <span class="token punctuation">}</span> <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>refreshTokenCookie<span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_REFRESH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Generamos el &quot;token verdadero&quot;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> token<span class="token punctuation">,</span> expiresIn <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generateToken</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> token<span class="token punctuation">,</span> expiresIn <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;error de refresh&quot;</span> <span class="token punctuation">,</span> error<span class="token punctuation">.</span>message <span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> TokenVerificationError <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token punctuation">[</span><span class="token string">&quot;jwt expired&quot;</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&quot;JWT expirado&quot;</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token string">&quot;invalid token&quot;</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&quot;Token no valido&quot;</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token string">&quot;jwt expired&quot;</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&quot;Token expirado&quot;</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token string">&quot;invalid signature&quot;</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&quot;Firma no valida&quot;</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token string">&quot;jwt malformed&quot;</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&quot;Token no valido&quot;</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token string">&quot;No existe el token&quot;</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&quot;No existe el token&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            error<span class="token operator">:</span> TokenVerificationError<span class="token punctuation">[</span>error<span class="token punctuation">.</span>message<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>RequireToken.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">requireToken</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Accedemos al token que se envio a traves del header</span>
        <span class="token keyword">let</span> token <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token operator">?.</span>authorization<span class="token punctuation">;</span>
        
        <span class="token comment">// Si no existe el token</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No existe el token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        token <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> uid <span class="token punctuation">}</span> <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_SECRET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="ahora-accedemos-al-token-verdadero-desde-el-archivo-html"><a href="#ahora-accedemos-al-token-verdadero-desde-el-archivo-html" class="header-anchor">#</a> Ahora accedemos al “token verdadero” desde el archivo HTML</h3> <p>protected.html</p> <div class="language-html extra-class"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  
        <span class="token comment">// Cuando se cargue el DOM</span>
        document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

            <span class="token keyword">const</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> resToken <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;/api/refresh&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    method<span class="token operator">:</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span>
                    credentials<span class="token operator">:</span> <span class="token string">'include'</span>

                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword">const</span> <span class="token punctuation">{</span>token<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> resToken<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;/api/protected&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    headers<span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token string">&quot;Content-Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span>
                        Authorization<span class="token operator">:</span><span class="token string">&quot;Bearer &quot;</span> <span class="token operator">+</span> token
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
              
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
                        &lt;h2&gt;Email: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/h2&gt;
                    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><h4 id="explicacion-2"><a href="#explicacion-2" class="header-anchor">#</a> Explicacion</h4> <ul><li>Esto junto con la implementación de los CORS (más adelante lo vemos) proporcionaría mucha mas seguridad que los otros dos métodos (guardar en la cookie/Localstorage)</li> <li>El usuario malicioso podrá hacer solicitudes, pero no recibirá ninguna respuesta (LA API NO LE DEVOLVERA INFORMACION)</li> <li>Por lo tanto, el usuario malicioso nunca podrá acceder al token verdadero.</li></ul> <h2 id="logout"><a href="#logout" class="header-anchor">#</a> Logout</h2> <p>auth.controller.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">logout</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//Eliminamos una cookie </span>
    <span class="token comment">//clearCookie('nombrecookie')</span>
    res<span class="token punctuation">.</span><span class="token function">clearCookie</span><span class="token punctuation">(</span><span class="token string">&quot;refreshToken&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ok<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>auth.route.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> infoUser<span class="token punctuation">,</span> login<span class="token punctuation">,</span> logout<span class="token punctuation">,</span> refreshToken<span class="token punctuation">,</span> register <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../Controllers/auth.controllers.js'</span><span class="token punctuation">;</span>


router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/logout&quot;</span> <span class="token punctuation">,</span> logout<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>protected.html</p> <div class="language-html extra-class"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  
        <span class="token comment">// Cuando se cargue el DOM</span>
        document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

            <span class="token keyword">const</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> resToken <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;/api/refresh&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    method<span class="token operator">:</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span>
                    credentials<span class="token operator">:</span> <span class="token string">'include'</span>

                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword">const</span> <span class="token punctuation">{</span>token<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> resToken<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;/api/protected&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    headers<span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token string">&quot;Content-Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span>
                        Authorization<span class="token operator">:</span><span class="token string">&quot;Bearer &quot;</span> <span class="token operator">+</span> token
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
              
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
                        &lt;h2&gt;Email: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/h2&gt;
                    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">const</span> logout <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#logout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logout<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;/api/logout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>ok<span class="token punctuation">,</span> res<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><h2 id="refactorizacion"><a href="#refactorizacion" class="header-anchor">#</a> Refactorizacion</h2> <h3 id="errores-al-verificar-el-token"><a href="#errores-al-verificar-el-token" class="header-anchor">#</a> Errores  al verificar el token</h3> <p>tokenManager.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> tokenVerificationError <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token string">&quot;jwt expired&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;JWT expirado&quot;</span> <span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">&quot;invalid token&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;Token no valido&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">&quot;jwt expired&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;Token expirado&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">&quot;invalid signature&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;Firma no valida&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">&quot;jwt malformed&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;Token no valido&quot;</span> <span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">&quot;No existe el token&quot;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;No existe el token&quot;</span> <span class="token punctuation">,</span>
<span class="token punctuation">}</span>

</code></pre></div><p>RequireToken.js</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">import</span> <span class="token punctuation">{</span> tokenVerificationError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../utils/tokenManager.js'</span><span class="token punctuation">;</span>


<span class="token function">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>  error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
     
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
            error<span class="token operator">:</span> tokenVerificationError<span class="token punctuation">[</span>error<span class="token punctuation">.</span>message<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre></div><h3 id="middleware-requirerefreshtoken"><a href="#middleware-requirerefreshtoken" class="header-anchor">#</a> middleware requireRefreshToken</h3> <p>middlewares/requireRefreshToken.js</p> <ul><li>Crea un nuevo requirimiento(req).</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> tokenVerificationError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../utils/tokenManager.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> jwt <span class="token keyword">from</span> <span class="token string">'jsonwebtoken'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">requireRefreshToken</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> refreshTokenCookie <span class="token operator">=</span> req<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>refreshToken<span class="token punctuation">;</span>
        <span class="token comment">// Si no existe el token</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>refreshTokenCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;No existe el token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> uid <span class="token punctuation">}</span> <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>refreshTokenCookie<span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_REFRESH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span>uid <span class="token operator">=</span> uid<span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            error<span class="token operator">:</span> tokenVerificationError<span class="token punctuation">[</span>error<span class="token punctuation">.</span>message<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>auth.controller.js</p> <ul><li>Accedemos al nuevo requirimiento (req).</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">refreshToken</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Generamos el &quot;token verdadero&quot;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> token<span class="token punctuation">,</span> expiresIn <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generateToken</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> token<span class="token punctuation">,</span> expiresIn <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;error de server&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>auth.route.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> requireRefreshToken <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../middlewares/requirerefreshToken.js'</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/refresh&quot;</span> <span class="token punctuation">,</span> requireRefreshToken<span class="token punctuation">,</span> refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="separamos-el-middleware-de-express-validator-del-auth-route-js"><a href="#separamos-el-middleware-de-express-validator-del-auth-route-js" class="header-anchor">#</a> Separamos el middleware de express-validator del auth.route.js</h3> <p>middleware/validatorManager.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> validationResult <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;express-validator&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// importamos el body de express-validator que es un middleware</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>body<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express-validator'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">validationResultExpress</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Realizamos/Ejecutamos las validaciones de express-validator </span>
    <span class="token comment">//validationResult(req) -- en el req estan los datos que se van a validar</span>
    <span class="token comment">// Devuelve el error en caso que exista</span>
    <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Si existen errores</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> errors<span class="token operator">:</span> error<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> bodyLoginValidator <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">,</span> <span class="token string">'No es un email'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalizeEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token string">'formato de password incorrecta'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span> min<span class="token operator">:</span> <span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> validationResultExpress<span class="token punctuation">,</span> validationResultExpress<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> bodyRegisterValidator <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">,</span> <span class="token string">'No es un email'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalizeEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token string">'formato de password incorrecta'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span> min<span class="token operator">:</span> <span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token string">'No coinciden las contraseñas'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> <span class="token punctuation">{</span> req <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!==</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>repassword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// No se cumple la validacion</span>
        <span class="token comment">// Se lanza un error</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No coinciden las contraseñas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Se cumple la validacion </span>
    <span class="token comment">// Se retorna el valor</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> validationResultExpress<span class="token punctuation">]</span><span class="token punctuation">;</span>

</code></pre></div><p>auth.routes.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> infoUser<span class="token punctuation">,</span> login<span class="token punctuation">,</span> logout<span class="token punctuation">,</span> refreshToken<span class="token punctuation">,</span> register <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../Controllers/auth.controllers.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> requireToken <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../middlewares/RequireToken.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> requireRefreshToken <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../middlewares/requirerefreshToken.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> bodyLoginValidator<span class="token punctuation">,</span> bodyRegisterValidator <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../middlewares/validatorManager.js'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//post(&quot;ruta&quot; , [middlewares] , funcion que gestiona la solicitud)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> bodyLoginValidator<span class="token punctuation">,</span> login<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/register&quot;</span><span class="token punctuation">,</span> bodyRegisterValidator<span class="token punctuation">,</span> register<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/protected&quot;</span><span class="token punctuation">,</span> requireToken<span class="token punctuation">,</span> infoUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/refresh&quot;</span><span class="token punctuation">,</span> requireRefreshToken<span class="token punctuation">,</span> refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/logout&quot;</span><span class="token punctuation">,</span> logout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">;</span>

</code></pre></div><h2 id="links-url-referencia-al-usuario"><a href="#links-url-referencia-al-usuario" class="header-anchor">#</a> Links (URL)  / Referencia al usuario</h2> <h3 id="modelo"><a href="#modelo" class="header-anchor">#</a> Modelo</h3> <p>model/Link.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> mongoose <span class="token keyword">from</span> <span class="token string">&quot;mongoose&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Schema <span class="token punctuation">}</span> <span class="token operator">=</span> mongoose<span class="token punctuation">;</span>

<span class="token keyword">const</span> linkSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    longLink<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> String<span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        trim<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    nanoLink<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> String<span class="token punctuation">,</span>
        unique<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        trim<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// Creamos una referencia a la id del usuario</span>
    uid<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// Schema.Types.ObjectId  = Es  una ID de un documento de una coleccion.</span>
        type<span class="token operator">:</span> Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span>
        <span class="token comment">// ref: nombre de la coleccion(nombre del modelo) al que hace referencia</span>
        ref<span class="token operator">:</span> <span class="token string">&quot;User&quot;</span><span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Link <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;Link&quot;</span><span class="token punctuation">,</span> linkSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Explicacion como si fuera relacional</p> <ul><li>Se hace una referencia a la columna _id(type:Schema.Types.ObjectId) de la tabla User(ref:”User”).</li> <li>_id lo genera mongoDB de manera automática.</li></ul></div> <h3 id="router"><a href="#router" class="header-anchor">#</a> Router</h3> <p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token comment">// Habilitamos las variables de entorno</span>
<span class="token keyword">import</span> <span class="token string">'dotenv/config'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'./database/connectDB.js'</span>
<span class="token keyword">import</span> cookieParser <span class="token keyword">from</span> <span class="token string">'cookie-parser'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> authRouter <span class="token keyword">from</span> <span class="token string">'./routes/auth.route.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> authLink <span class="token keyword">from</span> <span class="token string">'./routes/link.route.js'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Habilitamos las cookies para poder usarlas</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api'</span> <span class="token punctuation">,</span> authRouter<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/links'</span> <span class="token punctuation">,</span> authLink<span class="token punctuation">)</span>
<span class="token comment">//Temporal</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">&quot;public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// Si no existe, asigna el puerto 500</span>
<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">5000</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'http://localhost:'</span><span class="token operator">+</span><span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>routes/link.route.js</p> <div class="custom-block tip"><p class="custom-block-title">Diferencia entre el metodo put y patch</p> <ul><li>Una petición patch, modifica una parte del “todo” Ej. Modifica una parte del documento de la colección.</li> <li>Una petición put, modifica “todo”. Ej. Modifica todo el documento de la colección.</li></ul></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Router<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;express&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getLinks <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../Controllers/link.controller.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Rutas </span>

<span class="token comment">// PETICION GET A http://localhost:5000/api/links = Acceder a todos los links </span>

<span class="token comment">// PETICION GET A http://localhost:5000/api/links/:id = Acceder a un link</span>

<span class="token comment">// PETICION POST  A http://localhost:5000/api/links = Crea un link </span>

<span class="token comment">//PETICION PATCH/PUT A http://localhost:5000/api/links/:id = Actualiza un link</span>

<span class="token comment">//PETICION DELETE A http://localhost:5000/api/links/:id = Elimina un link</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span> <span class="token punctuation">,</span> getLinks<span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">;</span>

</code></pre></div><p>controllers/link.controller.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getLinks</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req <span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ok <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="leer-find"><a href="#leer-find" class="header-anchor">#</a> Leer / Find()</h2> <h3 id="find"><a href="#find" class="header-anchor">#</a> Find()</h3> <h4 id="sin-parametros"><a href="#sin-parametros" class="header-anchor">#</a> Sin parametros</h4> <ul><li>Busca todos los documentos de la colección.</li> <li>modelo.find()  = Select * from nombreModelo</li></ul> <div class="custom-block tip"><p class="custom-block-title">Recordatorio</p> <ul><li>El nombre del modelo  es el nombre de la colección.</li></ul></div> <h4 id="con-un-parametro-objeto"><a href="#con-un-parametro-objeto" class="header-anchor">#</a> Con un parámetro (Objeto)</h4> <ul><li>Sirve para filtrar (Seria como implementar un WHERE)</li> <li>modelo.find({dato:valor}); = Select * from nombreModelo WHERE dato = valor;</li></ul> <p>link.route.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> requireToken <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../middlewares/RequireToken.js&quot;</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span> <span class="token punctuation">,</span> requireToken <span class="token punctuation">,</span> getLinks<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>link.controller.js</p> <ul><li>Utilizamos el uid del requirimiento que lo inserta el middleware requireToken.</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getLinks</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req <span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// select * from Link(nombre modelo) WHERE uid = req.uid</span>
     <span class="token keyword">const</span> links <span class="token operator">=</span>    <span class="token keyword">await</span> Link<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>uid <span class="token operator">:</span> req<span class="token punctuation">.</span>uid<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>links<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> <span class="token string">'Error de servidor'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre></div><h2 id="crear"><a href="#crear" class="header-anchor">#</a> Crear</h2> <p>link.route.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createLink<span class="token punctuation">,</span> getLinks <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../Controllers/link.controller.js&quot;</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span> <span class="token punctuation">,</span> requireToken <span class="token punctuation">,</span> getLinks<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span> <span class="token punctuation">,</span> requireToken <span class="token punctuation">,</span> createLink<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>link.controller.js</p> <ul><li>Usamos el modulo nanoid para generar un String aleatorio.</li></ul> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm i nanoid
</code></pre></div><ul><li>Utilizamos el uid del requirimiento que lo inserta el middleware requireToken.</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">import</span> <span class="token punctuation">{</span> nanoid <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;nanoid&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Link <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../models/Link.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createLink</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>longLink<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
        <span class="token comment">//nanoid(longitud) = genera un string aleatorio</span>
        <span class="token keyword">const</span> link <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Link</span><span class="token punctuation">(</span><span class="token punctuation">{</span>longLink <span class="token punctuation">,</span> nanoLink<span class="token operator">:</span> <span class="token function">nanoid</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> uid<span class="token operator">:</span> req<span class="token punctuation">.</span>uid<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> link<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>link<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> <span class="token string">'Error de servidor'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="validar-url-longlink"><a href="#validar-url-longlink" class="header-anchor">#</a> Validar URL (longLink)</h2> <h3 id="express-validator"><a href="#express-validator" class="header-anchor">#</a> Express Validator</h3> <p>validatorManager.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> bodyLinkValidator <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;longLink&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;Formato link incorrecto&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// No este vacio </span>
    <span class="token punctuation">,</span>validationResultExpress
<span class="token punctuation">]</span>

</code></pre></div><p>link.route.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> bodyLinkValidator <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../middlewares/validatorManager.js&quot;</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span> <span class="token punctuation">,</span> requireToken <span class="token punctuation">,</span> getLinks<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// (ruta , middleware , middleware , funcion para gestionar la solicitud)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span> <span class="token punctuation">,</span> requireToken <span class="token punctuation">,</span> bodyLinkValidator <span class="token punctuation">,</span> createLink<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <ul><li>Los middlewares están en el segundo y tercer parámetro del método POST.</li> <li>Primero se ejecuta el del segundo parámetro y luego el tercero…</li></ul></div> <h3 id="axios"><a href="#axios" class="header-anchor">#</a> Axios</h3> <ul><li>Vamos a utilizer el modulo de <a href="https://www.npmjs.com/package/axios" target="_blank" rel="noopener noreferrer">axios<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (cumple la misma función que fetch)</li></ul> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm i axios
</code></pre></div><p>validatorManager.js</p> <div class="custom-block tip"><p class="custom-block-title">Explicacion del codigo</p> <ul><li>Se hace una petición GET a la url que se pasa en el body de la petición.</li> <li>Si se obtiene una respuesta, la url es válida.</li> <li>Si no se obtiene una respuesta, pasa al catch (el axios genera un error)</li></ul></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> bodyLinkValidator <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;longLink&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;Formato link incorrecto&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// No este vacio </span>
    <span class="token comment">// Funcion personalizada , value es el valor de la propiedad</span>
    <span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>




        <span class="token keyword">try</span> <span class="token punctuation">{</span>

           <span class="token comment">//Si la url NO comienza con 'http://' </span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>value<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'http://'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// Le añadimos el https:// al comienzo</span>
                   value <span class="token operator">=</span> <span class="token string">'https://'</span> <span class="token operator">+</span> value<span class="token punctuation">;</span>
           <span class="token punctuation">}</span>

        <span class="token comment">// Hacemos una peticion a la url</span>
          <span class="token comment">// axios.X(url);</span>
          <span class="token comment">// X puede ser GET , POST , FETCH , PUT , ETC</span>
          <span class="token comment">// Peticion GET a la url </span>
          <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No se encontro el link'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
       
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span>validationResultExpress
<span class="token punctuation">]</span>

</code></pre></div><p>link.controller.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createLink</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">{</span>longLink<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
         <span class="token comment">//Si la url NO comienza con 'http://' </span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>longLink<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'http://'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Le añadimos el https:// al comienzo</span>
            longLink <span class="token operator">=</span> <span class="token string">'https://'</span> <span class="token operator">+</span> longLink<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//nanoid(longitud) = genera un string aleatorio</span>
        <span class="token keyword">const</span> link <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Link</span><span class="token punctuation">(</span><span class="token punctuation">{</span>longLink <span class="token punctuation">,</span> nanoLink<span class="token operator">:</span> <span class="token function">nanoid</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> uid<span class="token operator">:</span> req<span class="token punctuation">.</span>uid<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> link<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>link<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> <span class="token string">'Error de servidor'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/aprendizaje/Node/Guia.html" class="prev">
        Guia practica - 2022
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/aprendizaje/assets/js/app.9a194da8.js" defer></script><script src="/aprendizaje/assets/js/2.c431ec36.js" defer></script><script src="/aprendizaje/assets/js/45.3ad9c563.js" defer></script>
  </body>
</html>
