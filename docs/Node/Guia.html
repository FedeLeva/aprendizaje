<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Guia practica - 2022 | Guias</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Descripcion">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/aprendizaje/assets/css/0.styles.5e6ce45c.css" as="style"><link rel="preload" href="/aprendizaje/assets/js/app.9a194da8.js" as="script"><link rel="preload" href="/aprendizaje/assets/js/2.c431ec36.js" as="script"><link rel="preload" href="/aprendizaje/assets/js/43.9cdf13c3.js" as="script"><link rel="prefetch" href="/aprendizaje/assets/js/10.e744f38e.js"><link rel="prefetch" href="/aprendizaje/assets/js/11.1da570f8.js"><link rel="prefetch" href="/aprendizaje/assets/js/12.94178c81.js"><link rel="prefetch" href="/aprendizaje/assets/js/13.6cc948da.js"><link rel="prefetch" href="/aprendizaje/assets/js/14.ac7318bb.js"><link rel="prefetch" href="/aprendizaje/assets/js/15.65795f28.js"><link rel="prefetch" href="/aprendizaje/assets/js/16.e127c599.js"><link rel="prefetch" href="/aprendizaje/assets/js/17.38e9d24d.js"><link rel="prefetch" href="/aprendizaje/assets/js/18.917bc518.js"><link rel="prefetch" href="/aprendizaje/assets/js/19.ed890b31.js"><link rel="prefetch" href="/aprendizaje/assets/js/20.a278704f.js"><link rel="prefetch" href="/aprendizaje/assets/js/21.3dee1d1e.js"><link rel="prefetch" href="/aprendizaje/assets/js/22.5e4685fa.js"><link rel="prefetch" href="/aprendizaje/assets/js/23.36d87931.js"><link rel="prefetch" href="/aprendizaje/assets/js/24.e1eea224.js"><link rel="prefetch" href="/aprendizaje/assets/js/25.26964830.js"><link rel="prefetch" href="/aprendizaje/assets/js/26.6511ac3a.js"><link rel="prefetch" href="/aprendizaje/assets/js/27.5bf3d181.js"><link rel="prefetch" href="/aprendizaje/assets/js/28.0b9347e3.js"><link rel="prefetch" href="/aprendizaje/assets/js/29.e30379aa.js"><link rel="prefetch" href="/aprendizaje/assets/js/3.4615dbf3.js"><link rel="prefetch" href="/aprendizaje/assets/js/30.162ed83d.js"><link rel="prefetch" href="/aprendizaje/assets/js/31.9552498d.js"><link rel="prefetch" href="/aprendizaje/assets/js/32.c17fa5da.js"><link rel="prefetch" href="/aprendizaje/assets/js/33.9add958a.js"><link rel="prefetch" href="/aprendizaje/assets/js/34.961d4adc.js"><link rel="prefetch" href="/aprendizaje/assets/js/35.183d4b13.js"><link rel="prefetch" href="/aprendizaje/assets/js/36.b2c46711.js"><link rel="prefetch" href="/aprendizaje/assets/js/37.4486e40c.js"><link rel="prefetch" href="/aprendizaje/assets/js/38.d5c9d1ca.js"><link rel="prefetch" href="/aprendizaje/assets/js/39.2b76f93e.js"><link rel="prefetch" href="/aprendizaje/assets/js/4.7b66cd35.js"><link rel="prefetch" href="/aprendizaje/assets/js/40.13e06b26.js"><link rel="prefetch" href="/aprendizaje/assets/js/41.d1f1644f.js"><link rel="prefetch" href="/aprendizaje/assets/js/42.c441fa36.js"><link rel="prefetch" href="/aprendizaje/assets/js/44.995cf01e.js"><link rel="prefetch" href="/aprendizaje/assets/js/45.3ad9c563.js"><link rel="prefetch" href="/aprendizaje/assets/js/46.95ca3d6b.js"><link rel="prefetch" href="/aprendizaje/assets/js/47.801d7715.js"><link rel="prefetch" href="/aprendizaje/assets/js/48.fb9df337.js"><link rel="prefetch" href="/aprendizaje/assets/js/49.2ddaedfa.js"><link rel="prefetch" href="/aprendizaje/assets/js/5.a396fb32.js"><link rel="prefetch" href="/aprendizaje/assets/js/50.425afa5e.js"><link rel="prefetch" href="/aprendizaje/assets/js/51.cb98c0b0.js"><link rel="prefetch" href="/aprendizaje/assets/js/52.6031d4b6.js"><link rel="prefetch" href="/aprendizaje/assets/js/53.20ccf08a.js"><link rel="prefetch" href="/aprendizaje/assets/js/54.5863fe63.js"><link rel="prefetch" href="/aprendizaje/assets/js/55.1d68b619.js"><link rel="prefetch" href="/aprendizaje/assets/js/56.a04ef3a6.js"><link rel="prefetch" href="/aprendizaje/assets/js/57.1355675d.js"><link rel="prefetch" href="/aprendizaje/assets/js/58.38ed085f.js"><link rel="prefetch" href="/aprendizaje/assets/js/59.8a8a2036.js"><link rel="prefetch" href="/aprendizaje/assets/js/6.27888615.js"><link rel="prefetch" href="/aprendizaje/assets/js/60.8c9608ce.js"><link rel="prefetch" href="/aprendizaje/assets/js/61.1ab10c02.js"><link rel="prefetch" href="/aprendizaje/assets/js/62.6b368ae7.js"><link rel="prefetch" href="/aprendizaje/assets/js/7.06129e92.js"><link rel="prefetch" href="/aprendizaje/assets/js/8.9737c9fc.js"><link rel="prefetch" href="/aprendizaje/assets/js/9.7e901376.js">
    <link rel="stylesheet" href="/aprendizaje/assets/css/0.styles.5e6ce45c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/aprendizaje/" class="home-link router-link-active"><!----> <span class="site-name">Guias</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/aprendizaje/" class="nav-link">
  Inicio
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/aprendizaje/" class="nav-link">
  Inicio
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/aprendizaje/Node/" aria-current="page" class="sidebar-link">Lo Basico de Node</a></li><li><a href="/aprendizaje/Node/motor.html" class="sidebar-link">Motores de plantillas/vistas</a></li><li><a href="/aprendizaje/Node/router.html" class="sidebar-link">Router</a></li><li><a href="/aprendizaje/Node/mongo.html" class="sidebar-link">MongoDB</a></li><li><a href="/aprendizaje/Node/token.html" class="sidebar-link">Token y Practica API REST</a></li><li><a href="/aprendizaje/Node/Guia.html" aria-current="page" class="active sidebar-link">Guia practica - 2022</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#carpeta-public" class="sidebar-link">carpeta public</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#motor-de-plantilla" class="sidebar-link">Motor de plantilla</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#configuracion" class="sidebar-link">Configuracion</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#main-hbs" class="sidebar-link">main.hbs</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#css-js-etc" class="sidebar-link">CSS , JS , etc</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#each" class="sidebar-link">Each</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#configurar-partials" class="sidebar-link">Configurar Partials</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#router" class="sidebar-link">Router</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#configuracion-mongodb" class="sidebar-link">Configuracion mongoDB</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#modelo-esquema" class="sidebar-link">Modelo/Esquema</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#controladores-mvc" class="sidebar-link">Controladores (MVC)</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#instanciar-un-modelo" class="sidebar-link">Instanciar un modelo</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#guardar-en-la-bd" class="sidebar-link">Guardar en la BD</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#leer-datos" class="sidebar-link">Leer datos</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#eliminar-datos" class="sidebar-link">Eliminar datos</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#validacion-con-middlewares" class="sidebar-link">Validacion con middlewares</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#editar-en-mongodb" class="sidebar-link">Editar en MongoDB</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#clipboard" class="sidebar-link">clipboard</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#redireccionamiento" class="sidebar-link">Redireccionamiento</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#registrar-usuario" class="sidebar-link">Registrar usuario</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#respuestas" class="sidebar-link">Respuestas</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#modelo-usuario" class="sidebar-link">Modelo Usuario</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#cifrar-la-contrasena" class="sidebar-link">Cifrar la contraseña</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#pre-mongosee" class="sidebar-link">pre mongosee</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#confirmarcuenta" class="sidebar-link">ConfirmarCuenta</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#iniciar-sesion" class="sidebar-link">Iniciar sesion</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#anadirle-metodos-al-esquema-mongodb" class="sidebar-link">Añadirle metodos al esquema mongoDB</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#favicon" class="sidebar-link">Favicon</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#session" class="sidebar-link">Session</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#flash" class="sidebar-link">Flash</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#validaciones-express-validator" class="sidebar-link">Validaciones(Express-validator)</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#validaciones-en-la-vista" class="sidebar-link">Validaciones en la vista</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#passport" class="sidebar-link">Passport</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#middleware-para-verificar-sesion" class="sidebar-link">Middleware para verificar sesion</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#cerrar-sesion" class="sidebar-link">Cerrar sesion</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#csrf-protection-middleware" class="sidebar-link">CSRF protection middleware</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#variables-globales" class="sidebar-link">Variables globales</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#cambios-en-el-proyecto" class="sidebar-link">Cambios en el proyecto</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#ref-mongodb" class="sidebar-link">ref mongoDB</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#nodemailer" class="sidebar-link">Nodemailer</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#subir-archivos" class="sidebar-link">Subir archivos</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#formidable" class="sidebar-link">Formidable</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#modulo-nativo-path-join" class="sidebar-link">Modulo nativo Path (Join)</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#file-system" class="sidebar-link">file System</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#jimp" class="sidebar-link">jimp</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#connet-mongo" class="sidebar-link">connet-mongo</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#saniteze-mongo" class="sidebar-link">Saniteze mongo</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#cors" class="sidebar-link">CORS</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#modificaciones-para-el-deploy" class="sidebar-link">Modificaciones para el deploy</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#cookies-segura" class="sidebar-link">Cookies segura</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#heroku" class="sidebar-link">Heroku</a></li><li class="sidebar-sub-header"><a href="/aprendizaje/Node/Guia.html#consejos" class="sidebar-link">Consejos</a></li></ul></li><li><a href="/aprendizaje/Node/apiRest.html" class="sidebar-link">API REST 2022</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="guia-practica-2022"><a href="#guia-practica-2022" class="header-anchor">#</a> Guia practica - 2022</h1> <p>Iniciamos el proyecto</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm init <span class="token operator">-</span>y
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>No utilizar espacios , tildes y no colocar nombres reservados (nombre de  package/modulos)</p></div> <p>package.json:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
 <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;practica&quot;</span><span class="token punctuation">,</span>
 <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
 <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
 <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
 <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon index.js&quot;</span><span class="token punctuation">,</span>
   <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node index.js&quot;</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token property">&quot;keywords&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
 <span class="token property">&quot;license&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ISC&quot;</span><span class="token punctuation">,</span>
 <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token property">&quot;nodemon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.15&quot;</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token property">&quot;express&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.17.3&quot;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">modelo MVC</p> <p>Vamos a trabajar con el modelo vista controlador</p> <p>Los controladores , las vistas y los modelos los vamos a separar</p></div> <h2 id="carpeta-public"><a href="#carpeta-public" class="header-anchor">#</a> carpeta public</h2> <ul><li><p>Cuando se trabaja desde el backend todo esta protegido , no se puede acceder desde el navegador.</p></li> <li><p>Pero podemos crear la carpeta public cuyos archivos si son públicos, se pueden acceder desde el navegador (ingresando la url)</p></li></ul> <p>Creamos la carpeta public y dentro un archivo index.html</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>index.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>TODAVIA NO SE PUEDE ACCEDER A index.html desde el navegador porque no esta configurada la carpeta public.</p> <p>Para hacer que todos los archivos de la carpeta public puedan ser accedido desde el navegador usamos el middleware.</p></div> <div class="custom-block tip"><p class="custom-block-title">middleware</p> <ul><li>Middleware = Se ejecuta antes de la respuesta del servidor.</li> <li>use = Middleware.</li></ul></div> <p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Usamos el middleware de express</span>
<span class="token comment">// Asignamos la carpeta publica</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">&quot;/public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// req = requirimiento(lo que manda el usuario) res = respuesta</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;estas solicitando la ruta raiz&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">5000</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;server andando 🔥 http://localhost:5000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="motor-de-plantilla"><a href="#motor-de-plantilla" class="header-anchor">#</a> Motor de plantilla</h2> <ul><li>Para no repetir todo el código HTML (por ejemplo, todos los archivos HTML deben tener el mismo footer o el mismo menú) , surgieron los motores de plantilla.</li></ul> <p>Instalamos un motor de plantilla  (existen muchos)</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm i express express<span class="token operator">-</span>handlebars
</code></pre></div><ul><li>Se parece a vue pero es mucho mas viejo.</li> <li>Tiene limitantes este motor de plantilla, que soluciona react , vue , etc.</li></ul> <p>Creamos una carpeta views y dentro  la carpeta layouts.</p> <ul><li>views
<ul><li>layouts</li></ul></li></ul> <p>Lo archivos que contiene layouts son los que podemos repetir en todas las páginas web (menú, footer , etc).</p> <p>dentro de la carpeta layouts creamos un archivo main.hbs</p> <p>views/layouts/main.hbs:</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code><span class="token punctuation">&lt;</span><span class="token punctuation">!</span><span class="token variable">DOCTYPE</span> <span class="token variable">html</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">html</span> <span class="token variable">lang</span><span class="token punctuation">=</span><span class="token string">&quot;en&quot;</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">head</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">charset</span><span class="token punctuation">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">http-equiv</span><span class="token punctuation">=</span><span class="token string">&quot;X-UA-Compatible&quot;</span> <span class="token variable">content</span><span class="token punctuation">=</span><span class="token string">&quot;IE=edge&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;viewport&quot;</span> <span class="token variable">content</span><span class="token punctuation">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">title</span><span class="token punctuation">&gt;</span><span class="token variable">Desde</span> <span class="token variable">HBS</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">title</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">head</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">body</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span><span class="token variable">Plantilla</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">body</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">html</span><span class="token punctuation">&gt;</span>

</code></pre></div><p>y creamos el archivo home.hbs en la carpeta views</p> <p>views/home.hbs:</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code><span class="token punctuation">&lt;</span><span class="token punctuation">!</span><span class="token variable">DOCTYPE</span> <span class="token variable">html</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">html</span> <span class="token variable">lang</span><span class="token punctuation">=</span><span class="token string">&quot;en&quot;</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">head</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">charset</span><span class="token punctuation">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">http-equiv</span><span class="token punctuation">=</span><span class="token string">&quot;X-UA-Compatible&quot;</span> <span class="token variable">content</span><span class="token punctuation">=</span><span class="token string">&quot;IE=edge&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;viewport&quot;</span> <span class="token variable">content</span><span class="token punctuation">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">title</span><span class="token punctuation">&gt;</span><span class="token variable">Document</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">title</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">head</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">body</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span><span class="token variable">Hola</span> <span class="token variable">desde</span> <span class="token variable">Home</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">body</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">html</span><span class="token punctuation">&gt;</span>

</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Nodemon no actualiza el servidor si hay algún cambio dentro de algún archivo hbs.</p> <p>Para solucionar esto creamos en la ruta raiz el archivo nodemon.json que va a contener:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;ext&quot;</span><span class="token operator">:</span> <span class="token string">&quot;js,json,hbs&quot;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>En pocas palabras , estamos configurando Nodemon para que detecte cambios en archivos .js , .json y .hbs.</p></div> <h2 id="configuracion"><a href="#configuracion" class="header-anchor">#</a> Configuracion</h2> <p>Ahora vamos a configurar el motor de plantilla en el archivo index.js</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// const create = recibe las configuraciones de express-handlebards</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> create <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-handlebars&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Le decimos que la extension de los archivos de views es  .hbs</span>
<span class="token keyword">const</span> hbs <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    extname<span class="token operator">:</span> <span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Configuramos express </span>
<span class="token comment">// Le decimos que motor de plantilla usar</span>
<span class="token comment">// Especificamos el motor de plantilla</span>
app<span class="token punctuation">.</span><span class="token function">engine</span><span class="token punctuation">(</span><span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">,</span> hbs<span class="token punctuation">.</span>engine<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Especificamos la extension del motor del plantilla (.hbs)</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;view engine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Especificamos la carpeta en donde van a estar los archivos .hbs</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;views&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./views&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">&quot;/public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Como respuesta renderiza(convierte en HTML) el archivo home.hbs</span>
    <span class="token comment">// Se puede quitar el .hbs</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">5000</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;server andando 🔥 http://localhost:5000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <ul><li>Como la carpeta public la maneja el middleware y este se ejecuta antes de que el servidor reciba las peticiones get/post/etc , lo que contiene la carpeta public se llama primero.</li> <li>La línea app.use(express.static(__dirname + &quot;/public&quot;)); debe ir debajo de todo para evitar conflictos entre las rutas y archivos publicos</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>

<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// const create = recibe las configuraciones de express-handlebards</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> create <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-handlebars&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Le decimos que la extension de los archivos de views es  .hbs</span>
<span class="token keyword">const</span> hbs <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    extname<span class="token operator">:</span> <span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Configuramos express </span>
<span class="token comment">// Le decimos que motor de plantilla usar</span>
<span class="token comment">// Especificamos el motor de plantilla</span>
app<span class="token punctuation">.</span><span class="token function">engine</span><span class="token punctuation">(</span><span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">,</span> hbs<span class="token punctuation">.</span>engine<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Especificamos la extension del motor del plantilla (.hbs)</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;view engine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Especificamos la carpeta en donde van a estar los archivos .hbs</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;views&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./views&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Como respuesta renderiza(convierte en HTML) el archivo home.hbs</span>
    <span class="token comment">// Se puede quitar el .hbs</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">&quot;/public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">5000</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;server andando 🔥 http://localhost:5000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div></div> <h2 id="main-hbs"><a href="#main-hbs" class="header-anchor">#</a> main.hbs</h2> <p>Como se ve, se muestra la plantilla (el archivo main.hbs) y no el home.hbs.</p> <p>Esto es porque , Se lee de forma automática el main.hbs</p> <p>La plantilla main.hbs se utiliza en todas las paginas</p> <p>Por lo tanto podemos hacer que lo que está en el home.hbs  aparezca adentro del body del main.hbs</p> <p>home.hbs:</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code> <span class="token punctuation">&lt;</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span><span class="token variable">Hola</span> <span class="token variable">desde</span> <span class="token variable">Home</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span>
</code></pre></div><p>main.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code><span class="token punctuation">&lt;</span><span class="token punctuation">!</span><span class="token variable">DOCTYPE</span> <span class="token variable">html</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">html</span> <span class="token variable">lang</span><span class="token punctuation">=</span><span class="token string">&quot;en&quot;</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">head</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">charset</span><span class="token punctuation">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">http-equiv</span><span class="token punctuation">=</span><span class="token string">&quot;X-UA-Compatible&quot;</span> <span class="token variable">content</span><span class="token punctuation">=</span><span class="token string">&quot;IE=edge&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;viewport&quot;</span> <span class="token variable">content</span><span class="token punctuation">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">title</span><span class="token punctuation">&gt;</span><span class="token variable">Desde</span> <span class="token variable">HBS</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">title</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">head</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">body</span><span class="token punctuation">&gt;</span>
      <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token variable">body</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">body</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">html</span><span class="token punctuation">&gt;</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">variable body</p> <p>Usamos la variable body  que tiene hbs , que su valor es todo lo que contiene  home.hbs</p></div> <p>Creamos un archivo login.hbs en views
views/login.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code><span class="token punctuation">&lt;</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span><span class="token variable">Login</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span>
</code></pre></div><p>index.js:</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// const create = recibe las configuraciones de express-handlebards</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> create <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-handlebars&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Le decimos que la extension de los archivos de views es  .hbs</span>
<span class="token keyword">const</span> hbs <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    extname<span class="token operator">:</span> <span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Configuramos express </span>
<span class="token comment">// Le decimos que motor de plantilla usar</span>
<span class="token comment">// Especificamos el motor de plantilla</span>
app<span class="token punctuation">.</span><span class="token function">engine</span><span class="token punctuation">(</span><span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">,</span> hbs<span class="token punctuation">.</span>engine<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Especificamos la extension del motor del plantilla (.hbs)</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;view engine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Especificamos la carpeta en donde van a estar los archivos .hbs</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;views&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./views&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Como respuesta renderiza(convierte en HTML) el archivo home.hbs</span>
    <span class="token comment">// Se puede quitar el .hbs</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Como respuesta renderiza(convierte en HTML) el archivo home.hbs</span>
    <span class="token comment">// Se puede quitar el .hbs</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">&quot;/public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">5000</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;server andando 🔥 http://localhost:5000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">variable body</p> <p>Al entrar a http://localhost:5000/login la variable body de main.hbs contiene  todo el contenido de login.hbs</p></div> <h2 id="css-js-etc"><a href="#css-js-etc" class="header-anchor">#</a> CSS , JS , etc</h2> <p>Añadimos boostrap a las dos rutas</p> <p>main.hbs:</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code><span class="token punctuation">&lt;</span><span class="token punctuation">!</span><span class="token variable">DOCTYPE</span> <span class="token variable">html</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">html</span> <span class="token variable">lang</span><span class="token punctuation">=</span><span class="token string">&quot;en&quot;</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">head</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">charset</span><span class="token punctuation">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">http-equiv</span><span class="token punctuation">=</span><span class="token string">&quot;X-UA-Compatible&quot;</span> <span class="token variable">content</span><span class="token punctuation">=</span><span class="token string">&quot;IE=edge&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;viewport&quot;</span> <span class="token variable">content</span><span class="token punctuation">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">title</span><span class="token punctuation">&gt;</span><span class="token variable">Desde</span> <span class="token variable">HBS</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">title</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">link</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css&quot;</span> <span class="token variable">rel</span><span class="token punctuation">=</span><span class="token string">&quot;stylesheet&quot;</span> <span class="token variable">integrity</span><span class="token punctuation">=</span><span class="token string">&quot;sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3&quot;</span> <span class="token variable">crossorigin</span><span class="token punctuation">=</span><span class="token string">&quot;anonymous&quot;</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">head</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">body</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;container mt-5&quot;</span><span class="token punctuation">&gt;</span>
 <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token variable">body</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>
     
      <span class="token punctuation">&lt;</span><span class="token variable">script</span> <span class="token variable">src</span><span class="token punctuation">=</span><span class="token string">&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js&quot;</span> <span class="token variable">integrity</span><span class="token punctuation">=</span><span class="token string">&quot;sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p&quot;</span> <span class="token variable">crossorigin</span><span class="token punctuation">=</span><span class="token string">&quot;anonymous&quot;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">script</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">body</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">html</span><span class="token punctuation">&gt;</span>

</code></pre></div><ul><li>Todas las paginas que tengamos, van a tener Bootstrap</li> <li>Y todo el contenido de XXX.hbs va a estar en un div que contiene clases de Bootstrap</li></ul> <div class="custom-block tip"><p class="custom-block-title">carpeta public</p> <ul><li>carpeta public = trabajar con el frontend = se muestra en el navegador</li> <li>el resto de carpetas(incluida la raiz) = trabajar con el backend</li></ul></div> <p>Invocar un script que esta en la carpeta public:</p> <p>public/js/script.js</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Hola&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>main.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code><span class="token punctuation">&lt;</span><span class="token punctuation">!</span><span class="token variable">DOCTYPE</span> <span class="token variable">html</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">html</span> <span class="token variable">lang</span><span class="token punctuation">=</span><span class="token string">&quot;en&quot;</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">head</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">charset</span><span class="token punctuation">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">http-equiv</span><span class="token punctuation">=</span><span class="token string">&quot;X-UA-Compatible&quot;</span> <span class="token variable">content</span><span class="token punctuation">=</span><span class="token string">&quot;IE=edge&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;viewport&quot;</span> <span class="token variable">content</span><span class="token punctuation">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">title</span><span class="token punctuation">&gt;</span><span class="token variable">Desde</span> <span class="token variable">HBS</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">title</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">link</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css&quot;</span> <span class="token variable">rel</span><span class="token punctuation">=</span><span class="token string">&quot;stylesheet&quot;</span> <span class="token variable">integrity</span><span class="token punctuation">=</span><span class="token string">&quot;sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3&quot;</span> <span class="token variable">crossorigin</span><span class="token punctuation">=</span><span class="token string">&quot;anonymous&quot;</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">head</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">body</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;container mt-5&quot;</span><span class="token punctuation">&gt;</span>
 <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token variable">body</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>
     
      <span class="token punctuation">&lt;</span><span class="token variable">script</span> <span class="token variable">src</span><span class="token punctuation">=</span><span class="token string">&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js&quot;</span> <span class="token variable">integrity</span><span class="token punctuation">=</span><span class="token string">&quot;sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p&quot;</span> <span class="token variable">crossorigin</span><span class="token punctuation">=</span><span class="token string">&quot;anonymous&quot;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">script</span><span class="token punctuation">&gt;</span>
      <span class="token punctuation">&lt;</span><span class="token variable">script</span> <span class="token variable">src</span><span class="token punctuation">=</span><span class="token string">&quot;/js/script.js&quot;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">script</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">body</span><span class="token punctuation">&gt;</span>

</code></pre></div><h2 id="each"><a href="#each" class="header-anchor">#</a> Each</h2> <ul><li>Vamos a usar los Block Helpers</li> <li><a href="https://handlebarsjs.com/guide/block-helpers.html#simple-iterators" target="_blank" rel="noopener noreferrer">Link<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Each  == forEach</li></ul> <p>home.hbs:</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code><span class="token punctuation">&lt;</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span><span class="token variable">Hola</span> <span class="token variable">desde</span> <span class="token variable">Home</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">#</span><span class="token variable">each</span> <span class="token variable">urls</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token punctuation">&lt;</span><span class="token variable">article</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;card mb-2&quot;</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;card-body&quot;</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">p</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token variable">this</span><span class="token punctuation">.</span><span class="token variable">origen</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">p</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">p</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token variable">this</span><span class="token punctuation">.</span><span class="token variable">shortUrl</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">p</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;#&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-danger&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Eliminar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;#&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-warning&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Editar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;#&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-info&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">copiar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">article</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">/</span><span class="token variable">each</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">carpeta Components</p> <p>Vamos a crear la carpeta components dentro de views que son pedazitos de código que se van a repetir (el código se suele repetir por medio de ciclos (each, etc))</p></div> <p>Y dentro de la carpeta creamos el archivo Card.hbs</p> <p>views/components/Card.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code><span class="token punctuation">&lt;</span><span class="token variable">article</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;card mb-2&quot;</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;card-body&quot;</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">p</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token variable">this</span><span class="token punctuation">.</span><span class="token variable">origen</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">p</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">p</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token variable">this</span><span class="token punctuation">.</span><span class="token variable">shortUrl</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">p</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;#&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-danger&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Eliminar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;#&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-warning&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Editar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;#&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-info&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">copiar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">article</span><span class="token punctuation">&gt;</span>

</code></pre></div><h2 id="configurar-partials"><a href="#configurar-partials" class="header-anchor">#</a> Configurar Partials</h2> <ul><li>partials = sirve para  separar trozos de hbs que se van a repetir. (ciclos (each) , menu , footer , etc)</li> <li>en el partials puede ir  footer.hbs , navbar.hbs , etc.</li></ul> <h3 id="configuracion-2"><a href="#configuracion-2" class="header-anchor">#</a> Configuracion</h3> <p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Le decimos que la extension de los archivos de views es  .hbs y que los partials se encuentran en views/components</span>
<span class="token keyword">const</span> hbs <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    extname<span class="token operator">:</span> <span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">,</span>
    partialsDir<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;views/components&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="llamar-a-un-partials"><a href="#llamar-a-un-partials" class="header-anchor">#</a> Llamar a un partials</h3> <p>Para llamar a un partial dentro de una plantilla</p> <p>home.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code>    <span class="token punctuation">&lt;</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span><span class="token variable">Hola</span> <span class="token variable">desde</span> <span class="token variable">Home</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">#</span><span class="token variable">each</span> <span class="token variable">urls</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
         <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">&gt;</span> <span class="token variable">Card</span>   <span class="token variable">url</span><span class="token punctuation">=</span><span class="token variable">this</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">/</span><span class="token variable">each</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
  

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Explicacion</p> <p>por cada iteración , invoca al Card.hbs  pasando como url cada componente del array urls</p></div> <p>Otra manera:
home.hbs:</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code>   <span class="token punctuation">&lt;</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span><span class="token variable">Hola</span> <span class="token variable">desde</span> <span class="token variable">Home</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">#</span><span class="token variable">each</span> <span class="token variable">urls</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
         <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">&gt;</span> <span class="token variable">Card</span>   <span class="token variable">item</span><span class="token punctuation">=</span><span class="token variable">this</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">/</span><span class="token variable">each</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
  

</code></pre></div><p>Card.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code> <span class="token punctuation">&lt;</span><span class="token variable">article</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;card mb-2&quot;</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;card-body&quot;</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">p</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token variable">item</span><span class="token punctuation">.</span><span class="token variable">origen</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">p</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">p</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token variable">item</span><span class="token punctuation">.</span><span class="token variable">shortUrl</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">p</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;#&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-danger&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Eliminar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;#&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-warning&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Editar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;#&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-info&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">copiar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">article</span><span class="token punctuation">&gt;</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <ul><li>Le podés quitar los datos opcionales (item=this o url=this) porque los datos del item del array se pasan solo al componente.</li> <li>A un componente nosotros le podemos mandar información , esto se llama props en react y vue.</li></ul></div> <p>Creamos un menú que lo va a utilizar todo el sitio web</p> <p>views/components/Navbar.hbs</p> <div class="custom-block tip"><p class="custom-block-title">Convenciones</p> <p>Los nombre de los componentes arrancan con Mayuscula.</p></div> <div class="language-hbs extra-class"><pre class="language-hbs"><code><span class="token punctuation">&lt;</span><span class="token variable">nav</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;navbar navbar-expand-lg navbar-dark bg-primary&quot;</span><span class="token punctuation">&gt;</span>
  <span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;container&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;navbar-brand&quot;</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Navbar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">button</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;navbar-toggler&quot;</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;button&quot;</span> <span class="token variable">data-bs-toggle</span><span class="token punctuation">=</span><span class="token string">&quot;collapse&quot;</span> <span class="token variable">data-bs-target</span><span class="token punctuation">=</span><span class="token string">&quot;#navbarNavAltMarkup&quot;</span> <span class="token variable">aria-controls</span><span class="token punctuation">=</span><span class="token string">&quot;navbarNavAltMarkup&quot;</span> <span class="token variable">aria-expanded</span><span class="token punctuation">=</span><span class="token string">&quot;false&quot;</span> <span class="token variable">aria-label</span><span class="token punctuation">=</span><span class="token string">&quot;Toggle navigation&quot;</span><span class="token punctuation">&gt;</span>
      <span class="token punctuation">&lt;</span><span class="token variable">span</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;navbar-toggler-icon&quot;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">span</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">button</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;collapse navbar-collapse&quot;</span> <span class="token variable">id</span><span class="token punctuation">=</span><span class="token string">&quot;navbarNavAltMarkup&quot;</span><span class="token punctuation">&gt;</span>
      <span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;navbar-nav ms-auto&quot;</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;nav-link active&quot;</span> <span class="token variable">aria-current</span><span class="token punctuation">=</span><span class="token string">&quot;page&quot;</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Home</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;nav-link&quot;</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;/logup&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">LogUp</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;nav-link&quot;</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">LogIn</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;nav-link&quot;</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;/logout&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">LogOut</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
      <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>
  <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">nav</span><span class="token punctuation">&gt;</span>

</code></pre></div><p>main.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code><span class="token punctuation">&lt;</span><span class="token punctuation">!</span><span class="token variable">DOCTYPE</span> <span class="token variable">html</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">html</span> <span class="token variable">lang</span><span class="token punctuation">=</span><span class="token string">&quot;en&quot;</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">head</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">charset</span><span class="token punctuation">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">http-equiv</span><span class="token punctuation">=</span><span class="token string">&quot;X-UA-Compatible&quot;</span> <span class="token variable">content</span><span class="token punctuation">=</span><span class="token string">&quot;IE=edge&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;viewport&quot;</span> <span class="token variable">content</span><span class="token punctuation">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">title</span><span class="token punctuation">&gt;</span><span class="token variable">Desde</span> <span class="token variable">HBS</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">title</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">link</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css&quot;</span> <span class="token variable">rel</span><span class="token punctuation">=</span><span class="token string">&quot;stylesheet&quot;</span> <span class="token variable">integrity</span><span class="token punctuation">=</span><span class="token string">&quot;sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3&quot;</span> <span class="token variable">crossorigin</span><span class="token punctuation">=</span><span class="token string">&quot;anonymous&quot;</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">head</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">body</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">&gt;</span> <span class="token variable">Navbar</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;container mt-5&quot;</span><span class="token punctuation">&gt;</span>
 <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token variable">body</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>
     
      <span class="token punctuation">&lt;</span><span class="token variable">script</span> <span class="token variable">src</span><span class="token punctuation">=</span><span class="token string">&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js&quot;</span> <span class="token variable">integrity</span><span class="token punctuation">=</span><span class="token string">&quot;sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p&quot;</span> <span class="token variable">crossorigin</span><span class="token punctuation">=</span><span class="token string">&quot;anonymous&quot;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">script</span><span class="token punctuation">&gt;</span>
      <span class="token punctuation">&lt;</span><span class="token variable">script</span> <span class="token variable">src</span><span class="token punctuation">=</span><span class="token string">&quot;/js/script.js&quot;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">script</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">body</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">html</span><span class="token punctuation">&gt;</span>

</code></pre></div><h2 id="router"><a href="#router" class="header-anchor">#</a> Router</h2> <p>Creamos la carpeta llamada routes</p> <p>Y dentro el archivo home.js</p> <div class="custom-block tip"><p class="custom-block-title">routes</p> <ul><li>Usamos el Router para crear manejadores de rutas modulares (permite trabajar en módulos )</li> <li>Sirve para poner la lógica de una o varias rutas en un archivo y poder separarlos (módulos), de forma que cada archivo es una ruta o un conjunto de rutas relacionadas.</li> <li>Lo recomendable es que cada archivo contenga la lógica de una  ruta para poder trabajar con módulos.</li></ul></div> <p>routes/home.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>origen<span class="token operator">:</span> <span class="token string">&quot;www.google.com&quot;</span> <span class="token punctuation">,</span> shortUrl<span class="token operator">:</span> <span class="token string">&quot;hfgdohdf&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>origen<span class="token operator">:</span> <span class="token string">&quot;www.google.com&quot;</span> <span class="token punctuation">,</span> shortUrl<span class="token operator">:</span> <span class="token string">&quot;hfgdohdf&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>origen<span class="token operator">:</span> <span class="token string">&quot;www.google.com&quot;</span> <span class="token punctuation">,</span> shortUrl<span class="token operator">:</span> <span class="token string">&quot;hfgdohdf&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home'</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span>urls <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>

</code></pre></div><p>Tambien creamos el archivo auth.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <p>Como se puede ver cada archivo es una ruta (home = al apartado home  y auth.js = al apartado login)</p></div> <p>en el index.js</p> <p>Se utiliza el  middleware para usar el router</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> create <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-handlebars&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> hbs <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    extname<span class="token operator">:</span> <span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">,</span>
    partialsDir<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;views/components&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">engine</span><span class="token punctuation">(</span><span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">,</span> hbs<span class="token punctuation">.</span>engine<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;view engine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;views&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./views&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>




app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">&quot;/public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Usamos el middleware para utilizar los routes</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/home'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;/auth&quot;</span> <span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/auth'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">5000</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;server andando 🔥 http://localhost:5000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Resultado del middleware</p> <ul><li>Home =  http://localhost:5000   (No se utilizo ninguno prefijo (/))</li> <li>Login =  http://localhost:5000/auth/login (Ya que se añadio el prefijo /auth)</li></ul></div> <p>Cambiamos las rutas en el navbar.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code> <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;nav-link&quot;</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;/logup&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">LogUp</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;nav-link&quot;</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;/auth/login&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">LogIn</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;nav-link&quot;</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;/logout&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">LogOut</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>

</code></pre></div><h2 id="configuracion-mongodb"><a href="#configuracion-mongodb" class="header-anchor">#</a> Configuracion mongoDB</h2> <h3 id="en-el-sitio-de-mongodb"><a href="#en-el-sitio-de-mongodb" class="header-anchor">#</a> En el sitio de MongoDB</h3> <ol><li>Creamos un Cluster</li></ol> <ul><li>Database – Build a Database – Shared – Free</li> <li>Todas las configuraciones dejarla por defecto.</li> <li>Por ultimo le das a Create Cluster</li></ul> <ol start="2"><li>En network access especificamos las IP de donde nos queremos conectar</li></ol> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Puede ser:</p> <ul><li>nuestra IP (para mayor seguridad)</li> <li>Permitir que se pueda conectar desde cualquier ip(0.0.0.0)</li> <li>Un conjunto de IP (la nuestra y la de un servidor/hosting)</li></ul></div> <ol start="3"><li>En DataBase Access Creamos un usuario</li></ol> <div class="custom-block tip"><p class="custom-block-title">Ejemplo</p> <p>User: User_API
password: contraseña</p></div> <ul><li>Built-in Role para  configurar  el Rol (Accesos)</li></ul> <div class="custom-block tip"><p class="custom-block-title">VERSION GRATIS</p> <ul><li>En el modo gratuito solo podemos tener un cluster</li> <li>Un cluster es como un servidor y puede tener varias BD</li> <li>En un cluster podemos tener muchas colecciones.</li></ul></div> <p>4.Database – Connect – Connect your app</p> <ul><li>Copiamos el uri</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>mongodb<span class="token operator">+</span>srv<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token operator">&lt;</span>username<span class="token operator">&gt;</span><span class="token operator">:</span><span class="token operator">&lt;</span>password<span class="token operator">&gt;</span>@cluster<span class="token punctuation">.</span>xcibc<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>net<span class="token operator">/</span>myFirstDatabase<span class="token operator">?</span>retryWrites<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>w<span class="token operator">=</span>majority

<span class="token comment">/*
- Borramos &lt;Username&gt; y ponemos  el usuario por el cual nos conectamos
- Borramos &lt;password&gt; y ponemos la contraseña del usuario
- Borramos miFirstDateBase y ponemos el nombre de la BD a conectarse
*/</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Ejemplo</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">URI</span><span class="token operator">:</span>mongodb<span class="token operator">+</span>srv<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>User_API<span class="token operator">:</span>contraseña@cluster<span class="token punctuation">.</span>xcibc<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>net<span class="token operator">/</span>dbUrl<span class="token operator">?</span>retryWrites<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>w<span class="token operator">=</span>majority
</code></pre></div></div> <h3 id="en-el-proyecto"><a href="#en-el-proyecto" class="header-anchor">#</a> En el proyecto</h3> <p>Creamos el archivo .gitignore</p> <div class="language-gitignore extra-class"><pre class="language-gitignore"><code><span class="token entry string">node_modules</span>
<span class="token entry string">.env</span>
</code></pre></div><p>Creamos el archivo .env</p> <div class="custom-block tip"><p class="custom-block-title">.env</p> <ul><li>En dicho archivo creamos variables protegidas que no se pueden subir a la nube  (github)</li> <li>Sirven para no exponer informacion privada</li> <li>Son variables de entorno</li> <li>Sintaxis: nombrevariable=valor</li></ul></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">URI</span><span class="token operator">=</span>mongodb<span class="token operator">+</span>srv<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>User_API<span class="token operator">:</span>contraseña@cluster<span class="token punctuation">.</span>xcibc<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>net<span class="token operator">/</span>dbUrl<span class="token operator">?</span>retryWrites<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>w<span class="token operator">=</span>majority
</code></pre></div><p>Reiniciamos Nodemon ya que no lee el archivo.</p> <h3 id="modulos"><a href="#modulos" class="header-anchor">#</a> modulos</h3> <ul><li>Para manejar  MongoDb dentro de node.js usaremos mongosee</li> <li>el –save es para versiones antiguas de npm</li></ul> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm install mongoose
</code></pre></div><p>Y para manejar las variables de entorno usaremos dotenv</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm i dotenv
</code></pre></div><h3 id="establecer-conexion"><a href="#establecer-conexion" class="header-anchor">#</a> Establecer conexion</h3> <p>Creamos la carpeta datebase</p> <p>Y dentro el archivo conexión.js(Realizaremos la conexión en dicho archivo)</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Para conectarnos a la BD</span>
<span class="token comment">//connect (uri con los datos remplazados)</span>
<span class="token comment">// Accedemos al valor de la variable URI de .env</span>
<span class="token comment">// Sintaxis: process.env.NOMBREVARIABLE</span>

mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">URI</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Como devuelve una promesa , usamos el then</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;'db conectada 🔥&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Fallo la conexion&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>Lo llamamos en el index.js:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> create <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-handlebars&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Para leer las variables de entorno (para acceder a las variables de .env)</span>
 <span class="token comment">// config(configuraciones) -- Las configuraciones pueden ser desde cambiar el nombre del archivo .env a otras opciones</span>
 <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// Ejecutamos el archivo database/conexion.js</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./database/conexion'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> hbs <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    extname<span class="token operator">:</span> <span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">,</span>
    partialsDir<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;views/components&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="volvemos-a-mongodb-sitio-web"><a href="#volvemos-a-mongodb-sitio-web" class="header-anchor">#</a> Volvemos a MongoDB(sitio web)</h3> <ul><li>Database – Cluster -- Browse Collections</li> <li>Te va a mostrar todas las BD.</li> <li>Si le das a Create Database , Creas una colección que va a pertenecer a una BD.</li></ul> <div class="custom-block tip"><p class="custom-block-title">Explicacion</p> <ul><li>Una colección tiene múltiples documentos. Lo podes insertar con la opcion insert document  (El documento funciona igual que un objeto de JS propiedad:valor)</li> <li>El documento es un objeto de JS (con multiples metodos)</li> <li>Una BD puede tener múltiples colleciones.</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">Explicacion como si fuera relacional</p> <ul><li>Collecion = tabla</li> <li>Documento = Fila de la tabla</li> <li>Y cada propiedad del documento es una columna.</li></ul></div> <h2 id="modelo-esquema"><a href="#modelo-esquema" class="header-anchor">#</a> Modelo/Esquema</h2> <ul><li>Las colecciones van a tener documentos</li> <li>Y esos documentos están compuesto de varias propiedades con sus valores correspondiente.</li></ul> <div class="custom-block tip"><p class="custom-block-title">Modelo</p> <ul><li>En un modelo definimos el nombre de la colección y las propiedades(columnas) que van a tener sus documentos(filas)</li> <li>A traves del modelo tenemos acceso a métodos  para crear/modificar/leer/etc documentos.</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">Esquema</p> <ul><li>Con Mongoose, todo se deriva de un esquema</li> <li>Cada esquema se asigna a una colección MongoDB y define la forma de los documentos dentro de esa colección.</li> <li>El esquema define la estructura de los documentos.</li></ul></div> <h3 id="en-el-proyecto-2"><a href="#en-el-proyecto-2" class="header-anchor">#</a> En el proyecto</h3> <p>Creamos la carpeta models</p> <ul><li>En dicha carpeta vamos a crear los modelos</li> <li>cremos el archivo Url.js en la carpeta</li></ul> <div class="custom-block tip"><p class="custom-block-title">ID</p> <p>La ID se genera de manera automática , por eso no la especificamos.</p></div> <div class="custom-block tip"><p class="custom-block-title">Generar String aleatorios</p> <ul><li>Vamos a usar <a href="https://www.npmjs.com/package/nanoid" target="_blank" rel="noopener noreferrer">nanoid<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> para crear ids aleatorios</li> <li>npm i nanoid</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">Explicacion</p> <ul><li>Para tener acceso a los métodos  para crear/modificar/leer/etc documentos , debemos crear un esquema y llevarlo a  un modelo.</li> <li>Se exporta el modelo no el esquema</li> <li>el esquema sirve para crear el modelo</li> <li>esquema = estructura del documento</li> <li>modelo = creado a partir del esquema , permite tener acceso a los métodos para el CRUD.</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Al crearse un objeto de tipo  modelo(el que se crea), se crea la colección y la BD (si no existe)</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>
<span class="token comment">// Obtenemos la clase Schema de mongosee</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Schema<span class="token punctuation">}</span> <span class="token operator">=</span> mongoose
<span class="token keyword">const</span> <span class="token punctuation">{</span>nanoid<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'nanoid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Esquema</span>
<span class="token comment">// Nueva instancia(objeto) de Schema</span>
<span class="token comment">// El schema recibe un objeto con las propiedades que va a tener cada documento  y sus restricciones.</span>
<span class="token keyword">const</span> urlSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>

    origin<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// La propiedad origen es de tipo String  , es unico , y es obligatorio</span>
        type<span class="token operator">:</span> String<span class="token punctuation">,</span>
        unique<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    shortURL<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// La propiedad shortURL  es de tipo String , es unico , y es obligatorio.</span>
        type<span class="token operator">:</span> String<span class="token punctuation">,</span>
        unique<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token comment">// Por defecto su valor es un String aleatorio (supuestamente unico)</span>
        <span class="token comment">//nanoid(numero(representa el largo del string)) genera un string aleatorio</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token function">nanoid</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//Modelo</span>
<span class="token comment">// Singular y comienza en Mayuscula -- variable</span>
<span class="token comment">// models (nombre de la coleccion , esquema)</span>
<span class="token comment">// Si la coleccion no existe , se crea tanto la BD como la coleccion(en plural)</span>
<span class="token keyword">const</span> Url <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Url'</span><span class="token punctuation">,</span> urlSchema<span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Url<span class="token punctuation">;</span>

</code></pre></div><h2 id="controladores-mvc"><a href="#controladores-mvc" class="header-anchor">#</a> Controladores (MVC)</h2> <ul><li>Para trabajar  con el modelo vista – controlador</li> <li>creamos la carpeta controllers y  dentro el archivo homeController.js</li> <li>En dicho archivo vamos a tener toda la lógica de leer, actualizar, agregar, etc de la ruta Home</li> <li>En el modelo vista – controlador, la lógica debe separarse.</li></ul> <p>controllers/homeController.js:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">leerUrls</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>origen<span class="token operator">:</span> <span class="token string">&quot;www.google.com&quot;</span> <span class="token punctuation">,</span> shortUrl<span class="token operator">:</span> <span class="token string">&quot;hfgdohdf&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>origen<span class="token operator">:</span> <span class="token string">&quot;www.google.com&quot;</span> <span class="token punctuation">,</span> shortUrl<span class="token operator">:</span> <span class="token string">&quot;hfgdohdf&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>origen<span class="token operator">:</span> <span class="token string">&quot;www.google.com&quot;</span> <span class="token punctuation">,</span> shortUrl<span class="token operator">:</span> <span class="token string">&quot;hfgdohdf&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home'</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span>urls <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

   module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>leerUrls<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>routes/home.js:</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>leerUrls<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controllers/homeController'</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token punctuation">,</span> leerUrls<span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">MVC</p> <ul><li>Modelo vista controlador</li> <li>controladores – modelo – vistas -routes – database</li></ul></div> <p>Hacemos el agregarUrl</p> <p>homeController.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">agregarUrl</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
   module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>leerUrls <span class="token punctuation">,</span> agregarUrl<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>routes/home.js</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token punctuation">,</span> agregarUrl<span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</code></pre></div><h2 id="instanciar-un-modelo"><a href="#instanciar-un-modelo" class="header-anchor">#</a> Instanciar un modelo</h2> <p>Creamos un componente llamado Form.hbs</p> <p>components/Form.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code><span class="token punctuation">&lt;</span><span class="token variable">form</span> <span class="token variable">action</span><span class="token punctuation">=</span><span class="token string">&quot;/&quot;</span> <span class="token variable">method</span><span class="token punctuation">=</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">input</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;text&quot;</span> <span class="token variable">placeholder</span><span class="token punctuation">=</span><span class="token string">&quot;Ingrese URL&quot;</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;origin&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;form-control my-2&quot;</span><span class="token punctuation">&gt;</span>
 <span class="token punctuation">&lt;</span><span class="token variable">button</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;submit&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-primary w-100 mb-2&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Agregar</span> <span class="token variable">Url</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">button</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">form</span><span class="token punctuation">&gt;</span>

</code></pre></div><p>views/home.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code>  <span class="token punctuation">&lt;</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span><span class="token variable">Agrege</span> <span class="token variable">sus</span> <span class="token variable">URL</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">&gt;</span> <span class="token variable">Form</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">#</span><span class="token variable">each</span> <span class="token variable">urls</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
         <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">&gt;</span> <span class="token variable">Card</span>   <span class="token variable">item</span><span class="token punctuation">=</span><span class="token variable">this</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">/</span><span class="token variable">each</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

</code></pre></div><p>homeController.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Importamos el modelo</span>
<span class="token keyword">const</span> Url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../models/Url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">agregarUrl</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Creamos una instancia(objeto) del modelo</span>
        <span class="token comment">// new Modelo({propiedades del esquema})</span>
        <span class="token comment">//shortUrl tiene un valor por defecto , no hace falta mandarlo</span>
       <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Url</span><span class="token punctuation">(</span><span class="token punctuation">{</span>origin<span class="token operator">:</span><span class="token string">'estatico'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;error algo fallo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
   module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>leerUrls <span class="token punctuation">,</span> agregarUrl<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Explicacion</p> <ul><li>Al momento de instanciar un Modelo, se crea la BD y la colección.</li> <li>La instancia es un objeto (documento mongoDB) con todas las propiedades del esquema.</li></ul></div> <h2 id="guardar-en-la-bd"><a href="#guardar-en-la-bd" class="header-anchor">#</a> Guardar en la BD</h2> <p>modificamos el archivo homeController.js para que al documento mongoDB creado (instancia) se guarde en la BD.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">agregarUrl</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token comment">// Creamos una instancia(objeto) del modelo</span>
       <span class="token comment">// new Modelo({propiedades del esquema})</span>
       <span class="token comment">//shortUrl tiene un valor por defecto , no hace falta mandarlo</span>
      <span class="token comment">// La ID se crea por defecto , no hace falta mandarlo</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Url</span><span class="token punctuation">(</span><span class="token punctuation">{</span>origin<span class="token operator">:</span><span class="token string">'estatico'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// Lo guardamos en la BD // Insertamos un documento(fila) en la colección(tabla)</span>
      <span class="token keyword">await</span> url<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Direcciono a la pagina raiz</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
       res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;error algo fallo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>leerUrls <span class="token punctuation">,</span> agregarUrl<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="ahora-vamos-a-hacer-que-se-guarde-en-la-bd-la-informacion-que-se-envia-en-el-formulario"><a href="#ahora-vamos-a-hacer-que-se-guarde-en-la-bd-la-informacion-que-se-envia-en-el-formulario" class="header-anchor">#</a> Ahora vamos a hacer que se guarde en la BD, la información que se envía en el formulario:</h3> <ol><li>Configuramos el middleware para que se pueda leer el body, ya que el formulario utiliza el método POST</li></ol> <p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Habilitamos los formularios html POST</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span>extended<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre></div><ol start="2"><li>Configuramos homeController.js para que añada el dato enviado del formulario a la BD.</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">agregarUrl</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token comment">// La informacion enviada por el formulario</span>
   <span class="token keyword">const</span> <span class="token punctuation">{</span>origin<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token comment">// Creamos una instancia(objeto) del modelo</span>
       <span class="token comment">// new Modelo({propiedades del esquema})</span>
       <span class="token comment">//shortUrl tiene un valor por defecto , no hace falta mandarlo</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Url</span><span class="token punctuation">(</span><span class="token punctuation">{</span>origin<span class="token operator">:</span>origin <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// Lo guardamos en la BD // Insertamos un documento(fila) en la colección(tabla)</span>
      <span class="token keyword">await</span> url<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Direcciono a la pagina raiz</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
       res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;error algo fallo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><ol start="3"><li>Movemos la funcion nanoid() al homeController para que no genere conflictos ya que genera el mismo shortUrl para todos los documentos y no deja guardar mas de 2 veces</li></ol> <p>homeController.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Importamos el modelo</span>
<span class="token keyword">const</span> Url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../models/Url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>nanoid<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'nanoid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">agregarUrl</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token comment">// La informacion enviada por el formulario</span>
   <span class="token keyword">const</span> <span class="token punctuation">{</span>origin<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token comment">// Creamos una instancia(objeto) del modelo</span>
       <span class="token comment">// new Modelo({propiedades del esquema})</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Url</span><span class="token punctuation">(</span><span class="token punctuation">{</span>origin<span class="token operator">:</span>origin <span class="token punctuation">,</span> shortURL<span class="token operator">:</span><span class="token function">nanoid</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
       <span class="token comment">// Lo guardamos en la BD // Insertamos un documento(fila) en la colección(tabla)</span>

      <span class="token keyword">await</span> url<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Direcciono a la pagina raiz</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
       res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;error algo fallo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>leerUrls <span class="token punctuation">,</span> agregarUrl<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>models/Url.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Esquema</span>
<span class="token comment">// Nueva instancia(objeto) de Schema</span>
<span class="token comment">// El schema recibe un objeto con las propiedades que va a tener cada documento  y sus restricciones.</span>
<span class="token keyword">const</span> urlSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>

   origin<span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token comment">// La propiedad origen es de tipo String  , es unico , y es obligatorio</span>
       type<span class="token operator">:</span> String<span class="token punctuation">,</span>
       unique<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
       required<span class="token operator">:</span> <span class="token boolean">true</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   shortURL<span class="token operator">:</span> <span class="token punctuation">{</span>
     <span class="token comment">// La propiedad shortURL  es de tipo String , es unico , y es obligatorio.</span>
       type<span class="token operator">:</span> String<span class="token punctuation">,</span>
       unique<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
       required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><h2 id="leer-datos"><a href="#leer-datos" class="header-anchor">#</a> Leer datos</h2> <p>Ahora vamos a hacer que se muestre la informacion de la BD en la pagina de inicio(home)</p> <p>views/components/Card.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code> <span class="token punctuation">&lt;</span><span class="token variable">article</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;card mb-2&quot;</span><span class="token punctuation">&gt;</span>
       <span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;card-body&quot;</span><span class="token punctuation">&gt;</span>
           <span class="token punctuation">&lt;</span><span class="token variable">p</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token variable">this</span><span class="token punctuation">.</span><span class="token variable">origin</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">p</span><span class="token punctuation">&gt;</span>
           <span class="token punctuation">&lt;</span><span class="token variable">p</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token variable">this</span><span class="token punctuation">.</span><span class="token variable">shortURL</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">p</span><span class="token punctuation">&gt;</span>
           <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;#&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-danger&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Eliminar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
           <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;#&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-warning&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Editar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
           <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;#&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-info&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">copiar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
       <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>
   <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">article</span><span class="token punctuation">&gt;</span>

</code></pre></div><p>controllers/homeController.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">leerUrls</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// find() Busca todos los documentos de la coleccion(modelo)</span>
      <span class="token comment">// Select * from coleccion</span>
      <span class="token comment">// coleccion es el nombre del modelo</span>
     <span class="token comment">// Devuelve un array con objetos de mongoDB</span>
     <span class="token comment">//lean() convierte un objeto de mongoDB en un objeto JS</span>
     <span class="token keyword">const</span> urls <span class="token operator">=</span> <span class="token keyword">await</span> Url<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">//urls:urls</span>
     res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home'</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span>urls<span class="token operator">:</span>urls <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'fallo algo...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

   <span class="token punctuation">}</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">opcion Lean</p> <ul><li><p>La opción Lean le dice a Mongoose que omita la hidratación de los documentos que contiene el  resultado de la consulta. Esto hace que las consultas sean más rápidas y requieran menos memoria, pero los documentos se convierten en simples objetos JavaScript, no documentos Mongoose(objeto mongoDB)</p></li> <li><p>Cuando  guardamos un documento en la base de datos, usamos el método save() de  la instancia del modelo. El método save() pertenece a un objeto mongoDB(instancia del modelo) , esa es la diferencia entre un documento como objeto js (usando lean) y un documento como objeto mongoDB.</p></li> <li><p>un objeto mongoDB === instancia del modelo</p></li> <li><p>La opcion Lean le quita todos los metodos que contiene una instancia del Modelo  . Ej. le quita el metodo save()</p></li></ul></div> <div class="custom-block tip"><p class="custom-block-title">hidratacion</p> <ul><li>La hidratación se refiere al proceso de llenar un objeto con datos. Un objeto que aún no se ha hidratado se ha instanciado y representa una entidad que sí tiene datos, pero los datos aún no se han cargado en el objeto. Esto es algo que se hace por razones de rendimiento.</li> <li>Se podría decir que un objeto está parcialmente hidratado cuando solo ha cargado algunos de los campos, pero no todos. Esto se puede hacer porque esos otros campos no son necesarios para sus operaciones actuales. Por lo tanto, no hay razón para desperdiciar el ancho de banda y los ciclos de CPU cargando, transfiriendo y configurando estos datos cuando no se van a usar.</li></ul></div> <h2 id="eliminar-datos"><a href="#eliminar-datos" class="header-anchor">#</a> Eliminar datos</h2> <p>Ahora vamos a permitir que se puedan eliminar documentos en la BD:</p> <ul><li><a href="https://mongoosejs.com/docs/api.html#model_Model.findByIdAndDelete" target="_blank" rel="noopener noreferrer">Info<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <ul><li>Forma no muy recomendada (utilizar peticion GET)</li> <li>Lo ideal seria utilizar una petición DELETE ,  NO GET pero en HTML solo se puede hacer GET y POST</li></ul></div> <p>views/components/Card.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code> <span class="token punctuation">&lt;</span><span class="token variable">article</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;card mb-2&quot;</span><span class="token punctuation">&gt;</span>
       <span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;card-body&quot;</span><span class="token punctuation">&gt;</span>
           <span class="token punctuation">&lt;</span><span class="token variable">p</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token variable">this</span><span class="token punctuation">.</span><span class="token variable">origin</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">p</span><span class="token punctuation">&gt;</span>
           <span class="token punctuation">&lt;</span><span class="token variable">p</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token variable">this</span><span class="token punctuation">.</span><span class="token variable">shortURL</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">p</span><span class="token punctuation">&gt;</span>
           <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;/eliminar/{{item._id}}&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-danger&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Eliminar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
           <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;#&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-warning&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Editar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
           <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;#&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-info&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">copiar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
       <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>
   <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">article</span><span class="token punctuation">&gt;</span>

</code></pre></div><p>routes/home.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// NO RECOMENDADO , para eliminacion informacion se usa el metodo DELETE</span>
<span class="token comment">// usar los dos puntos (:) para asignar una variable</span>
<span class="token comment">//ruta /eliminar/:nombrevariable</span>
<span class="token comment">//ruta /eliminar/valornombrevariable</span>
<span class="token comment">// Ejemplo: /eliminar/6220bd6df4eaa23f425ac827</span>
<span class="token comment">// nombrevariable  =  6220bd6df4eaa23f425ac827</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/eliminar/:id&quot;</span> <span class="token punctuation">,</span> eliminarUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>

</code></pre></div><p>homeController.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">eliminarUrl</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// en req.params estan todas las variables  de rutas(:nombrevariable) y sus valores correspondiente</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Busca una coleccion por la ID y lo elimina</span>
       <span class="token keyword">await</span> Url<span class="token punctuation">.</span><span class="token function">findByIdAndDelete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
       res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
         res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;error algo fallo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

   module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>leerUrls <span class="token punctuation">,</span> agregarUrl <span class="token punctuation">,</span> eliminarUrl<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="validacion-con-middlewares"><a href="#validacion-con-middlewares" class="header-anchor">#</a> Validacion con middlewares</h2> <div class="custom-block tip"><p class="custom-block-title">middlewares</p> <ul><li>Intercepta la petición antes de la respuesta del servidor (gestión de rutas), incluso antes de que lo analice el servidor.</li> <li>Se suele usar para las validaciones y autenticaciones.</li> <li>Un middleware es una función con tres parámetros (req , res , next)</li> <li>next = Siga con la siguiente solicitud, que la petición pase a otro middleware o que llegue al servidor.</li> <li>Se podría decir que el middleware es un cortafuego y si la petición es válida, pasa al servidor para ser tratada.</li></ul> <p>En caso que la petición no sea válida, nunca llega al servidor , sin embargo el middleware le envía una respuesta al cliente.</p></div> <p>Creamos la carpeta middlewares y Adentro urlValida.js</p> <p>Para validar una Url</p> <ul><li><a href="https://nodejs.org/api/url.html#class-url" target="_blank" rel="noopener noreferrer">Usamos este modulo nativo de node.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <div class="language-js extra-class"><pre class="language-js"><code> 
 <span class="token comment">// Modulo que viene incorporado con Node.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">URL</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">urlValidar</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res <span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token comment">// Si todo esta correcto llamamos a next</span>
 <span class="token comment">// next = eliminarUrl</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Leo el body del formulario</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> origin <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
        <span class="token comment">// Se crea una nueva instancia de URL con la informacion del formulario</span>
        <span class="token keyword">const</span> urlFrontend <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//La instancia(objeto) tiene la propiedad origin</span>
        <span class="token comment">//Si es distinto a null , tiene el formato de url</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>urlFrontend<span class="token punctuation">.</span>origin <span class="token operator">!==</span> <span class="token string">&quot;null&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Comprueba que tenga el protocolo http o https y si lo tiene llama al next()</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>
                urlFrontend<span class="token punctuation">.</span>protocol <span class="token operator">===</span> <span class="token string">&quot;http:&quot;</span> <span class="token operator">||</span>
                urlFrontend<span class="token punctuation">.</span>protocol <span class="token operator">===</span> <span class="token string">&quot;https:&quot;</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Lanzamos un error en caso que no sea valida</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;no válida 😲&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// console.log(error);</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;url no valida&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> urlValidar<span class="token punctuation">;</span>

</code></pre></div><p>routes/home.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//Cuando se entra a la ruta , se ejecuta el middleware (urlValida).</span>
<span class="token comment">// El middleware lo analiza, si la peticion es valida, envia la peticion al agregarUrl(req,res)(pasa al siguiente - next).</span>
<span class="token comment">// En caso que la petición es invalida , el middleware se encarga de responder a la peticion</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token punctuation">,</span> urlValida <span class="token punctuation">,</span> agregarUrl<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/eliminar/:id&quot;</span>  <span class="token punctuation">,</span> eliminarUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>

</code></pre></div><h2 id="editar-en-mongodb"><a href="#editar-en-mongodb" class="header-anchor">#</a> Editar en MongoDB</h2> <ul><li><a href="https://mongoosejs.com/docs/queries.html" target="_blank" rel="noopener noreferrer">Info<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Se hace con el método HTTP PUT pero en este ejemplo se realizara con GET (NO RECOMENDADO)</p></div> <p>routes/home.js</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/eliminar/:id&quot;</span>  <span class="token punctuation">,</span> eliminarUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/editar/:id&quot;</span><span class="token punctuation">,</span> editarUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>

</code></pre></div><p>homeController.js</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> <span class="token function-variable function">editarUrl</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//variable id de la ruta</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// En la coleccion(modelo) buscamos un documento cuya id sea igual al valor de la variable const id</span>
        <span class="token comment">// Como nos trae un objeto mongoDB lo convertirmos en un objeto JS con lean()</span>
       <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">await</span> Url<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lean</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       
       <span class="token comment">// {url:url}</span>
       <span class="token comment">// el each del home.hbs ni se va a ejecutar ya que no le estamos pasando un array</span>
       res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>url<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;error algo fallo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
   module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>leerUrls <span class="token punctuation">,</span> agregarUrl <span class="token punctuation">,</span> eliminarUrl <span class="token punctuation">,</span> editarUrl<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>En views/components/Card.hbs Modificamos el atributo href de editar</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code>    <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;/editar/{{item._id}}&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-warning&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Editar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
</code></pre></div><p>en views/components/Form.hbs</p> <div class="custom-block tip"><p class="custom-block-title">logica</p> <p>Si existe url , crea una formulario para editar , si no existe crea el formulario para crear.</p></div> <div class="language-hbs extra-class"><pre class="language-hbs"><code><span class="token delimiter punctuation">{{</span><span class="token block keyword">#if</span> <span class="token variable">url</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
   <span class="token punctuation">&lt;</span><span class="token variable">form</span> <span class="token variable">action</span><span class="token punctuation">=</span><span class="token string">&quot;/editar/{{url._id}}&quot;</span> <span class="token variable">method</span><span class="token punctuation">=</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">input</span>  <span class="token variable">value</span><span class="token punctuation">=</span><span class="token string">&quot;{{url.origin}}&quot;</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;text&quot;</span> <span class="token variable">placeholder</span><span class="token punctuation">=</span><span class="token string">&quot;Ingrese URL&quot;</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;origin&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;form-control my-2&quot;</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">button</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;submit&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-warning w-100 mb-2&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Editar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">button</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">form</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token variable">else</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">&lt;</span><span class="token variable">form</span> <span class="token variable">action</span><span class="token punctuation">=</span><span class="token string">&quot;/&quot;</span> <span class="token variable">method</span><span class="token punctuation">=</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">input</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;text&quot;</span> <span class="token variable">placeholder</span><span class="token punctuation">=</span><span class="token string">&quot;Ingrese URL&quot;</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;origin&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;form-control my-2&quot;</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">button</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;submit&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-primary w-100 mb-2&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Agregar</span> <span class="token variable">Url</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">button</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">form</span><span class="token punctuation">&gt;</span>

<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">/</span><span class="token variable">if</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

</code></pre></div><p>home.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>leerUrls <span class="token punctuation">,</span> agregarUrl <span class="token punctuation">,</span> eliminarUrl <span class="token punctuation">,</span> editarUrlForm <span class="token punctuation">,</span> editarUrl<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controllers/homeController'</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token punctuation">,</span> leerUrls<span class="token punctuation">)</span>
<span class="token comment">//Cuando se entra a la ruta , se ejecuta el middleware (urlValida).</span>
<span class="token comment">// Si el middleware detecta que la  peticion es valida, envia la peticion a agregarUrl(req,res)(al siguiente - next)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token punctuation">,</span> urlValida <span class="token punctuation">,</span> agregarUrl<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/eliminar/:id&quot;</span>  <span class="token punctuation">,</span> eliminarUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/editar/:id&quot;</span><span class="token punctuation">,</span> editarUrlForm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Utiliza el middleware</span>
<span class="token comment">// Si la url es valida , la petición la gestiona editarUrl(req,res)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/editar/:id&quot;</span> <span class="token punctuation">,</span>urlValida <span class="token punctuation">,</span>  editarUrl<span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>

</code></pre></div><p>homeController.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Importamos el modelo</span>
<span class="token keyword">const</span> Url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../models/Url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>nanoid<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'nanoid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">leerUrls</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// find(parametros opcionales) Busca todos los documentos de la coleccion(modelo)</span>
      <span class="token comment">// Select * from coleccion</span>
     <span class="token comment">// Puede tener parametros para filtrar documentos</span>
     <span class="token comment">// Devuelve un array con objetos de mongoDB</span>
     <span class="token comment">//lean() convierte un objeto de mongoDB en un objeto JS</span>
     <span class="token keyword">const</span> urls <span class="token operator">=</span> <span class="token keyword">await</span> Url<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">//urls:urls</span>
     res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home'</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span>urls<span class="token operator">:</span>urls <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'fallo algo...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

   <span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">agregarUrl</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> <span class="token punctuation">{</span>origin<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Url</span><span class="token punctuation">(</span><span class="token punctuation">{</span>origin<span class="token operator">:</span>origin <span class="token punctuation">,</span> shortURL<span class="token operator">:</span><span class="token function">nanoid</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">await</span> url<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
       res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;error algo fallo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">eliminarUrl</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token comment">// en req.params estan todas las variables  de ruta(:nombrevariable) y sus valores correspondiente</span>
   <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token comment">// Busca una coleccion por la ID y lo elimina</span>
      <span class="token keyword">await</span> Url<span class="token punctuation">.</span><span class="token function">findByIdAndDelete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;error algo fallo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">editarUrlForm</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token comment">//variable id de la ruta</span>
   <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token comment">// En la coleccion(modelo) buscamos un documento cuya id sea igual al valor de la variable const id</span>
       <span class="token comment">// Como nos trae un objeto mongoDB lo convertirmos en un objeto JS con lean()</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">await</span> Url<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lean</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      
      <span class="token comment">// {url:url}</span>
      <span class="token comment">// el each del home.hbs ni se va a ejecutar ya que no le estamos pasando un array</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>url<span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
       res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;error algo fallo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">editarUrl</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token comment">//variable id de la ruta</span>
   <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
   <span class="token keyword">const</span> <span class="token punctuation">{</span>origin<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token comment">// Buscamos el documento por la id y lo actualizamos</span>
       <span class="token comment">//findByIdAndUpdate(id , {informacion a modificar} )</span>
       <span class="token comment">// origin : origin</span>
      <span class="token keyword">await</span> Url<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>origin<span class="token punctuation">}</span><span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   
   <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
       res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;error algo fallo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>leerUrls <span class="token punctuation">,</span> agregarUrl <span class="token punctuation">,</span> eliminarUrl <span class="token punctuation">,</span> editarUrlForm <span class="token punctuation">,</span> editarUrl<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="clipboard"><a href="#clipboard" class="header-anchor">#</a> clipboard</h2> <p>Para copiar en el portapapeles la urlShort vamos a trabajar con el frontend</p> <p>Card.hbs:</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code> <span class="token punctuation">&lt;</span><span class="token variable">article</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;card mb-2&quot;</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;card-body&quot;</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">p</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token variable">this</span><span class="token punctuation">.</span><span class="token variable">origin</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">p</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">p</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token variable">this</span><span class="token punctuation">.</span><span class="token variable">shortURL</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">p</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;/eliminar/{{item._id}}&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-danger&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Eliminar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;/editar/{{item._id}}&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-warning&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Editar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">button</span> <span class="token variable">data-short</span><span class="token punctuation">=</span><span class="token string">&quot;{{item.shortURL}}&quot;</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;#&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-info&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">copiar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">button</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">article</span><span class="token punctuation">&gt;</span>

</code></pre></div><p>main.hbs:</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code>  <span class="token punctuation">&lt;</span><span class="token variable">script</span> <span class="token variable">src</span><span class="token punctuation">=</span><span class="token string">&quot;/js/app.js&quot;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">script</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">body</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">html</span><span class="token punctuation">&gt;</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>A partir de ahora trabajamos con el frontend</p></div> <p>public/js/app.js:</p> <div class="language-js extra-class"><pre class="language-js"><code>document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span> <span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>short<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost:5000/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>short<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
         <span class="token comment">// Usamos el clipboard para copiar la const url  en el portapapeles</span>
         <span class="token comment">// Que se copie(Control + C) para luego pegar la url en donde quieras</span>
         navigator<span class="token punctuation">.</span>clipboard
            <span class="token punctuation">.</span><span class="token function">writeText</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Text copied to clipboard...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Something went wrong&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><h2 id="redireccionamiento"><a href="#redireccionamiento" class="header-anchor">#</a> Redireccionamiento</h2> <p>Vamos a hacer  que el short te lleve a la url indicada (origin)</p> <p>routes/home.js:</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> <span class="token punctuation">{</span>leerUrls <span class="token punctuation">,</span> agregarUrl <span class="token punctuation">,</span> eliminarUrl <span class="token punctuation">,</span> editarUrlForm <span class="token punctuation">,</span> editarUrl <span class="token punctuation">,</span> redireccionamiento<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controllers/homeController'</span> <span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/:url&quot;</span> <span class="token punctuation">,</span> redireccionamiento<span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>

</code></pre></div><p>homeController.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">redireccionamiento</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>url<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token comment">// Modificar en la documentacion</span>
       <span class="token keyword">const</span> urlDB <span class="token operator">=</span> <span class="token keyword">await</span> Url<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>shortURL<span class="token operator">:</span> url <span class="token punctuation">}</span><span class="token punctuation">)</span>
       res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>urlDB<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> <span class="token string">&quot;No existe esta url configurada&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/login'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
   module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>leerUrls <span class="token punctuation">,</span> agregarUrl <span class="token punctuation">,</span> eliminarUrl <span class="token punctuation">,</span> editarUrlForm <span class="token punctuation">,</span> editarUrl <span class="token punctuation">,</span> redireccionamiento<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="registrar-usuario"><a href="#registrar-usuario" class="header-anchor">#</a> Registrar usuario</h2> <p>controllers/authController.js</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../models/User&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>nanoid<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'nanoid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">loginForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">registerForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'register'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">registerUser</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>userName <span class="token punctuation">,</span> email <span class="token punctuation">,</span> password<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Buscamos un usuario por el email</span>
       <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token operator">:</span>email<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// Si existe el usuario , retornamos un error</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'ya existe el usuario'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// Si no existe , creamos una instancia del modelo</span>
<span class="token comment">// userName:userName , email:email , password:password</span>
      user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">{</span>userName <span class="token punctuation">,</span> email <span class="token punctuation">,</span> password  <span class="token punctuation">,</span> tokenConfirm<span class="token operator">:</span> <span class="token function">nanoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> e<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    loginForm <span class="token punctuation">,</span> registerForm <span class="token punctuation">,</span> registerUser
<span class="token punctuation">}</span>

</code></pre></div><p>routes/auth.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> loginForm<span class="token punctuation">,</span> registerForm<span class="token punctuation">,</span> registerUser <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controllers/authController'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> loginForm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//Respondemos una peticion GET  a auth/register </span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/register&quot;</span><span class="token punctuation">,</span> registerForm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Respondemos una peticion POST  a auth/register </span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/register&quot;</span> <span class="token punctuation">,</span> registerUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>

</code></pre></div><ul><li><p>http://localhost:5000/auth/login</p></li> <li><p>http://localhost:5000/auth/register</p></li></ul> <p>views/register.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code><span class="token punctuation">&lt;</span><span class="token variable">h1</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;text-center my-5&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Registro</span> <span class="token variable">de</span> <span class="token variable">usuarios</span> <span class="token variable">nuevos</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;row justify-content-center&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;col-md-6&quot;</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token variable">form</span> <span class="token variable">action</span><span class="token punctuation">=</span><span class="token string">&quot;/auth/register&quot;</span> <span class="token variable">method</span><span class="token punctuation">=</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">input</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;text&quot;</span> <span class="token variable">placeholder</span><span class="token punctuation">=</span><span class="token string">&quot;Ingrese nombre&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;form-control mb-2&quot;</span> <span class="token variable">value</span><span class="token punctuation">=</span><span class="token string">&quot;usuario&quot;</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;userName&quot;</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">input</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;text&quot;</span> <span class="token variable">placeholder</span><span class="token punctuation">=</span><span class="token string">&quot;Ingrese email&quot;</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;email&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;form-control mb-2&quot;</span>
                <span class="token variable">value</span><span class="token punctuation">=</span><span class="token string">&quot;usuario@test.com&quot;</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">input</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;password&quot;</span> <span class="token variable">placeholder</span><span class="token punctuation">=</span><span class="token string">&quot;Ingrese password&quot;</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;password&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;form-control mb-2&quot;</span>
                <span class="token variable">value</span><span class="token punctuation">=</span><span class="token string">&quot;123123&quot;</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">input</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;password&quot;</span> <span class="token variable">placeholder</span><span class="token punctuation">=</span><span class="token string">&quot;Repita password&quot;</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;repassword&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;form-control mb-2&quot;</span>
                <span class="token variable">value</span><span class="token punctuation">=</span><span class="token string">&quot;123123&quot;</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">button</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-primary&quot;</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;submit&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Registrar</span> <span class="token variable">usuario</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">button</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">form</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>

</code></pre></div><h2 id="respuestas"><a href="#respuestas" class="header-anchor">#</a> Respuestas</h2> <ul><li>res.render() = Renderizar(Convertir en html) un archivo</li> <li>res.json() = Para responder en json</li> <li>res.send() = Para responder de forma sencilla.</li></ul> <h2 id="modelo-usuario"><a href="#modelo-usuario" class="header-anchor">#</a> Modelo Usuario</h2> <ul><li>Definir el esquema sirve para hacer validaciones de DB</li> <li>juntándolo con las validaciones del backend y frontend la app es muy segura.</li> <li>Si no se respeta la estructura(esquema) a la hora de crear un documento, se genera un error.
models/User.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>
<span class="token comment">// Obtenemos la clase Schema de mongosee</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Schema<span class="token punctuation">}</span> <span class="token operator">=</span> mongoose

<span class="token keyword">const</span> UserSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// Estructura de los documentos</span>
   <span class="token comment">//columna/propiedad userName</span>
   <span class="token comment">// Es de tipo String ,y obligatorio</span>
   <span class="token comment">// Se convierte en minuscula el valor</span>
   userName<span class="token operator">:</span> <span class="token punctuation">{</span>
       type<span class="token operator">:</span>String<span class="token punctuation">,</span>
       lowercase<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
       required<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token punctuation">}</span> <span class="token punctuation">,</span>
   <span class="token comment">//columna/propiedad email</span>
   <span class="token comment">// Es de tipo String , obligatorio y unico</span>
   <span class="token comment">// Se convierte en minuscula el valor</span>
   email<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span>String<span class="token punctuation">,</span>
    lowercase<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    required<span class="token operator">:</span><span class="token boolean">true</span> <span class="token punctuation">,</span>
    unique <span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">,</span>
    <span class="token comment">// Indexar</span>
    index<span class="token operator">:</span> <span class="token punctuation">{</span>unique <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span> <span class="token punctuation">,</span> 
<span class="token punctuation">}</span> <span class="token punctuation">,</span>
<span class="token comment">//columna/propiedad password</span>
   <span class="token comment">// Es de tipo String y obligatorio </span>
password<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span>String <span class="token punctuation">,</span>
    required <span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">,</span>

<span class="token punctuation">}</span> <span class="token punctuation">,</span>
<span class="token comment">//columna/propiedad tokenConfirm</span>
   <span class="token comment">// Es de tipo String </span>
   <span class="token comment">// Valor por defecto: null</span>
tokenConfirm <span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span>String <span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token punctuation">,</span>
<span class="token comment">//columna/propiedad cuentaConfirmada</span>
   <span class="token comment">// Es de tipo boolean </span>
   <span class="token comment">// Valor por defecto: false</span>
cuentaConfirmada<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span>Boolean<span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span><span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// Llevamos el esquema hacia un modelo y lo exportamos</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;User&quot;</span> <span class="token punctuation">,</span> UserSchema<span class="token punctuation">)</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <ul><li>La exportación se hace por defecto , por lo tanto se le puede cambiar el nombre al importarlo.</li> <li>Al momento de instanciar un modelo, solo las propiedades que contiene el esquema se van a instanciar y no propiedades inexistentes.</li></ul></div> <h2 id="cifrar-la-contrasena"><a href="#cifrar-la-contrasena" class="header-anchor">#</a> Cifrar la contraseña</h2> <h3 id="creamos-un-hash"><a href="#creamos-un-hash" class="header-anchor">#</a> Creamos un hash</h3> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>NUNCA GUARDAR LA CONTRASEÑA EN TEXTO PLANO</p></div> <ul><li>Usamos el modulo <a href="https://www.npmjs.com/package/bcryptjs" target="_blank" rel="noopener noreferrer">bcryptjs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm i bcryptjs
</code></pre></div><h3 id="tutorial-de-bycriptjs"><a href="#tutorial-de-bycriptjs" class="header-anchor">#</a> Tutorial de bycriptjs</h3> <ol><li>Importarlo</li> <li>Generar saltos</li></ol> <ul><li>Los saltos son como palabras aleatorias que se generan a partir de la contraseña para que no se pueda descifrar la misma</li> <li>Mientras el valor sea más alto , más recursos consume pero brinda mas seguridad</li> <li>La cantidad de veces que se va a encriptar la contraseña en cadena.</li></ul> <ol start="3"><li>Encriptamos la contraseña con los saltos.</li></ol> <p>Se recomienda usar el async</p> <h2 id="pre-mongosee"><a href="#pre-mongosee" class="header-anchor">#</a> pre mongosee</h2> <ul><li><a href="https://mongoosejs.com/docs/api.html#schema_Schema-pre" target="_blank" rel="noopener noreferrer">info<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Es  un hook(gancho)</li> <li>Sintaxis : Esquema.pre(‘accion’ , function )</li> <li>El pree mongosee  sirve para ejecutar una función antes de una acción.</li> <li>La función tiene como parámetro el next que cumple la misma función que el del middleware. (en este caso que ejecute la ‘accion’)</li> <li>La función no debe ser una función flecha ya que utiliza el this para acceder al esquema.</li></ul> <p>Con pre vamos a hacer que  antes que se guarde en la BD, haga alguna acción (en nuestro caso encriptar).</p> <p>models/User.js:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> bycript <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bcryptjs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>
<span class="token comment">// Obtenemos la clase Schema de mongosee</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Schema<span class="token punctuation">}</span> <span class="token operator">=</span> mongoose

<span class="token keyword">const</span> UserSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// Estructura de los documentos</span>
  <span class="token comment">// Si no se respeta la estructura a la hora de crear un documento, se genera un error.</span>
   <span class="token comment">//columna/propiedad userName</span>
   <span class="token comment">// Es de tipo String ,y obligatorio</span>
   <span class="token comment">// Se convierte en minuscula el valor</span>
   userName<span class="token operator">:</span> <span class="token punctuation">{</span>
       type<span class="token operator">:</span>String<span class="token punctuation">,</span>
       lowercase<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
       required<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token punctuation">}</span> <span class="token punctuation">,</span>
   <span class="token comment">//columna/propiedad email</span>
   <span class="token comment">// Es de tipo String , obligatorio y unico</span>
   <span class="token comment">// Se convierte en minuscula el valor</span>
   email<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span>String<span class="token punctuation">,</span>
    lowercase<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    required<span class="token operator">:</span><span class="token boolean">true</span> <span class="token punctuation">,</span>
    unique <span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">,</span>
    <span class="token comment">// Indexar</span>
    index<span class="token operator">:</span> <span class="token punctuation">{</span>unique <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span> <span class="token punctuation">,</span> 
<span class="token punctuation">}</span> <span class="token punctuation">,</span>
<span class="token comment">//columna/propiedad password</span>
   <span class="token comment">// Es de tipo String y obligatorio </span>
password<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span>String <span class="token punctuation">,</span>
    required <span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">,</span>

<span class="token punctuation">}</span> <span class="token punctuation">,</span>
<span class="token comment">//columna/propiedad tokenConfirm</span>
   <span class="token comment">// Es de tipo String </span>
   <span class="token comment">// Valor por defecto: null</span>
tokenConfirm <span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span>String <span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token punctuation">,</span>
<span class="token comment">//columna/propiedad cuentaConfirmada</span>
   <span class="token comment">// Es de tipo boolean </span>
   <span class="token comment">// Valor por defecto: false</span>
cuentaConfirmada<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span>Boolean<span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span><span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// Se va a ejecutar  funcion() antes de llamar a nombrefuncion()</span>
<span class="token comment">// Entonces cuando se llame a nombrefuncion() , tambien es llamada funcion()</span>
<span class="token comment">// pre(nombrefuncion , funcion)</span>
userSchema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span> <span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token comment">// Al ser una una instancia , podemos usar el this</span>
   <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">this</span>
   <span class="token comment">//Si la contraseña no ha sido modificada , que siga (llame al nombrefuncion())</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">.</span><span class="token function">isModified</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// Si la contraseña fue modificada o es nueva la contraseña</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token comment">// Especificamos la cantidad de saltos </span>
       <span class="token keyword">const</span> salt <span class="token operator">=</span> <span class="token keyword">await</span> bycript<span class="token punctuation">.</span><span class="token function">genSalt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
       <span class="token comment">// Ciframos la contraseña</span>
       <span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token keyword">await</span> bycript<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>password <span class="token punctuation">,</span> salt<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
       user<span class="token punctuation">.</span>password <span class="token operator">=</span> hash<span class="token punctuation">;</span>
       <span class="token comment">// Que ejecute nombrefuncion()</span>
       <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment">// Llevamos el esquema hacia un modelo y lo exportamos</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;User&quot;</span> <span class="token punctuation">,</span> UserSchema<span class="token punctuation">)</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">logica</p> <p>Antes que se guarde el usuario en la BD , se cifra la contraseña</p></div> <h2 id="confirmarcuenta"><a href="#confirmarcuenta" class="header-anchor">#</a> ConfirmarCuenta</h2> <p>routes/auth.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> loginForm<span class="token punctuation">,</span> registerForm<span class="token punctuation">,</span> registerUser<span class="token punctuation">,</span> confirmarCuenta <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controllers/authController'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Respondemos una peticion GET a auth/confirmarCuenta/xxxxxxx</span>
<span class="token comment">// variable token = xxxxxxx</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/confirmarCuenta/:token&quot;</span> <span class="token punctuation">,</span> confirmarCuenta <span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>

</code></pre></div><p>controllers/authController.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">registerUser</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>userName <span class="token punctuation">,</span> email <span class="token punctuation">,</span> password<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Buscamos un usuario por el email</span>
       <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token operator">:</span>email<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// Si existe el usuario , retornamos un error</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'ya existe el usuario'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// Si no existe , creamos una instancia del modelo</span>
      user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">{</span>userName <span class="token punctuation">,</span> email <span class="token punctuation">,</span> password  <span class="token punctuation">,</span> tokenConfirm<span class="token operator">:</span> <span class="token function">nanoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> e<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">confirmarCuenta</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    loginForm <span class="token punctuation">,</span> registerForm <span class="token punctuation">,</span> registerUser <span class="token punctuation">,</span> confirmarCuenta
<span class="token punctuation">}</span>

</code></pre></div><p>Modificamos confirmarCuenta:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">confirmarCuenta</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   
   <span class="token comment">//Leemos las variables de la ruta (variable token en este caso)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>token<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// Buscamos el usuario por el token(tokenConfirm) en la BD</span>
      
       <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>tokenConfirm<span class="token operator">:</span>token<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// Si no existe el usuario</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No existe el usuario'</span><span class="token punctuation">)</span>
       <span class="token comment">// Si existe el usuario</span>
       <span class="token comment">// Confirmamos la cuenta</span>
       user<span class="token punctuation">.</span>cuentaConfirmada <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
       <span class="token comment">// Eliminamos el tokenConfirm</span>
       user<span class="token punctuation">.</span>tokenConfirm <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
       <span class="token comment">// Lo guardamos en la BD</span>
       <span class="token comment">// el metodo save() lo contiene el objeto de mongoDB user</span>
       <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="iniciar-sesion"><a href="#iniciar-sesion" class="header-anchor">#</a> Iniciar sesion</h2> <p>views/login.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code>
<span class="token punctuation">&lt;</span><span class="token variable">h1</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;text-center my-5&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Login</span> <span class="token variable">de</span> <span class="token variable">usuarios</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;row justify-content-center&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;col-md-6&quot;</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token variable">form</span> <span class="token variable">action</span><span class="token punctuation">=</span><span class="token string">&quot;/auth/login&quot;</span> <span class="token variable">method</span><span class="token punctuation">=</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">&gt;</span>
          
            <span class="token punctuation">&lt;</span><span class="token variable">input</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;text&quot;</span> <span class="token variable">placeholder</span><span class="token punctuation">=</span><span class="token string">&quot;Ingrese email&quot;</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;email&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;form-control mb-2&quot;</span>
                <span class="token variable">value</span><span class="token punctuation">=</span><span class="token string">&quot;usuario@test.com&quot;</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">input</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;password&quot;</span> <span class="token variable">placeholder</span><span class="token punctuation">=</span><span class="token string">&quot;Ingrese password&quot;</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;password&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;form-control mb-2&quot;</span>
                <span class="token variable">value</span><span class="token punctuation">=</span><span class="token string">&quot;123123&quot;</span><span class="token punctuation">&gt;</span>
           
            <span class="token punctuation">&lt;</span><span class="token variable">button</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-primary&quot;</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;submit&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Acceder</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">button</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">form</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>

</code></pre></div><p>routes/auth.js</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> <span class="token punctuation">{</span> loginForm<span class="token punctuation">,</span> registerForm<span class="token punctuation">,</span> registerUser<span class="token punctuation">,</span> confirmarCuenta <span class="token punctuation">,</span> loginUser <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controllers/authController'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> loginForm<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>controllers/authController.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">registerForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'register'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">loginUser</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    loginForm <span class="token punctuation">,</span> registerForm <span class="token punctuation">,</span> registerUser <span class="token punctuation">,</span> confirmarCuenta <span class="token punctuation">,</span> loginUser
<span class="token punctuation">}</span>

</code></pre></div><h2 id="anadirle-metodos-al-esquema-mongodb"><a href="#anadirle-metodos-al-esquema-mongodb" class="header-anchor">#</a> Añadirle metodos al esquema mongoDB</h2> <ul><li>Le añadimos un método adicional al esquema, el cual lo adquiere el modelo posteriormente.
models/User.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//esquema.methods.nombre_metodo = funcion</span>
<span class="token comment">// Le añadimos un metodo   lllamada comparePassword al esquema</span>
<span class="token comment">// Tenemos acceso al this al ser un metodo </span>
UserSchema<span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function-variable function">comparePassword</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//bycript.compare(contraseña , clave cifrada(hash))</span>
    <span class="token comment">// Compara una contraseña no cifrada con una cifrada</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> bycript<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password <span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>password<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Llevamos el esquema hacia un modelo y lo exportamos</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;User&quot;</span> <span class="token punctuation">,</span> UserSchema<span class="token punctuation">)</span>

</code></pre></div><p>Modificamos el loginUser(req,res) de authController.js</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> <span class="token function-variable function">loginUser</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>email<span class="token punctuation">,</span>password<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// email:email</span>
      <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">//Si no existe el usuario </span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No existe este email'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Si existe el usuario</span>
      <span class="token comment">// Verifica que la cuenta esta confirmada</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">.</span>cuentaConfirmada<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Falta confirmar cuenta'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//Usamos el metodo que creamos</span>
      <span class="token comment">//Que devuelve true si la contraseña es correcta</span>
      <span class="token comment">// Verifica que la contraseña sea valida</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">comparePassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Contraseña no correcta'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Y si llego hasta aca , el usuario el valido</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
         res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    loginForm <span class="token punctuation">,</span> registerForm <span class="token punctuation">,</span> registerUser <span class="token punctuation">,</span> confirmarCuenta <span class="token punctuation">,</span> loginUser
<span class="token punctuation">}</span>


</code></pre></div><h2 id="favicon"><a href="#favicon" class="header-anchor">#</a> Favicon</h2> <p>en la carpeta public/img ponemos la imagen</p> <p>quedando: public/img/favicon.ico</p> <p>main.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code><span class="token punctuation">&lt;</span><span class="token variable">head</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">charset</span><span class="token punctuation">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">http-equiv</span><span class="token punctuation">=</span><span class="token string">&quot;X-UA-Compatible&quot;</span> <span class="token variable">content</span><span class="token punctuation">=</span><span class="token string">&quot;IE=edge&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">meta</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;viewport&quot;</span> <span class="token variable">content</span><span class="token punctuation">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">title</span><span class="token punctuation">&gt;</span><span class="token variable">Desde</span> <span class="token variable">HBS</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">title</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">link</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css&quot;</span> <span class="token variable">rel</span><span class="token punctuation">=</span><span class="token string">&quot;stylesheet&quot;</span> <span class="token variable">integrity</span><span class="token punctuation">=</span><span class="token string">&quot;sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3&quot;</span> <span class="token variable">crossorigin</span><span class="token punctuation">=</span><span class="token string">&quot;anonymous&quot;</span><span class="token punctuation">&gt;</span>
     <span class="token punctuation">&lt;</span><span class="token variable">link</span> <span class="token variable">rel</span><span class="token punctuation">=</span><span class="token string">&quot;icon&quot;</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;image/x-icon&quot;</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;/img/favicon.ico&quot;</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">head</span><span class="token punctuation">&gt;</span>

</code></pre></div><p>navbar.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code> <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;nav-link&quot;</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;/auth/register&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Register</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;nav-link&quot;</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;/auth/login&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Login</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token variable">a</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;nav-link&quot;</span> <span class="token variable">href</span><span class="token punctuation">=</span><span class="token string">&quot;/auth/logout&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">LogOut</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">a</span><span class="token punctuation">&gt;</span>

</code></pre></div><h2 id="session"><a href="#session" class="header-anchor">#</a> Session</h2> <ul><li>El middleware express-session almacena los datos de sesión en el servidor; sólo guarda el ID de sesión en la propia cookie, no los datos de sesión. De forma predeterminada, utiliza el almacenamiento en memoria y no está diseñado para un entorno de producción.</li> <li>En una api rest NO SE DEBE trabajar con esto</li></ul> <div class="custom-block tip"><p class="custom-block-title">middleware</p> <p>Se ejecute antes que la petición llegue al servidor y la gestione.</p></div> <ul><li>Usaremos el modulo <a href="http://expressjs.com/en/resources/middleware/session.html" target="_blank" rel="noopener noreferrer">express-sesion<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> para trabajar con la sesiones en express</li> <li>Usaremos el modulo <a href="https://www.npmjs.com/package/connect-mongo" target="_blank" rel="noopener noreferrer">connect-mongo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> para guardar la sesion en la BD</li></ul> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm i express<span class="token operator">-</span>session
npm i <span class="token function">connect-mongo</span>

</code></pre></div><h3 id="ejemplo"><a href="#ejemplo" class="header-anchor">#</a> Ejemplo</h3> <p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-session&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> create <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-handlebars&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./database/conexion'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> hbs <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    extname<span class="token operator">:</span> <span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">,</span>
    partialsDir<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;views/components&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Configuramos la sesion con el middleware.</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      secret<span class="token operator">:</span> <span class="token string">'palabra secreta'</span><span class="token punctuation">,</span>
      <span class="token comment">// Para tratar errores</span>
      resave<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      saveUninitialized<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">&quot;nombre de la palabra secreta&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/ruta-protegida&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Si existe una sesion devolvemos el usuario , en caso contrario mandamos &quot;Sin sesion de usuario&quot;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>usuario <span class="token operator">||</span> <span class="token string">&quot;Sin sesion de usuario&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/crear-session'</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Creamos la sesion</span>
  req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>usuario <span class="token operator">=</span> <span class="token string">&quot;usuario&quot;</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/ruta-protegida'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <p>La sesion se crea en la memoria (nuestra maquina)</p></div> <p>Tambien podemos destruir la sesion:</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/ruta-protegida&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Si existe una sesion devolvemos el usuario , en caso contrario mandamos &quot;Sin sesion de usuario&quot;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>usuario <span class="token operator">||</span> <span class="token string">&quot;Sin sesion de usuario&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/crear-session'</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Creamos la sesion</span>
  req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>usuario <span class="token operator">=</span> <span class="token string">&quot;usuario&quot;</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/ruta-protegida'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/destruir-sesion'</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Destruirmos la sesion</span>
  req<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/ruta-protegida'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><h2 id="flash"><a href="#flash" class="header-anchor">#</a> Flash</h2> <ul><li>El flash es un área especial de la sesión que se utiliza para almacenar mensajes. Los mensajes se escriben en la memoria flash y se borran después de mostrarse al usuario. El flash generalmente se usa en combinación con redireccionamientos, lo que garantiza que el mensaje esté disponible para la siguiente página que se va a representar.</li> <li>Viven solamente en una redirección. Si se navega en otro lado se destruye.</li> <li>Usaremos el modulo <a href="https://www.npmjs.com/package/connect-flash" target="_blank" rel="noopener noreferrer">connect-flash<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> para trabajar con flash</li> <li>Es un tipo de sesion , que solo vive una vez (en una redirección)</li></ul> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm i <span class="token function">connect-flash</span>
</code></pre></div><h3 id="ejemplo-2"><a href="#ejemplo-2" class="header-anchor">#</a> Ejemplo</h3> <p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-session&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> flash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;connect-flash&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> create <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-handlebars&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./database/conexion'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> hbs <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    extname<span class="token operator">:</span> <span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">,</span>
    partialsDir<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;views/components&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Configuramos la sesion con el middleware.</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      secret<span class="token operator">:</span> <span class="token string">'palabra secreta'</span><span class="token punctuation">,</span>
      resave<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      saveUninitialized<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">&quot;nombre de secreto&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Configuramos flash con el middleware</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/mensaje-flash'</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Muestra un mensaje flash cuya key es &quot;mensaje&quot;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">'mensaje'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/crear-mensaje'</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//flash( key , valor)</span>
  <span class="token comment">// La key contiene el valor</span>
  <span class="token comment">// key -&gt; valor</span>
  <span class="token comment">//&quot;mensaje&quot; -&gt; &quot;este es un mensaje&quot;</span>
  req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensaje&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;este es un mensaje&quot;</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/mensaje-flash'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <ul><li>A diferencia de session-express, la sesion solo dura en la redirección (solo una url)</li> <li>Solo viven en una url.</li> <li>Cuando llamas un mensaje flash, se destruye</li> <li>Flash requiere de la configuración de la sesion (express-sesion)</li></ul></div> <h2 id="validaciones-express-validator"><a href="#validaciones-express-validator" class="header-anchor">#</a> Validaciones(Express-validator)</h2> <div class="custom-block warning"><p class="custom-block-title">Aclaracion</p> <ul><li>Los dos ejemplos anteriores(sesion y flash) no forman parte del proyecto</li> <li>Flash y Session se usaran  para mostrar los mensajes de errores de las validaciones</li></ul></div> <ul><li>Vamos a usar el modulo <a href="https://express-validator.github.io/docs/" target="_blank" rel="noopener noreferrer">express-validator<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> que nos sirve para validar</li></ul> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm i express<span class="token operator">-</span>validator
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Objetivo</p> <p>Antes que se guarde un usuario en la BD , vamos a validar los datos.</p></div> <p>routes/auth.js</p> <p>Configuramos una validacion del nombre usuario:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>body<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-validator'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Tiene un array de middleware</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/register&quot;</span> <span class="token punctuation">,</span>  <span class="token punctuation">[</span>
    
    <span class="token comment">// body (&quot;valor-atributoname/propiedad&quot; , &quot;mensaje de error&quot;).metodo.metodo.metodo....</span>
    <span class="token comment">// valor-atributoname/propiedad = corresponde a una propiedad del body(los datos se envian por el body) que se va a evaluar</span>
    <span class="token comment">// trim() = Limpia los espacios en blanco del lado izquierda y derecho</span>
    <span class="token comment">// notEmpty()  = Para que no venga vacio </span>
    <span class="token comment">// escape() = Para que solo mande caracteres y ignore html</span>
    <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;userName&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;Ingrese un nombre válido&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">escape</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span> <span class="token punctuation">,</span>  registerUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <p>Un array de middleware sirve para implementar muchos middleware en una ruta</p></div> <p>authController.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>validationResult <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-validator'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">registerUser</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Hace la validacion que hemos configurado</span>
  <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//Si tiene errores , los devuelve</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>userName <span class="token punctuation">,</span> email <span class="token punctuation">,</span> password<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body

</code></pre></div><p>Configuramos las demas Validaciones:</p> <p>routes/auth.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Tiene un array de middleware</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/register&quot;</span> <span class="token punctuation">,</span>  <span class="token punctuation">[</span>
   <span class="token comment">// body (&quot;valor-atributoname/propiedad&quot; , &quot;mensaje de error&quot;).metodo.metodo.metodo....</span>
    <span class="token comment">// valor-atributoname/propiedad = corresponde a una propiedad del body(los datos se envian por el body) que se va a evaluar</span>
    <span class="token comment">// trim() = Limpia los espacios en blanco del lado izquierda y derecho</span>
    <span class="token comment">// notEmpty()  = Para que no venga vacio d</span>
    <span class="token comment">// escape() = Para que solo mande caracteres y ignore html</span>
    <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;userName&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;Ingrese un nombre válido&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">escape</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token comment">//Validamos el email  para que tenga un formato valido</span>
    <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;Ingrese un email valido&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalizeEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>
    <span class="token comment">//validamos la contraseña </span>
    <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;Contraseña de minimo 6 caracteres&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span>min<span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">escape</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// Hacemos una validacion personalizada para que las dos contraseñas coincida</span>
    <span class="token comment">// custom(funcion(value , {req})) </span>
    <span class="token comment">// el value es lo que se evalua (lo que se envia en el formulario)</span>
    <span class="token comment">// {req} es para tener acceso al req(requirimiento)</span>
    <span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value <span class="token punctuation">,</span> <span class="token punctuation">{</span>req<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token comment">// SI no son iguales</span>
        
       <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!==</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>repassword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">// No cumple la validacion</span>
           <span class="token comment">//Este seria el mensaje de error que se mandaria</span>
           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;No coinciden las contraseñas&quot;</span><span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
       <span class="token comment">// Si cumple la validacion</span>
       <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span> <span class="token punctuation">,</span>  registerUser<span class="token punctuation">)</span><span class="token punctuation">;</span>



</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <ul><li>Si se cumple la validación , no devuelve nada</li> <li>Si no se cumple , devuelve el mensaje de error.</li></ul></div> <h3 id="validamos-el-login-tambien"><a href="#validamos-el-login-tambien" class="header-anchor">#</a> Validamos el login también:</h3> <p>routes/auth.js</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;Ingrese un email valido&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalizeEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>  <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;Contraseña de minimo 6 caracteres&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span>min<span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">escape</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">]</span> <span class="token punctuation">,</span> loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>authController.js:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">loginUser</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Hace la validacion que hemos configurado</span>
  <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//Si tiene errores , los devuelve</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>email<span class="token punctuation">,</span>password<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

</code></pre></div><h2 id="validaciones-en-la-vista"><a href="#validaciones-en-la-vista" class="header-anchor">#</a> Validaciones en la vista</h2> <p>Ponemos las Validaciones en la vista:</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Ahora si vamos a usar flash y session.</p></div> <div class="custom-block tip"><p class="custom-block-title">array()</p> <p>Usamos el método array() el cual lo convierte en array.
Empezamos con el login:</p></div> <p>authController.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">loginForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'login'</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span>mensajes <span class="token operator">:</span> req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">loginUser</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Hace la validacion que hemos configurado</span>
  <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//Si tiene errores , los devuelve</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/login'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>email<span class="token punctuation">,</span>password<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// email:email</span>
      <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">//Si no existe el usuario </span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No existe este email'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Si existe el usuario</span>
      <span class="token comment">// Verifica que la cuenta esta confirmada</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">.</span>cuentaConfirmada<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Falta confirmar cuenta'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//Usamos el metodo que creamos</span>
      <span class="token comment">//Que devuelve true si la contraseña es correcta</span>
      <span class="token comment">// Verifica que la contraseña sea valida</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">comparePassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Contraseña incorrecta'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Y si llego hasta aca , el usuario el valido</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/login'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <ul><li>Los valores que se mandan a la vista pueden ser null</li> <li>Si no se manda un valor , se considera null</li></ul></div> <p>views/layouts/main.hbs</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token operator">&gt;</span> Navbar<span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;container mt-5&quot;</span><span class="token operator">&gt;</span>
      <span class="token punctuation">{</span><span class="token punctuation">{</span>#each mensajes <span class="token punctuation">}</span><span class="token punctuation">}</span>
              <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;alert alert-dark mb-2&quot;</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>msg<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token operator">/</span>each<span class="token punctuation">}</span><span class="token punctuation">}</span>

      
 <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">{</span>body<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
     
      <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js&quot;</span> integrity<span class="token operator">=</span><span class="token string">&quot;sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p&quot;</span> crossorigin<span class="token operator">=</span><span class="token string">&quot;anonymous&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;/js/app.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>

</code></pre></div><p>Ahora lo hacemos en el registro</p> <p>authController.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">registerForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'register'</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span>mensajes <span class="token operator">:</span> req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">registerUser</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Hace la validacion que hemos configurado</span>
  <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//Si tiene errores , los devuelve</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/register'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>userName <span class="token punctuation">,</span> email <span class="token punctuation">,</span> password<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Buscamos un usuario por el email</span>
       <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token operator">:</span>email<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// Si existe el usuario , retornamos un error</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'ya existe el usuario'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// Si no existe , creamos una instancia del modelo</span>
      user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">{</span>userName <span class="token punctuation">,</span> email <span class="token punctuation">,</span> password  <span class="token punctuation">,</span> tokenConfirm<span class="token operator">:</span> <span class="token function">nanoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> <span class="token string">&quot;Revisa tu correo electronico y valida cuenta&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/register'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>Hacemos lo mismo en la ruta de confirmarCuenta</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">confirmarCuenta</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   
   <span class="token comment">//Leemos las variables de la ruta (variable token en este caso)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>token<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// Buscamos el usuario por el token en la BD</span>
      
       <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>tokenConfirm<span class="token operator">:</span>token<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// Si no existe el usuario</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No existe el usuario'</span><span class="token punctuation">)</span>
       <span class="token comment">// Si existe el usuario</span>
       <span class="token comment">// Confirmamos la cuenta</span>
       user<span class="token punctuation">.</span>cuentaConfirmada <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
       <span class="token comment">// Eliminamos el tokenConfirm</span>
       user<span class="token punctuation">.</span>tokenConfirm <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
       <span class="token comment">// Lo guardamos en la BD</span>
       <span class="token comment">// el metodo save() lo contiene el objeto de mongoDB user</span>
       <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> <span class="token string">&quot;Cuenta verificada&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/login'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><h2 id="passport"><a href="#passport" class="header-anchor">#</a> Passport</h2> <ul><li>Podemos gestionar nosotros las sesiones o que las gestione un tercero como Passport</li> <li><a href="http://www.passportjs.org" target="_blank" rel="noopener noreferrer">Passport<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  es un modulo que te permite gestionar sesiones , ofrece un montón de estrategias para validar al usuario. Pero en el proyecto solo vamos a configurar Passport para que gestione las sesiones.</li></ul> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm install passport
</code></pre></div><h3 id="req-login"><a href="#req-login" class="header-anchor">#</a> req.login()</h3> <ul><li>Lo genera passport con las configuraciones que tiene configurada</li> <li>Sirve para crear una sesion</li> <li>Le manda el usuario a la función serializeUser para crear el req.user</li></ul> <h3 id="serializeruser"><a href="#serializeruser" class="header-anchor">#</a> serializerUser()</h3> <ul><li>Es una funcion que invoca req.login()</li> <li>Crea la sesion con la ID y el nombre del usuario (los datos se pueden configurar)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Recibe un callback con dos parametros </span>
<span class="token comment">// user = el usuario que le vamos a enviar </span>
<span class="token comment">// done = Para decirle que se hizo con exito</span>
passport<span class="token punctuation">.</span><span class="token function">serializeUser</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user <span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// done (errores , {los datos que van al req.user})</span>
  <span class="token comment">// La funcion done crea el req.user </span>
   <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span>id<span class="token operator">:</span> user<span class="token punctuation">.</span>_id <span class="token punctuation">,</span> userName<span class="token operator">:</span> user<span class="token punctuation">.</span>userName<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><h3 id="deserializeruser"><a href="#deserializeruser" class="header-anchor">#</a> deserializerUser()</h3> <ul><li>Verifica que la sesion sea correcta/valida para restablecer la sesion .</li> <li>Sirve Para mantener/actualizar la sesion cuando se actualiza el sitio web.</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Tiene un callback con los mismos parametros que serializeUser()</span>
passport<span class="token punctuation">.</span><span class="token function">deserializeUser</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user <span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// done(mensaje , usuario)</span>
  <span class="token comment">// la funcion done vuelve a crear el req.user</span>
  <span class="token comment">//  1 alternativa</span>
  <span class="token keyword">return</span>  <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token punctuation">,</span> user<span class="token punctuation">)</span>
  <span class="token comment">// 2 alternativa</span>
  <span class="token keyword">return</span>  <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span>id<span class="token operator">:</span>id <span class="token punctuation">,</span> userName<span class="token operator">:</span> user<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><h3 id="logout"><a href="#logout" class="header-anchor">#</a> logout()</h3> <ul><li>Cierra/Destruye la sesion</li></ul> <h3 id="en-el-proyecto-3"><a href="#en-el-proyecto-3" class="header-anchor">#</a> En el proyecto</h3> <div class="custom-block tip"><p class="custom-block-title">Observacion</p> <p>La configuración de passport se hace después de la configuración de session y flash , ya que este modulo  las utiliza (para gestionarlas)</p></div> <p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-session&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> flash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;connect-flash&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> create <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-handlebars&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> passport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;passport&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./models/User&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./database/conexion'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> hbs <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    extname<span class="token operator">:</span> <span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">,</span>
    partialsDir<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;views/components&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Configuramos la sesion con el middleware.</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      secret<span class="token operator">:</span> <span class="token string">'palabra secreta'</span><span class="token punctuation">,</span>
      resave<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      saveUninitialized<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">&quot;nombre de secreto&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Configuramos flash con el middleware</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Configuramos passport con el middleware</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>passport<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>passport<span class="token punctuation">.</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Recibe un callback con dos parametros </span>
<span class="token comment">// user = el usuario que le vamos a enviar </span>
<span class="token comment">// done = Para decirle que se hizo con exito</span>
passport<span class="token punctuation">.</span><span class="token function">serializeUser</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user <span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// done (errores , {los datos que van al req.user})</span>
  <span class="token comment">// La funcion done crea el req.user </span>
   <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span>id<span class="token operator">:</span> user<span class="token punctuation">.</span>_id <span class="token punctuation">,</span> userName<span class="token operator">:</span> user<span class="token punctuation">.</span>userName<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Tiene un callback con los mismos parametros que serializeUser()</span>
passport<span class="token punctuation">.</span><span class="token function">deserializeUser</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">user <span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// done(mensaje , usuario)</span>
  <span class="token comment">// la funcion done vuelve a crear el req.user</span>

 <span class="token keyword">const</span> userDB <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span>  <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span>id<span class="token operator">:</span>userDB<span class="token punctuation">.</span>_id <span class="token punctuation">,</span> userName<span class="token operator">:</span> userDB<span class="token punctuation">.</span>userName<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span>extended<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">engine</span><span class="token punctuation">(</span><span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">,</span> hbs<span class="token punctuation">.</span>engine<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;view engine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;views&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./views&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">&quot;/public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/home'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;/auth&quot;</span> <span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/auth'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">5000</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;server andando 🔥 http://localhost:5000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="middleware-para-verificar-sesion"><a href="#middleware-para-verificar-sesion" class="header-anchor">#</a> Middleware para verificar sesion</h2> <ul><li>Tenemos que crear un middleware que verifique que el usuario tenga una sesion activa</li></ul> <p>creamos el archivo verificarUser.js dentro de la carpeta middlewares</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req <span class="token punctuation">,</span> res <span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// El req ya va a tener todas las configuraciones de passport</span>
   <span class="token comment">// isAuthenticated() es un metodo de  passport</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Si el usuario tiene una  sesion  activa que pase al siguiente middleware o que pase al servidor para poder gestionar la peticion.</span>
        <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Si no tiene una sesion activa</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>routes/home.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> verificarUser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../middlewares/verificarUser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token punctuation">,</span> verificarUser<span class="token punctuation">,</span>  leerUrls<span class="token punctuation">)</span>

</code></pre></div><p>authController.js</p> <div class="custom-block tip"><p class="custom-block-title">Observacion</p> <ul><li>Usamos el método login de Passport para crear la sesion de usuario</li></ul></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">loginUser</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/login'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>email<span class="token punctuation">,</span>password<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No existe este email'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">.</span>cuentaConfirmada<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Falta confirmar cuenta'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">comparePassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Contraseña no correcta'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//login(usuario , callback)</span>
      <span class="token comment">// Con el parametro del callback gestiona los errores(seria como el catch)</span>
     req<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>user <span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
              <span class="token comment">// Si hay errores </span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Error al crear la sesion'</span><span class="token punctuation">)</span>
               <span class="token comment">// Si no hay errores</span>
               res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/login'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Como la sesion esta en memoria (en la maquina), al reiniciar el servidor se pierde todo.</p></div> <h2 id="cerrar-sesion"><a href="#cerrar-sesion" class="header-anchor">#</a> Cerrar sesion</h2> <p>routes/auth.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> loginForm<span class="token punctuation">,</span> registerForm<span class="token punctuation">,</span> registerUser<span class="token punctuation">,</span> confirmarCuenta <span class="token punctuation">,</span> loginUser<span class="token punctuation">,</span> cerrarSesion <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controllers/authController'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/logout&quot;</span> <span class="token punctuation">,</span> cerrarSesion<span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>

</code></pre></div><p>authController.js</p> <div class="custom-block tip"><p class="custom-block-title">Observacion</p> <p>Usaremos el método logout que viene del Passport</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">cerrarSesion</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//el metodo logout de passport</span>
  <span class="token comment">// logout() = cierra la sesion</span>
  req<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/login'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    loginForm <span class="token punctuation">,</span> registerForm <span class="token punctuation">,</span> registerUser <span class="token punctuation">,</span> confirmarCuenta <span class="token punctuation">,</span> loginUser <span class="token punctuation">,</span> cerrarSesion
<span class="token punctuation">}</span>

</code></pre></div><h2 id="csrf-protection-middleware"><a href="#csrf-protection-middleware" class="header-anchor">#</a> CSRF protection middleware</h2> <p>Sirve para:</p> <ul><li>Comprobar que los formularios sean definitivamente de nuestra web y no de un tercero.</li> <li>Comprobar que los formularios son enviados desde nuestro sitio.</li> <li>Para dicho objetivo usamos el modulo <a href="https://github.com/expressjs/csurf" target="_blank" rel="noopener noreferrer">csurf<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm install csurf
</code></pre></div><p>Lo configuramos y lo llamamos en el proyecto</p> <p>index.js</p> <div class="custom-block tip"><p class="custom-block-title">Objetivo</p> <p>Habilitar Las protecciones (Validaciones)</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-session&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> flash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;connect-flash&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> create <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-handlebars&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> passport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;passport&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./models/User&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./database/conexion'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> csrf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;csurf&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//  configuramos csrf con el middleware </span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Se recomienda reiniciar el servidor (bajar nodemon y volver a levantarlo)</p></div> <div class="custom-block tip"><p class="custom-block-title">Resultado</p> <p>Te tirara error en el home.</p> <p>Eso sucede porque no especificamos que el formulario proviene de nuestro sitio y por lo tanto es seguro.</p></div> <p>Para especificar que los formularios provienen de nuestro sitio, tenemos que enviarle un token a los formulario.</p> <p>Para enviar dicho token , vamos a usar un input de tipo hidden en todos los formularios</p> <div class="custom-block tip"><p class="custom-block-title">warning</p> <p>el name del input no se puede modificar</p></div> <div class="language-html extra-class"><pre class="language-html"><code>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_csrf<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{{csrfToken}}<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>

</code></pre></div><p>En views/components/Form.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code><span class="token delimiter punctuation">{{</span><span class="token block keyword">#if</span> <span class="token variable">url</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">&lt;</span><span class="token variable">form</span> <span class="token variable">action</span><span class="token punctuation">=</span><span class="token string">&quot;/editar/{{url._id}}&quot;</span> <span class="token variable">method</span><span class="token punctuation">=</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">input</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;hidden&quot;</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;_csrf&quot;</span> <span class="token variable">value</span><span class="token punctuation">=</span><span class="token string">&quot;{{csrfToken}}&quot;</span> <span class="token block keyword">/&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">input</span>  <span class="token variable">value</span><span class="token punctuation">=</span><span class="token string">&quot;{{url.origin}}&quot;</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;text&quot;</span> <span class="token variable">placeholder</span><span class="token punctuation">=</span><span class="token string">&quot;Ingrese URL&quot;</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;origin&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;form-control my-2&quot;</span><span class="token punctuation">&gt;</span>
 <span class="token punctuation">&lt;</span><span class="token variable">button</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;submit&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-warning w-100 mb-2&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Editar</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">button</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">form</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token variable">else</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">&lt;</span><span class="token variable">form</span> <span class="token variable">action</span><span class="token punctuation">=</span><span class="token string">&quot;/&quot;</span> <span class="token variable">method</span><span class="token punctuation">=</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">input</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;hidden&quot;</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;_csrf&quot;</span> <span class="token variable">value</span><span class="token punctuation">=</span><span class="token string">&quot;{{csrfToken}}&quot;</span> <span class="token block keyword">/&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">input</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;text&quot;</span> <span class="token variable">placeholder</span><span class="token punctuation">=</span><span class="token string">&quot;Ingrese URL&quot;</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;origin&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;form-control my-2&quot;</span><span class="token punctuation">&gt;</span>
 <span class="token punctuation">&lt;</span><span class="token variable">button</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;submit&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-primary w-100 mb-2&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Agregar</span> <span class="token variable">Url</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">button</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">form</span><span class="token punctuation">&gt;</span>

<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">/</span><span class="token variable">if</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

</code></pre></div><p>views/login.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code>
<span class="token punctuation">&lt;</span><span class="token variable">h1</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;text-center my-5&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Login</span> <span class="token variable">de</span> <span class="token variable">usuarios</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;row justify-content-center&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;col-md-6&quot;</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token variable">form</span> <span class="token variable">action</span><span class="token punctuation">=</span><span class="token string">&quot;/auth/login&quot;</span> <span class="token variable">method</span><span class="token punctuation">=</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">&gt;</span>
          <span class="token punctuation">&lt;</span><span class="token variable">input</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;hidden&quot;</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;_csrf&quot;</span> <span class="token variable">value</span><span class="token punctuation">=</span><span class="token string">&quot;{{csrfToken}}&quot;</span> <span class="token block keyword">/&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">input</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;text&quot;</span> <span class="token variable">placeholder</span><span class="token punctuation">=</span><span class="token string">&quot;Ingrese email&quot;</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;email&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;form-control mb-2&quot;</span>
                <span class="token variable">value</span><span class="token punctuation">=</span><span class="token string">&quot;usuario@test.com&quot;</span><span class="token punctuation">&gt;</span>
            <span class="token punctuation">&lt;</span><span class="token variable">input</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;password&quot;</span> <span class="token variable">placeholder</span><span class="token punctuation">=</span><span class="token string">&quot;Ingrese password&quot;</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;password&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;form-control mb-2&quot;</span>
                <span class="token variable">value</span><span class="token punctuation">=</span><span class="token string">&quot;123123&quot;</span><span class="token punctuation">&gt;</span>
           
            <span class="token punctuation">&lt;</span><span class="token variable">button</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-primary&quot;</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;submit&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Acceder</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">button</span><span class="token punctuation">&gt;</span>
        <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">form</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>


</code></pre></div><p>y asi con todas las vistas que tengan formularios</p> <h3 id="ahora-vamos-a-mandarle-ese-dato-a-la-vista-cuando-renderizamos"><a href="#ahora-vamos-a-mandarle-ese-dato-a-la-vista-cuando-renderizamos" class="header-anchor">#</a> Ahora vamos a mandarle ese dato a la vista cuando renderizamos</h3> <p>authController.js</p> <h4 id="de-forma-manual"><a href="#de-forma-manual" class="header-anchor">#</a> De forma manual:</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">registerForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'register'</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span>mensajes <span class="token operator">:</span> req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> csrfToken<span class="token operator">:</span>req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <p>el método  csrfToken() lo genera csurf cuando lo configuramos con el middleware.</p></div> <h4 id="de-forma-global-a-traves-de-un-middleware"><a href="#de-forma-global-a-traves-de-un-middleware" class="header-anchor">#</a> De forma global a través de un middleware</h4> <ul><li>No se necesita enviarlo en cada ruta como la forma manual.</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span>extended<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// variables globales para las vistas</span>
<span class="token comment">// Enviamos una llave a todas las páginas que renderizamos </span>
  <span class="token comment">// res.locals.nombrellave = valor;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>csrfToken <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <ul><li>Se envia a todas las vistas a traves del middleware.</li> <li>El token se debe enviar después de configurar el body de un formulario (app.use(express.urlencoded({extended:true}))) ya que se envia por POST</li></ul></div> <h2 id="variables-globales"><a href="#variables-globales" class="header-anchor">#</a> Variables globales</h2> <ul><li>Sirven para enviar datos a todas las vistas a través de un middleware.</li> <li>Hacemos más variables globales
authController.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">loginForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'login'</span> <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">registerForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'register'</span> <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// variables globales para las vistas</span>
<span class="token comment">// Enviamos dos llave a todas las paginas que renderizamos </span>
  <span class="token comment">// res.locals.nombrellave = valor;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>csrfToken <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>mensajes <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="cambios-en-el-proyecto"><a href="#cambios-en-el-proyecto" class="header-anchor">#</a> Cambios en el proyecto</h2> <h3 id="verificamos-la-sesion-en-las-rutas-de-home"><a href="#verificamos-la-sesion-en-las-rutas-de-home" class="header-anchor">#</a> Verificamos la sesion en las rutas de home</h3> <div class="custom-block tip"><p class="custom-block-title">observacion</p> <p>Podemos poner varios middleware en una ruta</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>leerUrls <span class="token punctuation">,</span> agregarUrl <span class="token punctuation">,</span> eliminarUrl <span class="token punctuation">,</span> editarUrlForm <span class="token punctuation">,</span> editarUrl <span class="token punctuation">,</span> redireccionamiento<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controllers/homeController'</span> <span class="token punctuation">)</span>
<span class="token keyword">const</span> urlValida <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../middlewares/urlValida'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> verificarUser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../middlewares/verificarUser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token punctuation">,</span> verificarUser<span class="token punctuation">,</span>  leerUrls<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token punctuation">,</span> verificarUser <span class="token punctuation">,</span> urlValida <span class="token punctuation">,</span>  agregarUrl<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/eliminar/:id&quot;</span>  <span class="token punctuation">,</span> verificarUser <span class="token punctuation">,</span> eliminarUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/editar/:id&quot;</span><span class="token punctuation">,</span> verificarUser <span class="token punctuation">,</span>editarUrlForm<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/editar/:id&quot;</span> <span class="token punctuation">,</span> verificarUser <span class="token punctuation">,</span> urlValida <span class="token punctuation">,</span>  editarUrl<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/:url&quot;</span>  <span class="token punctuation">,</span> redireccionamiento<span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>

</code></pre></div><h3 id="ponemos-mensajes-flash-que-se-puedan-ver-en-la-vista-sobre-las-validaciones-de-la-url"><a href="#ponemos-mensajes-flash-que-se-puedan-ver-en-la-vista-sobre-las-validaciones-de-la-url" class="header-anchor">#</a> Ponemos mensajes flash que se puedan ver en la vista sobre las validaciones de la url</h3> <p>middlewares/urlValida.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Modulo que viene incorporado con Node.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">URL</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">urlValidar</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res <span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token comment">// Si todo esta correcto llamamos a next</span>
 <span class="token comment">// next = eliminarUrl</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Leo el body del formulario</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> origin <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
        <span class="token comment">// Se crea una nueva instancia de URL con la informacion del formulario</span>
        <span class="token keyword">const</span> urlFrontend <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//La instancia(objeto) tiene la propiedad origin</span>
        <span class="token comment">//Si es distinto a null , tiene el formato de url</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>urlFrontend<span class="token punctuation">.</span>origin <span class="token operator">!==</span> <span class="token string">&quot;null&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Comprueba que tenga el protocolo http o https y si lo tiene llama al next()</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>
                urlFrontend<span class="token punctuation">.</span>protocol <span class="token operator">===</span> <span class="token string">&quot;http:&quot;</span> <span class="token operator">||</span>
                urlFrontend<span class="token punctuation">.</span>protocol <span class="token operator">===</span> <span class="token string">&quot;https:&quot;</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Tiene que tener https://&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Lanzamos un error en caso que no sea valida</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;no válida 😲&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid URL:&quot;</span><span class="token operator">+</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>message <span class="token operator">===</span> <span class="token string">&quot;Invalid URL: &quot;</span><span class="token operator">+</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>origin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> msg<span class="token operator">:</span> <span class="token string">&quot;URL no válida&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> msg<span class="token operator">:</span> error<span class="token punctuation">.</span>message <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
       
        
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> urlValidar<span class="token punctuation">;</span>

</code></pre></div><h2 id="ref-mongodb"><a href="#ref-mongodb" class="header-anchor">#</a> ref mongoDB</h2> <ul><li>En mongoDB Podemos hacer una referencia (parecido a una relación)
models/Url.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Schema<span class="token punctuation">}</span> <span class="token operator">=</span> mongoose
<span class="token keyword">const</span> urlSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>

    origin<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> String<span class="token punctuation">,</span>
        unique<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    shortURL<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> String<span class="token punctuation">,</span>
        unique<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token punctuation">,</span>
    <span class="token comment">// Referencia a un usuario </span>
    user<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// Schema.Types.ObjectId  =   De tipo ID de un documento de una coleccion.</span>
         type<span class="token operator">:</span> Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span>
         <span class="token comment">// ref: nombre de la coleccion(nombre del modelo) al que hace referencia</span>
         ref<span class="token operator">:</span><span class="token string">&quot;User&quot;</span> <span class="token punctuation">,</span>
         required<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> Url <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Url'</span><span class="token punctuation">,</span> urlSchema<span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Url<span class="token punctuation">;</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Explicacion como si fuera relacional</p> <ul><li>Se hace una referencia a la columna _id(type:Schema.Types.ObjectId) de la tabla User(ref:”User”).</li> <li>_id lo genera mongoDB de manera automática.</li></ul></div> <p>HomeController.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Importamos el modelo</span>
<span class="token keyword">const</span> Url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../models/Url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>nanoid<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'nanoid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">leerUrls</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token comment">// req.user es la informacion del usuario que se encuentra en la sesion</span>
     <span class="token comment">// Buscamos todas las url donde user = req.user.id</span>
      <span class="token keyword">const</span> urls <span class="token operator">=</span> <span class="token keyword">await</span> Url<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>user<span class="token operator">:</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home'</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span>urls<span class="token operator">:</span>urls <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">agregarUrl</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>origin<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Generamos una nueva instancia del modelo con la id del usuario</span>
       <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Url</span><span class="token punctuation">(</span><span class="token punctuation">{</span>origin<span class="token operator">:</span>origin <span class="token punctuation">,</span> shortURL<span class="token operator">:</span><span class="token function">nanoid</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> user<span class="token operator">:</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token punctuation">)</span>
       <span class="token keyword">await</span> url<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span><span class="token string">&quot;URL AGREGADA&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
       res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">eliminarUrl</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Buscamos la url por la id</span>
       <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">await</span> Url<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// Si la url no pertenece al usuario</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>url<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;No es tu url &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token comment">// Lo eliminamos  de la BD con el metodo remove() que viene del objeto MongoDB</span>
       <span class="token keyword">await</span> url<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span><span class="token string">&quot;URL ELIMINADA&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
       res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">editarUrlForm</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      
       <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">await</span> Url<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lean</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>url<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;No es tu url &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      
       res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>url<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">editarUrl</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  
    <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>origin<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token comment">// Buscamos la url por la id</span>
       <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">await</span> Url<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// Si la url no pertenece al usuario</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>url<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;No es tu url &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token comment">// Lo actualizamos  en la BD con el metodo updateOne() que viene del objeto MongoDB</span>
       <span class="token comment">//recibe un objeto{} con los datos que se van a editar</span>
       <span class="token comment">//origin:origin</span>
       <span class="token keyword">await</span> url<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>origin<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span><span class="token string">&quot;URL EDITADA&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
       res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">redireccionamiento</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>url<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token comment">// Modificar en la documentacion</span>
       <span class="token keyword">const</span> urlDB <span class="token operator">=</span> <span class="token keyword">await</span> Url<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>shortURL<span class="token operator">:</span> url <span class="token punctuation">}</span><span class="token punctuation">)</span>
       res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>urlDB<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> <span class="token string">&quot;No existe esta url configurada&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/login'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
   module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>leerUrls <span class="token punctuation">,</span> agregarUrl <span class="token punctuation">,</span> eliminarUrl <span class="token punctuation">,</span> editarUrlForm <span class="token punctuation">,</span> editarUrl <span class="token punctuation">,</span> redireccionamiento<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="nodemailer"><a href="#nodemailer" class="header-anchor">#</a> Nodemailer</h2> <ul><li>Es un <a href="https://nodemailer.com/about/" target="_blank" rel="noopener noreferrer">módulo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> para enviar correos electrónicos</li> <li>Para usarlo ,  se debe configurar un hosting (Gmail, servidor, etc) para   que acepte el envío de información.</li> <li>Para simular un hosting usaremos <a href="https://mailtrap.io" target="_blank" rel="noopener noreferrer">mailtrap<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> que prueba los correo electronicos y simula que los esta enviando. Tambien nos permite ver los correos enviados.</li></ul> <h3 id="guia-de-mailtrap"><a href="#guia-de-mailtrap" class="header-anchor">#</a> Guia de mailtrap</h3> <ol><li>Nos registramos</li> <li>En integraciones nos aparece NodeMailer</li> <li>AL SELECCIONARLO ,NOS APARECE LA CONFIGURACION para crear el transportador</li></ol> <p>Algo asi:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> transport <span class="token operator">=</span> nodemailer<span class="token punctuation">.</span><span class="token function">createTransport</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  host<span class="token operator">:</span> <span class="token string">&quot;smtp.mailtrap.io&quot;</span><span class="token punctuation">,</span>
  port<span class="token operator">:</span> <span class="token number">2525</span><span class="token punctuation">,</span>
  auth<span class="token operator">:</span> <span class="token punctuation">{</span>
    user<span class="token operator">:</span> <span class="token string">&quot;815fddfe9d615f&quot;</span><span class="token punctuation">,</span>
    pass<span class="token operator">:</span> <span class="token string">&quot;8a37d820c188a6&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><ol start="4"><li>Lo de la autenticación lo vamos a tener que pasar a un archivo .env ya que es información sensible</li></ol> <h3 id="guia-de-nodemailer"><a href="#guia-de-nodemailer" class="header-anchor">#</a> Guia  de NodeMailer</h3> <ol><li>Se importa</li> <li>Se crea un transportador con las configuraciones del hosting</li> <li>Se envia el correo</li></ol> <h3 id="en-el-proyecto-4"><a href="#en-el-proyecto-4" class="header-anchor">#</a> En el proyecto</h3> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm install nodemailer
</code></pre></div><p>AuthController.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> nodemailer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;nodemailer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">registerUser</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  
  <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/register'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>userName <span class="token punctuation">,</span> email <span class="token punctuation">,</span> password<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        
       <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token operator">:</span>email<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
       <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'ya existe el usuario'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     
      user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">{</span>userName <span class="token punctuation">,</span> email <span class="token punctuation">,</span> password  <span class="token punctuation">,</span> tokenConfirm<span class="token operator">:</span> <span class="token function">nanoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// Creamos el transportador</span>
      <span class="token keyword">const</span> transporte <span class="token operator">=</span> nodemailer<span class="token punctuation">.</span><span class="token function">createTransport</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        host<span class="token operator">:</span> <span class="token string">&quot;smtp.mailtrap.io&quot;</span><span class="token punctuation">,</span>
        port<span class="token operator">:</span> <span class="token number">2525</span><span class="token punctuation">,</span>
        auth<span class="token operator">:</span> <span class="token punctuation">{</span>
          user<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>userEmail<span class="token punctuation">,</span>
          pass<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>userPassword
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Enviamos el correo </span>
      <span class="token keyword">let</span> info <span class="token operator">=</span> <span class="token keyword">await</span> transporte<span class="token punctuation">.</span><span class="token function">sendMail</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// Quien lo envia</span>
        from<span class="token operator">:</span> <span class="token string">'&quot;Fred Foo 👻&quot; &lt;foo@example.com&gt;'</span><span class="token punctuation">,</span> 
        <span class="token comment">// A quien se envia</span>
        to<span class="token operator">:</span> user<span class="token punctuation">.</span>email<span class="token punctuation">,</span> 
        <span class="token comment">// Asunto</span>
        subject<span class="token operator">:</span> <span class="token string">&quot;Verifica tu cuenta de correo&quot;</span><span class="token punctuation">,</span>
        <span class="token comment">//texto plano  </span>
        <span class="token comment">//text: &quot;Hello world?&quot;,</span>
        <span class="token comment">//texto en HTML</span>
        html<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;a href=&quot;http://localhost:5000/auth/confirmarCuenta/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token punctuation">.</span>tokenConfirm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;Verifica tu cuenta aqui&lt;/a&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> 
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> <span class="token string">&quot;Revisa tu correo electronico y valida cuenta&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/auth/register'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <p>el require('dotenv').config() se ubica en todos los archivos que utiliza variables de entorno</p></div> <p>.env</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">URI</span><span class="token operator">=</span>mongodb<span class="token operator">+</span>srv<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>User_API<span class="token operator">:</span>contraseña@cluster<span class="token punctuation">.</span>xcibc<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>net<span class="token operator">/</span>dbUrl<span class="token operator">?</span>retryWrites<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>w<span class="token operator">=</span>majority
userEmail<span class="token operator">=</span><span class="token number">815</span>fddfe9d615f
userPassword<span class="token operator">=</span><span class="token number">8</span>a37d820c188a6

</code></pre></div><h2 id="subir-archivos"><a href="#subir-archivos" class="header-anchor">#</a> Subir archivos</h2> <ul><li><p><a href="https://picsum.photos" target="_blank" rel="noopener noreferrer">Pagina para generar imagen aleatoria<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>Las imagenes las guardamos en la carpeta publica (En este ejemplo public/img/perfiles)</p></li> <li><p>El modulo <a href="https://www.npmjs.com/package/multer" target="_blank" rel="noopener noreferrer">multer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> o el modulo <a href="https://www.npmjs.com/package/formidable" target="_blank" rel="noopener noreferrer">formidable<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> contiene la logica para manipular las imagenes</p></li> <li><p>En el ejemplo se utiliza formidable</p></li> <li><p>También usaremos el módulo <a href="https://www.npmjs.com/package/jimp" target="_blank" rel="noopener noreferrer">jimp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>   para editar la imagen (redimensionar , quitar calidad , etc)
Models/User</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> UserSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  
   userName<span class="token operator">:</span> <span class="token punctuation">{</span>
       type<span class="token operator">:</span>String<span class="token punctuation">,</span>
       lowercase<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
       required<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token punctuation">}</span> <span class="token punctuation">,</span>

   email<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span>String<span class="token punctuation">,</span>
    lowercase<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    required<span class="token operator">:</span><span class="token boolean">true</span> <span class="token punctuation">,</span>
    unique <span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">,</span>
    <span class="token comment">// Indexar</span>
    index<span class="token operator">:</span> <span class="token punctuation">{</span>unique <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span> <span class="token punctuation">,</span> 
<span class="token punctuation">}</span> <span class="token punctuation">,</span>

password<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span>String <span class="token punctuation">,</span>
    required <span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">,</span>

<span class="token punctuation">}</span> <span class="token punctuation">,</span>

tokenConfirm <span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span>String <span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token punctuation">,</span>

cuentaConfirmada<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span>Boolean<span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span><span class="token boolean">false</span>
<span class="token punctuation">}</span> <span class="token punctuation">,</span> 
imagen<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span>String <span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p>views/perfil.hbs</p> <div class="language-hbs extra-class"><pre class="language-hbs"><code>
<span class="token punctuation">&lt;</span><span class="token variable">h1</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;text-center&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Nombre</span> <span class="token variable">del</span> <span class="token variable">usuario</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">h1</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">p</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;text-center&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Edita</span> <span class="token variable">aqui</span> <span class="token variable">tu</span> <span class="token variable">perfil</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">p</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">div</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;my-2 text-center&quot;</span><span class="token punctuation">&gt;</span>
    <span class="token punctuation">&lt;</span><span class="token variable">img</span> <span class="token variable">src</span><span class="token punctuation">=</span><span class="token string">&quot;/img/perfiles/imagen.jpg&quot;</span> <span class="token variable">alt</span><span class="token punctuation">=</span><span class="token string">&quot;&quot;</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;rounded-circle&quot;</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">div</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token variable">form</span> <span class="token variable">action</span><span class="token punctuation">=</span><span class="token string">&quot;/perfil?_csrf={{csrfToken}}&quot;</span> <span class="token variable">method</span><span class="token punctuation">=</span><span class="token string">&quot;post&quot;</span> <span class="token variable">enctype</span><span class="token punctuation">=</span><span class="token string">&quot;multipart/form-data&quot;</span><span class="token punctuation">&gt;</span>
 <span class="token punctuation">&lt;</span><span class="token variable">input</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;form-control mb-2 form-control-sm&quot;</span> <span class="token variable">type</span><span class="token punctuation">=</span><span class="token string">&quot;file&quot;</span> <span class="token variable">id</span><span class="token punctuation">=</span><span class="token string">&quot;formFile&quot;</span> <span class="token variable">name</span><span class="token punctuation">=</span><span class="token string">&quot;myFile&quot;</span> <span class="token block keyword">/&gt;</span>
 <span class="token punctuation">&lt;</span><span class="token variable">button</span> <span class="token variable">class</span><span class="token punctuation">=</span><span class="token string">&quot;btn btn-dark my-3&quot;</span><span class="token punctuation">&gt;</span><span class="token variable">Cambiar</span> <span class="token variable">imagen</span> <span class="token variable">de</span> <span class="token variable">perfil</span><span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">button</span><span class="token punctuation">&gt;</span>
<span class="token punctuation">&lt;</span><span class="token punctuation">/</span><span class="token variable">form</span><span class="token punctuation">&gt;</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <ul><li>Usa(atributo-valor)  enctype=&quot;multipart/form-data&quot; en el formulario para enviar imágenes.</li> <li>Usar el atributo multiple en el input file si desea subir varios archivos.</li> <li>Para los formularios que contienen imágenes, el token de csurf debe enviarse como query(a través de la url)</li></ul> <div class="language-html extra-class"><pre class="language-html"><code>action=&quot;/perfil?_csrf={{csrfToken}}&quot;
</code></pre></div></div> <p>Creamos un archivo perfilController.js dentro de la carpeta controllers.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Otra forma de exportar</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//module.exports.nombrefuncion = funcion</span>
<span class="token comment">// se exporta el nombrefuncion </span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">formPerfil</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;perfil&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">editarFotoPerfil</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   
<span class="token punctuation">}</span> 

</code></pre></div><p>routes/home.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> formPerfil<span class="token punctuation">,</span> editarFotoPerfil <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controllers/perfilController'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/perfil&quot;</span> <span class="token punctuation">,</span> verificarUser <span class="token punctuation">,</span> formPerfil<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/perfil&quot;</span> <span class="token punctuation">,</span> verificarUser <span class="token punctuation">,</span> editarFotoPerfil<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>views/components/Navbar.hbs</p> <ul><li>Añadimos la ruta en el menú</li></ul> <div class="language-html extra-class"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>navbar-nav ms-auto<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nav-link active<span class="token punctuation">&quot;</span></span> <span class="token attr-name">aria-current</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>page<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Home<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nav-link<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/auth/register<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Register<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nav-link<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/perfil<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Perfil<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nav-link<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/auth/login<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Login<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nav-link<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/auth/logout<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>LogOut<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><h2 id="formidable"><a href="#formidable" class="header-anchor">#</a> Formidable</h2> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm i formidable
</code></pre></div><h3 id="pequeno-tutorial"><a href="#pequeno-tutorial" class="header-anchor">#</a> Pequeño tutorial</h3> <ol><li>Se crea una instancia</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> form <span class="token operator">=</span> <span class="token function">formidable</span><span class="token punctuation">(</span><span class="token punctuation">{</span> multiples<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <ul><li>multiples = boolean Sirve para especificar si son varias imágenes</li></ul></div> <ol start="2"><li>Usamos el metodo parse() de la instancia para leer y procesar la imagen</li></ol> <ul><li>A través de files (parámetro del callback de la función parse()), tenemos toda la información de la imagen (extensión , tamaño ,etc). Toda esa información viene de una propiedad que se llama igual que el valor del atributo name del input file</li></ul> <p>perfilController.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> formidable <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'formidable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//module.exports.nombrefuncion = funcion</span>
<span class="token comment">// se exporta el nombrefuncion </span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">formPerfil</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;perfil&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">editarFotoPerfil</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token comment">// Instanciamos un objeto formidable</span>
   <span class="token keyword">const</span> form <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">formidable<span class="token punctuation">.</span>IncomingForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token comment">// Especificamos el tamaño  maximo del archivo</span>
   <span class="token comment">// 50 * 1024 * 1024 = 5MB </span>
   form<span class="token punctuation">.</span>maxFileSize <span class="token operator">=</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>
   <span class="token comment">//parse(de donde viene la imagen , funcion)</span>
   form<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req <span class="token punctuation">,</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> fields <span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// Si tiene un error</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No es una imagen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//Contiene toda la informacion de la imagen</span>
      <span class="token comment">// La propiedad myFile se llama igual que el valor del atributo name del input file </span>
      <span class="token comment">// Por lo tanto el nombre de la propiedad cambia , si el valor del atributo name cambia</span>
      <span class="token keyword">const</span> file <span class="token operator">=</span> files<span class="token punctuation">.</span>myFile<span class="token punctuation">;</span>
      <span class="token comment">// Validaciones</span>
      <span class="token comment">// Comprobar que existe una imagen</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>originalFilename <span class="token operator">===</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Por favor agrega una imagen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Validamos el formato de la imagen</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>mimetype <span class="token operator">==</span> <span class="token string">&quot;image/jpeg&quot;</span> <span class="token operator">||</span> file<span class="token punctuation">.</span>mimetype <span class="token operator">==</span> <span class="token string">&quot;image/png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Por favor agrega una imagen .pjg o .png'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
      <span class="token comment">// Validamos el tamaño  (que sea menor a 5mb)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Menos de 5mb '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Sacamos la extension</span>
      <span class="token keyword">const</span> extension <span class="token operator">=</span> file<span class="token punctuation">.</span>mimetype<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// Donde se va a guardar la imagen </span>
      <span class="token keyword">const</span> dirFile <span class="token operator">=</span> __dirname <span class="token operator">+</span> <span class="token string">&quot;../public/perfiles/&quot;</span>
       req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> <span class="token string">&quot;Ya se subio la imagen&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/perfil'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/perfil'</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> 

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">__dirname</p> <p>devuelve la Ubicación del archivo</p></div> <h2 id="modulo-nativo-path-join"><a href="#modulo-nativo-path-join" class="header-anchor">#</a> Modulo nativo Path (Join)</h2> <ul><li>Tiene el método join que nos permite formar una ruta</li> <li>También nos permite usar los “puntos” para la ubicación de archivos (../.)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path  <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Donde se va a guardar la imagen </span>
<span class="token comment">// __dirname/../public/perfiles/id.extension</span>
 <span class="token keyword">const</span> dirFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname <span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../public/img/perfiles/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extension<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="file-system"><a href="#file-system" class="header-anchor">#</a> file System</h2> <ul><li>Ahora vamos a usar el modulo file System para guardar el archivo.</li> <li>Sirve para manipular los archivos</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Sacamos la extension</span>
      <span class="token keyword">const</span> extension <span class="token operator">=</span> file<span class="token punctuation">.</span>mimetype<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// Donde se va a guardar la imagen </span>
      <span class="token keyword">const</span> dirFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname <span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../public/img/perfiles/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extension<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Guardamos la imagen  con el metodo renameSync</span>
      <span class="token comment">// renameSync(ruta_vieja , ruta_mueva)</span>
      <span class="token comment">// la propiedad filepath contiene la ubicacion del archivo</span>
       fs<span class="token punctuation">.</span><span class="token function">renameSync</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>filepath <span class="token punctuation">,</span> dirFile <span class="token punctuation">)</span><span class="token punctuation">;</span>
       req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> <span class="token string">&quot;Ya se subio la imagen&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>Completo:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> formidable <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'formidable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path  <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">formPerfil</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;perfil&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">editarFotoPerfil</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token comment">// Instanciamos un objeto formidable</span>
   <span class="token keyword">const</span> form <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">formidable<span class="token punctuation">.</span>IncomingForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token comment">// Especificamos el tamaño  maximo del archivo</span>
   <span class="token comment">// 50 * 1024 * 1024 = 5MB </span>
   form<span class="token punctuation">.</span>maxFileSize <span class="token operator">=</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>
   <span class="token comment">//parse(de donde viene la imagen , funcion)</span>
   form<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req <span class="token punctuation">,</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> fields <span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// Si tiene un error</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No es una imagen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//Contiene toda la informacion de la imagen</span>
      <span class="token comment">// La propiedad myFile se llama igual que el valor del atributo name del input file </span>
      <span class="token comment">// Por lo tanto el nombre de la propiedad cambia , si el valor del atributo name cambia</span>
      <span class="token keyword">const</span> file <span class="token operator">=</span> files<span class="token punctuation">.</span>myFile<span class="token punctuation">;</span>
      <span class="token comment">// Validaciones</span>
      <span class="token comment">// Comprobar que existe una imagen</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>originalFilename <span class="token operator">===</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Por favor agrega una imagen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Validamos el formato de la imagen</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>mimetype <span class="token operator">==</span> <span class="token string">&quot;image/jpeg&quot;</span> <span class="token operator">||</span> file<span class="token punctuation">.</span>mimetype <span class="token operator">==</span> <span class="token string">&quot;image/png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Por favor agrega una imagen .pjg o .png'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
      <span class="token comment">// Validamos el tamaño  (que sea menor a 5mb)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Menos de 5mb '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Sacamos la extension</span>
      <span class="token keyword">const</span> extension <span class="token operator">=</span> file<span class="token punctuation">.</span>mimetype<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// Donde se va a guardar la imagen </span>
      <span class="token keyword">const</span> dirFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname <span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../public/img/perfiles/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extension<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Guardamos la imagen  con el metodo renameSync</span>
      <span class="token comment">// renameSync(ruta_vieja , ruta_mueva)</span>
      <span class="token comment">// la propiedad filepath contiene la ubicacion del archivo</span>
       fs<span class="token punctuation">.</span><span class="token function">renameSync</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>filepath <span class="token punctuation">,</span> dirFile <span class="token punctuation">)</span><span class="token punctuation">;</span>
       req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> <span class="token string">&quot;Ya se subio la imagen&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/perfil'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/perfil'</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> 

</code></pre></div><h3 id="a-guardar-en-la-bd-la-url-de-la-imagen"><a href="#a-guardar-en-la-bd-la-url-de-la-imagen" class="header-anchor">#</a> A guardar en la BD la url de la imagen</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>el método save() viene de un objeto mongoDB que nos permite guardar en la BD el objeto.</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> formidable <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'formidable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path  <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../models/User'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">formPerfil</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;perfil&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">editarFotoPerfil</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token comment">// Instanciamos un objeto formidable</span>
   <span class="token keyword">const</span> form <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">formidable<span class="token punctuation">.</span>IncomingForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token comment">// Especificamos el tamaño  maximo del archivo</span>
   <span class="token comment">// 50 * 1024 * 1024 = 5MB </span>
   form<span class="token punctuation">.</span>maxFileSize <span class="token operator">=</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>
   <span class="token comment">//parse(de donde viene la imagen , funcion)</span>
   form<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req <span class="token punctuation">,</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> fields <span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// Si tiene un error</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No es una imagen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//Contiene toda la informacion de la imagen</span>
      <span class="token comment">// La propiedad myFile se llama igual que el valor del atributo name del input file </span>
      <span class="token comment">// Por lo tanto el nombre de la propiedad cambia , si el valor del atributo name cambia</span>
      <span class="token keyword">const</span> file <span class="token operator">=</span> files<span class="token punctuation">.</span>myFile<span class="token punctuation">;</span>
      <span class="token comment">// Validaciones</span>
      <span class="token comment">// Comprobar que existe una imagen</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>originalFilename <span class="token operator">===</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Por favor agrega una imagen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Validamos el formato de la imagen</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>mimetype <span class="token operator">==</span> <span class="token string">&quot;image/jpeg&quot;</span> <span class="token operator">||</span> file<span class="token punctuation">.</span>mimetype <span class="token operator">==</span> <span class="token string">&quot;image/png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Por favor agrega una imagen .pjg o .png'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
      <span class="token comment">// Validamos el tamaño  (que sea menor a 5mb)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Menos de 5mb '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Sacamos la extension</span>
      <span class="token keyword">const</span> extension <span class="token operator">=</span> file<span class="token punctuation">.</span>mimetype<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// Donde se va a guardar la imagen </span>
      <span class="token keyword">const</span> dirFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname <span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../public/img/perfiles/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extension<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Guardamos la imagen  con el metodo renameSync</span>
      <span class="token comment">// renameSync(ruta_vieja , ruta_mueva)</span>
      <span class="token comment">// la propiedad filepath contiene la ubicacion del archivo</span>
       fs<span class="token punctuation">.</span><span class="token function">renameSync</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>filepath <span class="token punctuation">,</span> dirFile <span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// La guardamos en la BD</span>
       <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
       user<span class="token punctuation">.</span>imagen <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extension<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
       <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> <span class="token string">&quot;Ya se subio la imagen&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/perfil'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/perfil'</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> 

</code></pre></div><h2 id="jimp"><a href="#jimp" class="header-anchor">#</a> jimp</h2> <ul><li>Usamos el modulo jimp para modificar la imagen</li></ul> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm i jimp
</code></pre></div><p>Despues de guardar la imagen:</p> <div class="language-js extra-class"><pre class="language-js"><code>fs<span class="token punctuation">.</span><span class="token function">renameSync</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>filepath <span class="token punctuation">,</span> dirFile <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Leemos la imagen (creamos una  instancia)</span>
     <span class="token keyword">const</span> image <span class="token operator">=</span>  <span class="token keyword">await</span> Jimp<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>dirFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">// Cambiamos el tamaño  (resize)</span>
     <span class="token comment">// Cambiamos la calidad (quality)</span>
     <span class="token comment">// Lo volvemos a guardar (writeAsync)</span>
      image<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">quality</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeAsync</span><span class="token punctuation">(</span>dirFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="lo-mostramos-en-la-ruta"><a href="#lo-mostramos-en-la-ruta" class="header-anchor">#</a> Lo mostramos en la ruta:</h3> <p>perfileController.js</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">formPerfil</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;perfil&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span>user<span class="token operator">:</span> req<span class="token punctuation">.</span>user <span class="token punctuation">,</span> imagen<span class="token operator">:</span> user<span class="token punctuation">.</span>imagen<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> <span class="token string">&quot;Error al leer el usuario&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/perfil'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 

</code></pre></div><p>views/perfi.hbs</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>h1 <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;text-center&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>userName<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;text-center&quot;</span><span class="token operator">&gt;</span>Edita aqui tu perfil<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;my-2 text-center&quot;</span><span class="token operator">&gt;</span>
   <span class="token punctuation">{</span><span class="token punctuation">{</span>#<span class="token keyword">if</span> imagen<span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">&quot;/img/perfiles/{{imagen}}&quot;</span> alt<span class="token operator">=</span><span class="token string">&quot;&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;rounded-circle&quot;</span><span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token keyword">else</span><span class="token punctuation">}</span><span class="token punctuation">}</span> 
             <span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">&quot;/img/perfiles/imagen.jpg&quot;</span> alt<span class="token operator">=</span><span class="token string">&quot;&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;rounded-circle&quot;</span><span class="token operator">&gt;</span>
   <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
  
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>form action<span class="token operator">=</span><span class="token string">&quot;/perfil?_csrf={{csrfToken}}&quot;</span> method<span class="token operator">=</span><span class="token string">&quot;post&quot;</span> enctype<span class="token operator">=</span><span class="token string">&quot;multipart/form-data&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;form-control mb-2 form-control-sm&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;file&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;formFile&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;myFile&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>button <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn btn-dark my-3&quot;</span><span class="token operator">&gt;</span>Cambiar imagen de perfil<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>

</code></pre></div><h2 id="connet-mongo"><a href="#connet-mongo" class="header-anchor">#</a> connet-mongo</h2> <ul><li>Las sesiones trabajan en memoria local (en el servidor/PC)</li> <li>Express recomienda que en producción (deploy) no trabajemos con la sesion en memoria.</li> <li>Usaremos el modulo connect-mongo para respaldar la sesion en la BD.</li></ul> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm i <span class="token function">connect-mongo</span>
</code></pre></div><p>database/conexion.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Habilitamos las variables de entorno</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> clientDB <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">URI</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;db conectada 🔥&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Devolvemos el cliente por el cual nos conectamos a la BD</span>
    <span class="token keyword">return</span> m<span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Fallo la conexion&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> clientDB<span class="token punctuation">;</span>

</code></pre></div><p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-session&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> MongoStore <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;connect-mongo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> flash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;connect-flash&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> create <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-handlebars&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> passport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;passport&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./models/User&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> clientDB <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./database/conexion'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> csrf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;csurf&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> hbs <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    extname<span class="token operator">:</span> <span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">,</span>
    partialsDir<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;views/components&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <ul><li>Toda la ejecución de un código (conexión a la BD y retornar algo) se fue a una constante.</li> <li>Al usar el require() se ejecuta el codigo y lo que se devuelve lo contiene la variable clientDB.</li></ul></div> <h3 id="configuramos-las-sesiones-para-que-se-respalden-en-la-bd"><a href="#configuramos-las-sesiones-para-que-se-respalden-en-la-bd" class="header-anchor">#</a> Configuramos las sesiones para que se respalden en la BD.</h3> <p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-session&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> MongoStore <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;connect-mongo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> flash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;connect-flash&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> create <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-handlebars&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> passport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;passport&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./models/User&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> clientDB <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./database/conexion'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> csrf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;csurf&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> hbs <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    extname<span class="token operator">:</span> <span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">,</span>
    partialsDir<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;views/components&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      secret<span class="token operator">:</span> <span class="token string">'palabra secreta'</span><span class="token punctuation">,</span>
      resave<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      saveUninitialized<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">&quot;nombre de secreto&quot;</span> <span class="token punctuation">,</span>
      <span class="token comment">// create({configuraciones})</span>
      store <span class="token operator">:</span> MongoStore<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// Conexion a la BD</span>
           clientPromise<span class="token operator">:</span> clientDB <span class="token punctuation">,</span>
        <span class="token comment">// Nombre de la BD</span>
        dbName <span class="token operator">:</span>  <span class="token string">'dbUrl'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>  

</code></pre></div><h2 id="saniteze-mongo"><a href="#saniteze-mongo" class="header-anchor">#</a> Saniteze mongo</h2> <ul><li>Es un middleware para evitar inyecciones(ataques) en la BD.</li> <li>Existen dos modulos con la misma funcion :  <a href="https://www.npmjs.com/package/mongo-sanitize" target="_blank" rel="noopener noreferrer">mongo-sanitize<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> o <a href="https://www.npmjs.com/package/express-mongo-sanitize" target="_blank" rel="noopener noreferrer">express-mongo-sanitize<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Utilizaremos el segundo</li></ul> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm i express<span class="token operator">-</span>mongo<span class="token operator">-</span>sanitize
</code></pre></div><p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-session&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mongoSanitize <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-mongo-sanitize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> MongoStore <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;connect-mongo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> flash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;connect-flash&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> create <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-handlebars&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> passport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;passport&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./models/User&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> clientDB <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./database/conexion'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> csrf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;csurf&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> hbs <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    extname<span class="token operator">:</span> <span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">,</span>
    partialsDir<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;views/components&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      secret<span class="token operator">:</span> <span class="token string">'palabra secreta'</span><span class="token punctuation">,</span>
      resave<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      saveUninitialized<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">&quot;nombre de secreto&quot;</span> <span class="token punctuation">,</span>
   
      store <span class="token operator">:</span> MongoStore<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
           clientPromise<span class="token operator">:</span> clientDB <span class="token punctuation">,</span>
        dbName <span class="token operator">:</span>  <span class="token string">'dbUrl'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>  
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>passport<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>passport<span class="token punctuation">.</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
passport<span class="token punctuation">.</span><span class="token function">serializeUser</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user <span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span>id<span class="token operator">:</span> user<span class="token punctuation">.</span>_id <span class="token punctuation">,</span> userName<span class="token operator">:</span> user<span class="token punctuation">.</span>userName<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
passport<span class="token punctuation">.</span><span class="token function">deserializeUser</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">user <span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token keyword">const</span> userDB <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span>  <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span>id<span class="token operator">:</span>userDB<span class="token punctuation">.</span>_id <span class="token punctuation">,</span> userName<span class="token operator">:</span> userDB<span class="token punctuation">.</span>userName<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span>extended<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Utilizamos el middleware</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">mongoSanitize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>csrfToken <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>mensajes <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="cors"><a href="#cors" class="header-anchor">#</a> CORS</h2> <ul><li>modulo <a href="https://expressjs.com/en/resources/middleware/cors.html" target="_blank" rel="noopener noreferrer">cors<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Sirve para especificar que dominios van a consumir esta aplicación/sitio web / etc.</li></ul> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm install cors
</code></pre></div><p>.env</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">URI</span><span class="token operator">=</span>mongodb<span class="token operator">+</span>srv<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>User_API<span class="token operator">:</span>contraseña@cluster<span class="token punctuation">.</span>xcibc<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>net<span class="token operator">/</span>dbUrl<span class="token operator">?</span>retryWrites<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>w<span class="token operator">=</span>majority
userEmail<span class="token operator">=</span><span class="token number">815</span>fddfe9d615f
userPassword<span class="token operator">=</span><span class="token number">8</span>a37d820c188a6
<span class="token constant">PATHOSTING</span><span class="token operator">=</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <p>Podemos crear variables de entornos vacia (PATHOSTING)</p></div> <p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-session&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mongoSanitize <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-mongo-sanitize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> MongoStore <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;connect-mongo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> flash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;connect-flash&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> create <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-handlebars&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> passport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;passport&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./models/User&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> clientDB <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./database/conexion'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> csrf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;csurf&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;cors&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> hbs <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    extname<span class="token operator">:</span> <span class="token string">&quot;.hbs&quot;</span><span class="token punctuation">,</span>
    partialsDir<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;views/components&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Configuramos el cors</span>
<span class="token keyword">const</span> corsOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  credentials<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token comment">// Que persona(servicios) van a consumir esta app</span>
  <span class="token comment">// &quot;*&quot; = Todas las personas</span>
  <span class="token comment">// Si NO existe la variable de entorno , todas las persona pueden consumir esta app</span>
  origin<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PATHOSTING</span> <span class="token operator">||</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// Los metodos HTTP que utilizamos </span>
  methods<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'GET'</span> <span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// Usamos el cors con la configuracion que especificamos</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span>corsOptions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      secret<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SECRETSESSION</span><span class="token punctuation">,</span>
      resave<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      saveUninitialized<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">&quot;nombre de secreto&quot;</span> <span class="token punctuation">,</span>

      store <span class="token operator">:</span> MongoStore<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
 
           clientPromise<span class="token operator">:</span> clientDB <span class="token punctuation">,</span>
 
        dbName <span class="token operator">:</span>  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DBNAME</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>  
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">flash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <ul><li>Un formulario HTML solo envia GET Y POST</li> <li>Con fetch y Axios (JS ) podemos establecer métodos PUT , DELETE , ETC.</li></ul></div> <h2 id="modificaciones-para-el-deploy"><a href="#modificaciones-para-el-deploy" class="header-anchor">#</a> Modificaciones para el deploy</h2> <p>.env</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">URI</span><span class="token operator">=</span>mongodb<span class="token operator">+</span>srv<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>User_API<span class="token operator">:</span>contraseña@cluster<span class="token punctuation">.</span>xcibc<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>net<span class="token operator">/</span>dbUrl<span class="token operator">?</span>retryWrites<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>w<span class="token operator">=</span>majority
userEmail<span class="token operator">=</span><span class="token number">815</span>fddfe9d615f
userPassword<span class="token operator">=</span><span class="token number">8</span>a37d820c188a6
<span class="token constant">PATHOSTING</span><span class="token operator">=</span>
<span class="token constant">SECRETSESSION</span><span class="token operator">=</span><span class="token number">815</span>fddfe9d615f

</code></pre></div><p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      secret<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SECRETSESSION</span><span class="token punctuation">,</span>
      resave<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      saveUninitialized<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">&quot;nombre de secreto&quot;</span> <span class="token punctuation">,</span>

      store <span class="token operator">:</span> MongoStore<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
 
           clientPromise<span class="token operator">:</span> clientDB <span class="token punctuation">,</span>
 
        dbName <span class="token operator">:</span>  <span class="token string">'dbUrl'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>  

</code></pre></div><p>authController.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Enviamos el correo </span>
      <span class="token keyword">let</span> info <span class="token operator">=</span> <span class="token keyword">await</span> transporte<span class="token punctuation">.</span><span class="token function">sendMail</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// Quien lo envia</span>
        from<span class="token operator">:</span> <span class="token string">'&quot;Fred Foo 👻&quot; &lt;foo@example.com&gt;'</span><span class="token punctuation">,</span> 
        <span class="token comment">// A quien se envia</span>
        to<span class="token operator">:</span> user<span class="token punctuation">.</span>email<span class="token punctuation">,</span> 
        <span class="token comment">// Asunto</span>
        subject<span class="token operator">:</span> <span class="token string">&quot;Verifica tu cuenta de correo&quot;</span><span class="token punctuation">,</span>
        <span class="token comment">//texto plano  </span>
        <span class="token comment">//text: &quot;Hello world?&quot;,</span>
        <span class="token comment">//texto en HTML</span>
        html<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;a href=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PATHOSTING</span> <span class="token operator">||</span> <span class="token string">&quot;http://localhost:5000&quot;</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/auth/confirmarCuenta/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token punctuation">.</span>tokenConfirm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;Verifica tu cuenta aqui&lt;/a&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> 
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>public/js/app.js</p> <div class="language-js extra-class"><pre class="language-js"><code>document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span> <span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>short<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// El window es global , se puede omitir</span>
         <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>origin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>short<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

</code></pre></div><p>package.json</p> <div class="language-json extra-class"><pre class="language-json"><code>  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon index.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node index.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <p>Script start = Es el que ejecuta heroku</p></div> <h2 id="cookies-segura"><a href="#cookies-segura" class="header-anchor">#</a> Cookies segura</h2> <ul><li>Le da seguridad al servidor</li></ul> <h3 id="pasos"><a href="#pasos" class="header-anchor">#</a> Pasos</h3> <ol><li>Borramos las sesiones en la BD</li> <li>Modificamos el index.js</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span>corsOptions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Para que el secure : true funcione</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;trust proxy&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
 <span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
     secret<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SECRETSESSION</span><span class="token punctuation">,</span>
     resave<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
     saveUninitialized<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
     name<span class="token operator">:</span> <span class="token string">&quot;nombre de secreto&quot;</span> <span class="token punctuation">,</span>

     store <span class="token operator">:</span> MongoStore<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>

          clientPromise<span class="token operator">:</span> clientDB <span class="token punctuation">,</span>

       dbName <span class="token operator">:</span>  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DBNAME</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
     <span class="token comment">// Habilitamos las cookies seguras</span>
     <span class="token comment">// secure : true es para https</span>
     <span class="token comment">// secure : false es para http</span>
     <span class="token comment">// Si esta en produccion , habilitamos las cookies seguras</span>
     cookie<span class="token operator">:</span> <span class="token punctuation">{</span> secure<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MODO</span> <span class="token operator">===</span> <span class="token string">'production'</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> maxAge<span class="token operator">:</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>  

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <p>Especifica cuanto va a durar la sesion. En este ejemplo son 30 dias.</p></div> <p>.env</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">URI</span><span class="token operator">=</span>mongodb<span class="token operator">+</span>srv<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>User_API<span class="token operator">:</span>contraseña@cluster<span class="token punctuation">.</span>xcibc<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>net<span class="token operator">/</span>dbUrl<span class="token operator">?</span>retryWrites<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>w<span class="token operator">=</span>majority
userEmail<span class="token operator">=</span><span class="token number">815</span>fddfe9d615f
userPassword<span class="token operator">=</span><span class="token number">8</span>a37d820c188a6
<span class="token constant">PATHOSTING</span><span class="token operator">=</span>
<span class="token constant">SECRETSESSION</span><span class="token operator">=</span><span class="token number">815</span>fddfe9d615f
<span class="token constant">DBNAME</span><span class="token operator">=</span>dbUrl
<span class="token constant">MODO</span><span class="token operator">=</span>production
</code></pre></div><h2 id="heroku"><a href="#heroku" class="header-anchor">#</a> Heroku</h2> <ul><li><a href="https://www.heroku.com/pricing" target="_blank" rel="noopener noreferrer">Heroku<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="en-el-sitio"><a href="#en-el-sitio" class="header-anchor">#</a> En el sitio</h3> <ol><li>Te creas una cuenta</li> <li>Creas tu primera App  (Deja todo por defecto)</li> <li>En la parte de deploy nos muestra varias formas de desplegar la aplicación. Podes elegir heroku git (tenes que instalar heroku CLI)  o github. Depende de la opcion , los siguientes pasos cambian(En este ejemplo se usara github)</li></ol> <h3 id="en-el-proyecto-5"><a href="#en-el-proyecto-5" class="header-anchor">#</a> En el proyecto</h3> <ul><li>Hacemos todo el procedimiento para ponerlo en un repositorio de github</li></ul> <p>.gitignore</p> <div class="language-gitignore extra-class"><pre class="language-gitignore"><code><span class="token entry string">.env</span>
<span class="token entry string">node_modules</span>

</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Observacion</p> <p>Heroku Lee el package.json  y las instala</p></div> <h3 id="en-el-sitio-2"><a href="#en-el-sitio-2" class="header-anchor">#</a> En el sitio</h3> <ol start="4"><li>Le damos a GitHub</li> <li>Connect To GitHub y lo autorizas.</li> <li>Buscamos el repositorio y nos conectamos</li> <li>Seleccionamos la rama que se va a hacer el deplo Y Le das a Deploy Branch</li> <li>Configuramos las variables de entorno (en el apartado de setting - config Var)</li></ol> <ul><li>En ese apartado ponemos las variables de entorno.</li> <li>Key (Nombre) -&gt; Valor</li> <li>Por cada actualizacion en el repositorio , hacemos el el deploy branch (a menos que lo configures en automatico)</li></ul> <h2 id="consejos"><a href="#consejos" class="header-anchor">#</a> Consejos</h2> <ul><li>¡Si esta undefined es porque no estas esperando el resultado de la base de dato! USA EL AWAIT</li> <li>En todas las operaciones con una BD usar el await</li> <li>Al usar el redirect comprueba en la url si te dirige hacia donde especificaste.</li> <li>Cuidado con poner dos respuestas en un bloque , que genera errores.</li> <li>En las validaciones no darle información específica  de que se equivocó al cliente por tema de seguridad:
Ejemplo: Mal: Fallo el usuario  Correcto: Fallo el Usuario o la contraseña</li> <li>JWT = SESION SIN ESTADO</li> <li>Session y  Passport(asi se trabajaba antes)  puede ser remplazado por JWT</li> <li>Flash para comunicar mensaje</li> <li>API REST = NO TRABAJAR CON SESIONES (NO GUARDAR SESIONES EN EL SERVIDOR)</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/aprendizaje/Node/token.html" class="prev">
        Token y Practica API REST
      </a></span> <span class="next"><a href="/aprendizaje/Node/apiRest.html">
        API REST 2022
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/aprendizaje/assets/js/app.9a194da8.js" defer></script><script src="/aprendizaje/assets/js/2.c431ec36.js" defer></script><script src="/aprendizaje/assets/js/43.9cdf13c3.js" defer></script>
  </body>
</html>
